diff --git a/src/hwloc/.gitignore b/src/hwloc/.gitignore
index 44b46fa..4d2bd77 100644
--- a/src/hwloc/.gitignore
+++ b/src/hwloc/.gitignore
@@ -88,8 +88,10 @@ test-suite.log
 /tests/hwloc/hwloc_bitmap_first_last_weight
 /tests/hwloc/hwloc_bitmap_singlify
 /tests/hwloc/hwloc_type_depth
+/tests/hwloc/hwloc_type_sscanf
 /tests/hwloc/hwloc_bind
 /tests/hwloc/hwloc_get_last_cpu_location
+/tests/hwloc/hwloc_get_area_memlocation
 /tests/hwloc/hwloc_object_userdata
 /tests/hwloc/hwloc_synthetic
 /tests/hwloc/hwloc_custom
@@ -100,9 +102,11 @@ test-suite.log
 /tests/hwloc/hwloc_groups
 /tests/hwloc/hwloc_groups2
 /tests/hwloc/hwloc_insert_misc
+/tests/hwloc/hwloc_topology_abi
 /tests/hwloc/hwloc_topology_diff
 /tests/hwloc/hwloc_topology_dup
 /tests/hwloc/hwloc_topology_restrict
+/tests/hwloc/shmem
 /tests/hwloc/hwloc_obj_infos
 /tests/hwloc/hwloc_iodevs
 /tests/hwloc/xmlbuffer
@@ -209,3 +213,5 @@ test-suite.log
 /tests/netloc/data/scotch/scotch_get_arch
 
 /contrib/systemd/hwloc-dump-hwdata.service
+/contrib/misc/hwloc-tweak-osindex
+/contrib/windows/test-windows-version.sh
diff --git a/src/hwloc/Makefile.am b/src/hwloc/Makefile.am
index 25fa1e5..5b65d92 100644
--- a/src/hwloc/Makefile.am
+++ b/src/hwloc/Makefile.am
@@ -32,6 +32,7 @@ endif
 # distribution tarball if we're building in embedded mode.
 DIST_SUBDIRS = $(SUBDIRS)
 if HWLOC_BUILD_STANDALONE
+DIST_SUBDIRS += contrib/windows
 if !BUILD_NETLOC
 DIST_SUBDIRS += netloc
 endif
diff --git a/src/hwloc/NEWS b/src/hwloc/NEWS
index ff503d8..5057473 100644
--- a/src/hwloc/NEWS
+++ b/src/hwloc/NEWS
@@ -17,6 +17,28 @@ bug fixes (and other actions) for each version of hwloc since version
 in v0.9.1).
 
 
+Version 2.0.3 (also included in 1.11.12 when appropriate)
+-------------
+* Fix build on Cygwin, thanks to Marco Atzeri for the patches.
+* Fix a corner case of hwloc_topology_restrict() where children would
+  become out-of-order.
+* Fix the return length of export_xmlbuffer() functions to always
+  include the ending \0.
+* Fix lstopo --children-order argument parsing.
+
+
+Version 2.0.2 (also included in 1.11.11 when appropriate)
+-------------
+* Add support for Hygon Dhyana processors in the x86 backend,
+  thanks to Pu Wen for the patch.
+* Fix symbol renaming to also rename internal components,
+  thanks to Evan Ramos for the patch.
+* Fix build on HP-UX, thanks to Richard Lloyd for reporting the issues.
+* Detect PCI link speed without being root on Linux >= 4.13.
+* Add HWLOC_VERSION* macros to the public headers,
+  thanks to Gilles Gouaillardet for the suggestion.
+
+
 Version 2.0.1 (also included in 1.11.10 when relevant)
 -------------
 * Bump the library soname to 15:0:0 to avoid conflicts with hwloc 1.11.x
@@ -153,7 +175,7 @@ Version 2.0.0
     - Add get_area_memlocation().
 * Tools
   + lstopo and hwloc-info have a new --filter option matching the new filtering API.
-  + lstopo can be given --children-layout=plain to force a basic displaying
+  + lstopo can be given --children-order=plain to force a basic displaying
     of memory and normal children together below their parent.
   + hwloc-distances was removed and replaced with lstopo --distances.
 * Misc
diff --git a/src/hwloc/VERSION b/src/hwloc/VERSION
index 56f95f0..acd752a 100644
--- a/src/hwloc/VERSION
+++ b/src/hwloc/VERSION
@@ -5,11 +5,11 @@
 # major, minor, and release are generally combined in the form
 # <major>.<minor>.<release>.  If release is zero, then it is omitted.
 
-# Please update HWLOC_VERSION in contrib/windows/private_config.h too.
+# Please update HWLOC_VERSION* in contrib/windows/hwloc_config.h too.
 
 major=2
 minor=0
-release=1
+release=3
 
 # greek is used for alpha or beta release tags.  If it is non-empty,
 # it will be appended to the version number.  It does not have to be
@@ -41,7 +41,7 @@ snapshot_version=${major}.${minor}.${release}${greek}-git
 # 2. Version numbers are described in the Libtool current:revision:age
 # format.
 
-libhwloc_so_version=15:0:0
+libhwloc_so_version=15:2:0
 libnetloc_so_version=0:0:0
 
 # Please also update the <TargetName> lines in contrib/windows/libhwloc.vcxproj
diff --git a/src/hwloc/config/hwloc.m4 b/src/hwloc/config/hwloc.m4
index 63bf11d..8588d57 100644
--- a/src/hwloc/config/hwloc.m4
+++ b/src/hwloc/config/hwloc.m4
@@ -85,12 +85,22 @@ EOF])
     if test "$?" != "0"; then
         AC_MSG_ERROR([Cannot continue])
     fi
-    HWLOC_RELEASE_DATE="`$HWLOC_top_srcdir/config/hwloc_get_version.sh $HWLOC_top_srcdir/VERSION --release-date`"
+    AC_MSG_RESULT([$HWLOC_VERSION])
     AC_SUBST(HWLOC_VERSION)
     AC_DEFINE_UNQUOTED([HWLOC_VERSION], ["$HWLOC_VERSION"],
                        [The library version, always available, even in embedded mode, contrary to VERSION])
+
+    HWLOC_VERSION_MAJOR="`$HWLOC_top_srcdir/config/hwloc_get_version.sh $HWLOC_top_srcdir/VERSION --major`"
+    AC_DEFINE_UNQUOTED([HWLOC_VERSION_MAJOR], [$HWLOC_VERSION_MAJOR], [The library version major number])
+    HWLOC_VERSION_MINOR="`$HWLOC_top_srcdir/config/hwloc_get_version.sh $HWLOC_top_srcdir/VERSION --minor`"
+    AC_DEFINE_UNQUOTED([HWLOC_VERSION_MINOR], [$HWLOC_VERSION_MINOR], [The library version minor number])
+    HWLOC_VERSION_RELEASE="`$HWLOC_top_srcdir/config/hwloc_get_version.sh $HWLOC_top_srcdir/VERSION --release`"
+    AC_DEFINE_UNQUOTED([HWLOC_VERSION_RELEASE], [$HWLOC_VERSION_RELEASE], [The library version release number])
+    HWLOC_VERSION_GREEK="`$HWLOC_top_srcdir/config/hwloc_get_version.sh $HWLOC_top_srcdir/VERSION --greek`"
+    AC_DEFINE_UNQUOTED([HWLOC_VERSION_GREEK], ["$HWLOC_VERSION_GREEK"], [The library version optional greek suffix string])
+
+    HWLOC_RELEASE_DATE="`$HWLOC_top_srcdir/config/hwloc_get_version.sh $HWLOC_top_srcdir/VERSION --release-date`"
     AC_SUBST(HWLOC_RELEASE_DATE)
-    AC_MSG_RESULT([$HWLOC_VERSION])
 
     # Debug mode?
     AC_MSG_CHECKING([if want hwloc maintainer support])
@@ -376,6 +386,11 @@ EOF])
     AC_CHECK_HEADERS([strings.h])
     AC_CHECK_HEADERS([ctype.h])
 
+    AC_CHECK_FUNCS([strcasecmp], [
+      _HWLOC_CHECK_DECL([strcasecmp], [
+	AC_DEFINE([HWLOC_HAVE_DECL_STRCASECMP], [1], [Define to 1 if function `strcasecmp' is declared by system headers])
+      ])
+    ])
     AC_CHECK_FUNCS([strncasecmp], [
       _HWLOC_CHECK_DECL([strncasecmp], [
 	AC_DEFINE([HWLOC_HAVE_DECL_STRNCASECMP], [1], [Define to 1 if function `strncasecmp' is declared by system headers])
@@ -434,8 +449,15 @@ EOF])
 
     AC_CHECK_DECLS([fabsf], [
       AC_CHECK_LIB([m], [fabsf],
-                   [HWLOC_LIBS="-lm $HWLOC_LIBS"])
+                   [need_libm=yes])
     ], [], [[#include <math.h>]])
+    AC_CHECK_DECLS([modff], [
+      AC_CHECK_LIB([m], [modff],
+                   [need_libm=yes])
+    ], [], [[#include <math.h>]])
+    if test x$need_libm = xyes; then
+      HWLOC_LIBS="-lm $HWLOC_LIBS"
+    fi
 
     AC_CHECK_HEADERS([picl.h], [
       AC_CHECK_LIB([picl], [picl_initialize],
@@ -474,7 +496,6 @@ EOF])
     # Needed for Windows in private/misc.h
     AC_CHECK_TYPES([ssize_t])
     AC_CHECK_DECLS([snprintf], [], [], [AC_INCLUDES_DEFAULT])
-    AC_CHECK_DECLS([strcasecmp], [], [], [AC_INCLUDES_DEFAULT])
     # strdup and putenv are declared in windows headers but marked deprecated
     AC_CHECK_DECLS([_strdup], [], [], [AC_INCLUDES_DEFAULT])
     AC_CHECK_DECLS([_putenv], [], [], [AC_INCLUDES_DEFAULT])
@@ -1169,11 +1190,13 @@ return clGetDeviceIDs(0, 0, 0, NULL, NULL);
     AS_IF([test "$hwloc_mode" = "embedded"],
           [HWLOC_EMBEDDED_CFLAGS=$HWLOC_CFLAGS
            HWLOC_EMBEDDED_CPPFLAGS=$HWLOC_CPPFLAGS
+           HWLOC_EMBEDDED_LDFLAGS=$HWLOC_LDFLAGS
            HWLOC_EMBEDDED_LDADD='$(HWLOC_top_builddir)/hwloc/libhwloc_embedded.la'
            HWLOC_EMBEDDED_LIBS=$HWLOC_LIBS
            HWLOC_LIBS=])
     AC_SUBST(HWLOC_EMBEDDED_CFLAGS)
     AC_SUBST(HWLOC_EMBEDDED_CPPFLAGS)
+    AC_SUBST(HWLOC_EMBEDDED_LDFLAGS)
     AC_SUBST(HWLOC_EMBEDDED_LDADD)
     AC_SUBST(HWLOC_EMBEDDED_LIBS)
 
@@ -1275,32 +1298,6 @@ AC_DEFUN([HWLOC_DO_AM_CONDITIONALS],[
 
 #-----------------------------------------------------------------------
 
-AC_DEFUN([_HWLOC_CHECK_DIFF_U], [
-  AC_MSG_CHECKING([whether diff accepts -u])
-  if diff -u /dev/null /dev/null 2> /dev/null
-  then
-    HWLOC_DIFF_U="-u"
-  else
-    HWLOC_DIFF_U=""
-  fi
-  AC_SUBST([HWLOC_DIFF_U])
-  AC_MSG_RESULT([$HWLOC_DIFF_U])
-])
-
-AC_DEFUN([_HWLOC_CHECK_DIFF_W], [
-  AC_MSG_CHECKING([whether diff accepts -w])
-  if diff -w /dev/null /dev/null 2> /dev/null
-  then
-    HWLOC_DIFF_W="-w"
-  else
-    HWLOC_DIFF_W=""
-  fi
-  AC_SUBST([HWLOC_DIFF_W])
-  AC_MSG_RESULT([$HWLOC_DIFF_W])
-])
-
-#-----------------------------------------------------------------------
-
 dnl HWLOC_CHECK_DECL
 dnl
 dnl Check that the declaration of the given function has a complete prototype
diff --git a/src/hwloc/config/hwloc_components.m4 b/src/hwloc/config/hwloc_components.m4
index 7d5c1fa..620cc4d 100644
--- a/src/hwloc/config/hwloc_components.m4
+++ b/src/hwloc/config/hwloc_components.m4
@@ -1,4 +1,4 @@
-# Copyright © 2012 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 
 
@@ -50,10 +50,8 @@ done
 # $2 = list of component names
 #
 AC_DEFUN([HWLOC_LIST_STATIC_COMPONENTS], [
-for comp in [$2]; do
-  echo "HWLOC_DECLSPEC extern const struct hwloc_component hwloc_${comp}_component;" >>[$1]
-done
 cat <<EOF >>[$1]
+#include <private/internal-components.h>
 static const struct hwloc_component * hwloc_static_components[[]] = {
 EOF
 for comp in [$2]; do
diff --git a/src/hwloc/config/hwloc_get_version.sh b/src/hwloc/config/hwloc_get_version.sh
index 74bca53..4bc4f29 100755
--- a/src/hwloc/config/hwloc_get_version.sh
+++ b/src/hwloc/config/hwloc_get_version.sh
@@ -11,7 +11,7 @@
 # Copyright © 2004-2005 The Regents of the University of California.
 #                         All rights reserved.
 # Copyright © 2008-2014 Cisco Systems, Inc.  All rights reserved.
-# Copyright © 2014 Inria.  All rights reserved.
+# Copyright © 2014-2018 Inria.  All rights reserved.
 # $COPYRIGHT$
 #
 # Additional copyrights may follow
@@ -70,6 +70,18 @@ case "$option" in
     --version)
 	echo $HWLOC_VERSION
 	;;
+    --major)
+        echo $HWLOC_MAJOR_VERSION
+        ;;
+    --minor)
+        echo $HWLOC_MINOR_VERSION
+        ;;
+    --release)
+        echo $HWLOC_RELEASE_VERSION
+        ;;
+    --greek)
+        echo $HWLOC_GREEK_VERSION
+        ;;
     --release-date)
         echo $HWLOC_RELEASE_DATE
         ;;
@@ -82,7 +94,11 @@ $0 <srcfile> <option>
 
 <srcfile> - Text version file
 <option>  - One of:
-    --version      - Show version number
+    --version      - Show full version number
+    --major        - Major version number
+    --minor        - Minor version number
+    --release      - Release version number
+    --greek        - Greek (alpha, beta, etc) version suffix
     --release-date - Show the release date
     --snapshot     - Show whether this is a snapshot release or not
     --help         - This message
diff --git a/src/hwloc/config/hwloc_internal.m4 b/src/hwloc/config/hwloc_internal.m4
index d706538..71ff2a7 100644
--- a/src/hwloc/config/hwloc_internal.m4
+++ b/src/hwloc/config/hwloc_internal.m4
@@ -197,7 +197,7 @@ EOF
     AC_MSG_CHECKING([whether to enable "picky" compiler mode])
     hwloc_want_picky=0
     AS_IF([test "$hwloc_c_vendor" = "gnu"],
-          [AS_IF([test -d "$srcdir/.hg" -o -d "$srcdir/.git"],
+          [AS_IF([test -e "$srcdir/.git"],
                  [hwloc_want_picky=1])])
     if test "$enable_picky" = "yes"; then
         if test "$GCC" = "yes"; then
@@ -420,6 +420,8 @@ int foo(void) {
         hwloc_config_prefix[utils/netloc/infiniband/netloc_ib_gather_raw]
         hwloc_config_prefix[contrib/systemd/Makefile]
         hwloc_config_prefix[contrib/misc/Makefile]
+        hwloc_config_prefix[contrib/windows/Makefile]
+        hwloc_config_prefix[contrib/windows/test-windows-version.sh]
         hwloc_config_prefix[tests/netloc/Makefile]
         hwloc_config_prefix[tests/netloc/tests.sh]
     )
@@ -443,6 +445,7 @@ chmod +x ]hwloc_config_prefix[tests/hwloc/linux/test-topology.sh \
       ]hwloc_config_prefix[utils/hwloc/test-hwloc-dump-hwdata/test-hwloc-dump-hwdata.sh \
       ]hwloc_config_prefix[utils/lstopo/test-lstopo.sh \
       ]hwloc_config_prefix[utils/netloc/infiniband/netloc_ib_gather_raw \
+      ]hwloc_config_prefix[contrib/windows/test-windows-version.sh \
       ]hwloc_config_prefix[tests/netloc/tests.sh])
 
     # These links are only needed in standalone mode.  It would
@@ -468,3 +471,38 @@ chmod +x ]hwloc_config_prefix[tests/hwloc/linux/test-topology.sh \
 	hwloc_config_prefix[tests/hwloc/ports/lstopo-windows.c]:hwloc_config_prefix[utils/lstopo/lstopo-windows.c])
     ])
 ])dnl
+
+#-----------------------------------------------------------------------
+
+AC_DEFUN([_HWLOC_PROG_DIFF], [
+  AC_ARG_VAR(DIFF, [diff tool])
+  AC_PATH_PROG([DIFF], [diff])
+])
+
+AC_DEFUN([_HWLOC_CHECK_DIFF_U], [
+  AC_REQUIRE([_HWLOC_PROG_DIFF])
+  AC_MSG_CHECKING([whether diff accepts -u])
+  if $DIFF -u /dev/null /dev/null 2> /dev/null
+  then
+    AC_MSG_RESULT([yes])
+    HWLOC_DIFF_U="-u"
+  else
+    AC_MSG_RESULT([no])
+    HWLOC_DIFF_U=""
+  fi
+  AC_SUBST([HWLOC_DIFF_U])
+])
+
+AC_DEFUN([_HWLOC_CHECK_DIFF_W], [
+  AC_REQUIRE([_HWLOC_PROG_DIFF])
+  AC_MSG_CHECKING([whether diff accepts -w])
+  if $DIFF -w /dev/null /dev/null 2> /dev/null
+  then
+    AC_MSG_RESULT([yes])
+    HWLOC_DIFF_W="-w"
+  else
+    AC_MSG_RESULT([no])
+    HWLOC_DIFF_W=""
+  fi
+  AC_SUBST([HWLOC_DIFF_W])
+])
diff --git a/src/hwloc/configure.ac b/src/hwloc/configure.ac
index 515101e..a0521d2 100644
--- a/src/hwloc/configure.ac
+++ b/src/hwloc/configure.ac
@@ -230,6 +230,8 @@ AS_IF([test "$netloc_happy" = "yes"], [
   AS_IF([test "$scotch_found_headers" = "yes"], [netlocscotch_status=with])
   netloc_status="yes ($netlocscotch_status scotch)"
 ])
+hwloc_cairo_status=$hwloc_cairo_happy
+AS_IF([test "$enable_embedded_mode" = "yes"], [hwloc_cairo_status="no (disabled in embedded mode)"])
 
 # Prepare the I/O summary
 hwloc_probeio_list=
@@ -254,7 +256,7 @@ cat <<EOF
 Hwloc optional build support status (more details can be found above):
 
 Probe / display I/O devices:$hwloc_probeio_list
-Graphical output (Cairo):    $hwloc_cairo_happy
+Graphical output (Cairo):    $hwloc_cairo_status
 XML input / output:          $hwloc_xml_status
 Netloc functionality:        $netloc_status
 EOF
diff --git a/src/hwloc/contrib/ci.inria.fr/Jenkinsfile-basic b/src/hwloc/contrib/ci.inria.fr/Jenkinsfile-basic
new file mode 100644
index 0000000..d65d339
--- /dev/null
+++ b/src/hwloc/contrib/ci.inria.fr/Jenkinsfile-basic
@@ -0,0 +1,123 @@
+#!groovy
+
+// This "basic pipeline" runs quick tests:
+// * builds a tarball as usual
+// * uses that tarball for
+//   + running Unix checks
+//   + building with MSVC on Windows
+//
+// The GIT checkout must use the remote branch name as the checkout local
+// branch name so that tarball names contain the branch name.
+// In "Additional Behaviours", enable "Checkout to specific local branch"
+// and leave "Branch name" empty.
+// Not needed for multi-branch pipelines which already BRANCH_NAME in the environment.
+
+def gitBranch = ""
+def tarballgz
+def tarballbz2
+def statusHasChanged = false
+
+pipeline {
+	agent none
+
+	stages {
+		stage('Tarball') {
+			steps {
+				node('autotools') {
+					checkout scm
+					script {
+						gitBranch = sh (script: 'if test "$BRANCH_NAME"; then echo $BRANCH_NAME; else git branch | cut -c3-; fi', returnStdout: true).trim()
+					}
+					sh 'contrib/ci.inria.fr/job-0-tarball.sh '+gitBranch
+					script {
+					       tarballgz = sh (script: 'ls *.gz', returnStdout: true).trim()
+					       tarballbz2 = sh (script: 'ls *.bz2', returnStdout: true).trim()
+					}
+					stash includes: tarballgz, name: 'tarballgz'
+					// Stash those scripts because they are not in make dist
+					dir('contrib/ci.inria.fr') {
+						stash includes: "job-1-check.sh", name: 'script-unix-check'
+						stash includes: "job-1-visualstudio.bat", name: 'script-msvc'
+					}
+					archiveArtifacts artifacts: tarballgz+","+tarballbz2+",doc/doxygen-doc/hwloc-a4.pdf", fingerprint: true, onlyIfSuccessful: true
+					deleteDir()
+				}
+			}
+		}
+		stage('Check') {
+			steps {
+				script {
+					listOfNodeNames = []
+					if (env.NO_UNIX != 'true') {
+						labelToSelect = 'unix'
+						listOfNodeNames = jenkins.model.Jenkins.instance.nodes.collect {
+						  node -> node.getLabelString().contains(labelToSelect) ? node.name : null
+						}
+						listOfNodeNames.removeAll(Collections.singleton(null))
+					}
+					if (env.NO_MSVC != 'true') {
+						listOfNodeNames.push('VisualStudio')
+					}
+
+					def p = listOfNodeNames.collectEntries {
+					[ (it): {
+						if (it != 'VisualStudio') {
+							node(it) {
+								dir('check-unix') {
+									unstash 'tarballgz'
+									unstash 'script-unix-check'
+									sh 'chmod 755 job-1-check.sh && ./job-1-check.sh '+tarballgz
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						} else {
+							node('msvc') {
+								dir('check-msvc') {
+									unstash 'tarballgz'
+									unstash 'script-msvc'
+									bat 'job-1-visualstudio.bat '+tarballgz
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						}
+					}]}
+					parallel p;
+				}
+			}
+		}
+	}
+
+	post {
+		// hooks are called in order: always, changed, aborted, failure, success, unstable
+		changed {
+			echo "Build status has changed."
+			script {
+				statusHasChanged = true
+			}
+		}
+		success {
+			echo "Build success."
+			// email when changed to success
+			script {
+				if (statusHasChanged) {
+					emailext(body: '${DEFAULT_CONTENT}',
+						 subject: '${DEFAULT_SUBJECT}',
+						 replyTo: '$DEFAULT_REPLYTO',
+						 to: '$DEFAULT_RECIPIENTS',
+						 recipientProviders: [[$class: 'CulpritsRecipientProvider'],[$class: 'RequesterRecipientProvider']])
+				}
+			}
+		}
+		failure {
+			echo "Build failure."
+			// always email on failure
+			emailext(body: '${DEFAULT_CONTENT}',
+				 subject: '${DEFAULT_SUBJECT}',
+				 replyTo: '$DEFAULT_REPLYTO',
+				 to: '$DEFAULT_RECIPIENTS',
+				 recipientProviders: [[$class: 'CulpritsRecipientProvider'],[$class: 'RequesterRecipientProvider']])
+		}
+        }
+}
diff --git a/src/hwloc/contrib/ci.inria.fr/Jenkinsfile-extended b/src/hwloc/contrib/ci.inria.fr/Jenkinsfile-extended
new file mode 100644
index 0000000..baf5ddb
--- /dev/null
+++ b/src/hwloc/contrib/ci.inria.fr/Jenkinsfile-extended
@@ -0,0 +1,175 @@
+#!groovy
+
+// This "extended pipeline" runs longer tests:
+// * builds a tarball as usual
+// * uses that tarball for
+//   + running Unix Debug checks
+//   + building MinGW Windows zipballs
+//   + running Embedded checks
+//   + running Sonarscanner analysis
+//
+// The GIT checkout must use the remote branch name as the checkout local
+// branch name so that tarball names contain the branch name.
+// In "Additional Behaviours", enable "Checkout to specific local branch"
+// and leave "Branch name" empty.
+// Not needed for multi-branch pipelines which already BRANCH_NAME in the environment.
+
+def gitRepoURL = ""
+def gitBranch = ""
+def tarballgz
+def tarballbz2
+def statusHasChanged = false
+
+pipeline {
+        agent none
+
+	// Trigger the build
+	triggers {
+		// Poll GitHub explicitly on per night, in case webhooks aren't used
+		pollSCM('0 4 * * *')
+	}
+
+        stages {
+		stage('Tarball') {
+			steps {
+				node('autotools') {
+                                        checkout scm
+					script {
+						gitRepoURL = sh (script: 'git config --get remote.origin.url', returnStdout: true).trim()
+						gitBranch = sh (script: 'if test "$BRANCH_NAME"; then echo $BRANCH_NAME; else git branch | cut -c3-; fi', returnStdout: true).trim()
+					}
+                                        sh 'contrib/ci.inria.fr/job-0-tarball.sh '+gitBranch
+                                        script {
+                                                tarballgz = sh (script: 'ls *.gz', returnStdout: true).trim()
+                                                tarballbz2 = sh (script: 'ls *.bz2', returnStdout: true).trim()
+                                        }
+                                        stash includes: tarballgz, name: 'tarballgz'
+                                        dir('contrib/ci.inria.fr') {
+						stash includes: "job-3-debug.sh", name: 'script-unix-debug'
+						stash includes: "job-3-embedded.sh", name: 'script-embedded'
+						stash includes: "job-3-sonarscanner.sh", name: 'script-sonarscanner'
+						stash includes: "job-3-mingw.*", name: 'scripts-mingw'
+						stash includes: "job-3-cygwin.*", name: 'scripts-cygwin'
+					}
+					archiveArtifacts artifacts: tarballgz+","+tarballbz2+",doc/doxygen-doc/hwloc-a4.pdf", fingerprint: true, onlyIfSuccessful: true
+					deleteDir()
+				}
+			}
+		}
+		stage('Check') {
+			steps {
+				script {
+					listOfNodeNames = []
+					if (env.NO_UNIX != 'true') {
+						labelToSelect = 'unix'
+						listOfNodeNames = jenkins.model.Jenkins.instance.nodes.collect {
+						  node -> node.getLabelString().contains(labelToSelect) ? node.name : null
+						}
+						listOfNodeNames.removeAll(Collections.singleton(null))
+					}
+					if (env.NO_MINGW != 'true') {
+						listOfNodeNames.push('MinGW')
+					}
+					if (env.NO_SONAR != 'true') {
+						listOfNodeNames.push('SonarQube Scanner')
+					}
+					if (env.NO_EMBEDDED != 'true') {
+						listOfNodeNames.push('Embedded')
+					}
+					if (env.NO_CYGWIN != 'true') {
+						listOfNodeNames.push('cygwin')
+					}
+
+					def p = listOfNodeNames.collectEntries {
+					[ (it): {
+						if (it == 'MinGW') {
+							node('mingw') {
+								dir('check-mingw') {
+									unstash 'tarballgz'
+									unstash 'scripts-mingw'
+									bat 'job-3-mingw.bat '+tarballgz
+									archiveArtifacts artifacts: "*.zip", fingerprint: true, onlyIfSuccessful: true
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						} else if (it == 'cygwin') {
+							node('cygwin') {
+								dir('check-cygwin') {
+									unstash 'tarballgz'
+									unstash 'scripts-cygwin'
+									bat './job-3-cygwin.bat '+tarballgz
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						} else if (it == 'SonarQube Scanner') {
+							node('sonarscanner') {
+								dir('check-sonarscanner') {
+									unstash 'tarballgz'
+									unstash 'script-sonarscanner'
+									sh 'chmod 755 job-3-sonarscanner.sh && ./job-3-sonarscanner.sh '+gitRepoURL+' '+gitBranch+' '+tarballgz
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						} else if (it == 'Embedded') {
+							node('autotools') {
+								dir('check-embedded') {
+									unstash 'tarballgz'
+									unstash 'script-embedded'
+									sh 'chmod 755 job-3-embedded.sh && ./job-3-embedded.sh '+tarballgz
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						} else {
+							node(it) {
+								dir('check-unix-debug') {
+									unstash 'tarballgz'
+									unstash 'script-unix-debug'
+									sh 'chmod 755 job-3-debug.sh && ./job-3-debug.sh '+tarballgz
+									if (env.KEEP_WORKING_DIRECTORY != 'true')
+										deleteDir()
+								}
+							}
+						}
+					}]}
+					parallel p;
+				}
+			}
+		}
+	}
+
+	post {
+		// hooks are called in order: always, changed, aborted, failure, success, unstable
+		changed {
+			echo "Build status has changed."
+			script {
+				statusHasChanged = true
+			}
+		}
+		success {
+			echo "Build success."
+			// email when changed to success
+			script {
+				if (statusHasChanged) {
+					emailext(body: '${DEFAULT_CONTENT}',
+						 subject: '${DEFAULT_SUBJECT}',
+						 replyTo: '$DEFAULT_REPLYTO',
+						 to: '$DEFAULT_RECIPIENTS',
+						 recipientProviders: [[$class: 'CulpritsRecipientProvider'],[$class: 'RequesterRecipientProvider']])
+				}
+			}
+		}
+		failure {
+			echo "Build failure."
+			// always email on failure
+			emailext(body: '${DEFAULT_CONTENT}',
+				 subject: '${DEFAULT_SUBJECT}',
+				 replyTo: '$DEFAULT_REPLYTO',
+				 to: '$DEFAULT_RECIPIENTS',
+				 recipientProviders: [[$class: 'CulpritsRecipientProvider'],[$class: 'RequesterRecipientProvider']])
+		}
+	}
+}
diff --git a/src/hwloc/contrib/ci.inria.fr/job-0-tarball.sh b/src/hwloc/contrib/ci.inria.fr/job-0-tarball.sh
index 6bb3b01..dcefd24 100755
--- a/src/hwloc/contrib/ci.inria.fr/job-0-tarball.sh
+++ b/src/hwloc/contrib/ci.inria.fr/job-0-tarball.sh
@@ -1,21 +1,34 @@
 #!/bin/sh
 #
-# Copyright © 2012-2017 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
+echo "############################"
+echo "Running on:"
+uname -a
+echo "############################"
+
 set -e
 set -x
 
+branch="$1"
+if test -z "$branch"; then
+  echo "Need branch name as argument."
+  exit 1
+fi
+
+echo "Got GIT branch name $branch"
+
 # environment variables
 test -f $HOME/.ciprofile && . $HOME/.ciprofile
 
 # keep branch-name before the first - (e.g. v2.0-beta becomes v2.0)
 # and look for the corresponding autotools
-branch=$( echo $GIT_BRANCH | sed -r -e 's@^.*/([^/]+)$@\1@' -e 's/-.*//' )
-if test -d $HOME/local/hwloc-$branch ; then
-  export PATH=$HOME/local/hwloc-${branch}/bin:$PATH
-  echo using specific $HOME/local/hwloc-$branch
+basebranch=$( echo $branch | sed -r -e 's@^.*/([^/]+)$@\1@' -e 's/-.*//' )
+if test -d $HOME/local/hwloc-$basebranch ; then
+  export PATH=$HOME/local/hwloc-${basebranch}/bin:$PATH
+  echo using specific $HOME/local/hwloc-$basebranch
 else
   export PATH=$HOME/local/hwloc-master/bin:$PATH
   echo using generic $HOME/local/hwloc-master
@@ -40,3 +53,8 @@ sed	-e 's/^snapshot_version=.*/snapshot_version='$snapshot/ \
 ./configure
 make
 make distcheck
+
+# this test requires bash and grep -P, only run it in the main job
+make check -C contrib/windows
+
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-1-check.sh b/src/hwloc/contrib/ci.inria.fr/job-1-check.sh
index 01469b2..45d4385 100644
--- a/src/hwloc/contrib/ci.inria.fr/job-1-check.sh
+++ b/src/hwloc/contrib/ci.inria.fr/job-1-check.sh
@@ -1,37 +1,29 @@
 #!/bin/sh
 #
-# Copyright © 2012-2017 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
+echo "############################"
+echo "Running on:"
+uname -a
+echo "Tarball: $1"
+echo "############################"
+
 set -e
 set -x
 
 # environment variables
 test -f $HOME/.ciprofile && . $HOME/.ciprofile
 
-# remove everything but the last 10 builds
-ls | grep -v ^hwloc- | grep -v ^job- | xargs rm -rf || true
-ls -td hwloc-* | tail -n +11 | xargs chmod u+w -R || true
-ls -td hwloc-* | tail -n +11 | xargs rm -rf || true
-
-# find the tarball, extract it
-tarball=$(ls -tr hwloc-*.tar.gz | grep -v build.tar.gz | tail -1)
+# extract the tarball
+tarball="$1"
 basename=$(basename $tarball .tar.gz)
 test -d $basename && chmod -R u+rwX $basename && rm -rf $basename
 tar xfz $tarball
 rm $tarball
 cd $basename
 
-# make the script work on old branches so that we can use the same script
-# from upstream git master for testing v1.11-* and master-* branches
-WRAPPER=tests/hwloc/wrapper.sh
-RENAMEDIR=tests/hwloc/rename
-if test -f tests/wrapper.sh.in; then
-  WRAPPER=tests/wrapper.sh
-  RENAMEDIR=tests/rename
-fi
-
 # ignore clock problems
 touch configure
 
@@ -50,15 +42,11 @@ cd build-plugins
 $PWD/../configure --enable-plugins
 make
 make check
-$WRAPPER utils/lstopo/lstopo-no-graphics -v
-$WRAPPER utils/hwloc/hwloc-info --support
+tests/hwloc/wrapper.sh utils/lstopo/lstopo-no-graphics -v
+tests/hwloc/wrapper.sh utils/hwloc/hwloc-info --support
 cd ..
 
 # check renaming
-(cd build/$RENAMEDIR && make check)
+(cd build/tests/hwloc/rename && make check)
 
-# cleanup
-rm -rf doc build/doc build-plugins/doc
-cd ..
-tar cfz ${basename}.build.tar.gz $basename
-rm -rf $basename
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-1-visualstudio.bat b/src/hwloc/contrib/ci.inria.fr/job-1-visualstudio.bat
new file mode 100644
index 0000000..7f97e9f
--- /dev/null
+++ b/src/hwloc/contrib/ci.inria.fr/job-1-visualstudio.bat
@@ -0,0 +1,25 @@
+REM
+REM  Copyright © 2012-2018 Inria.  All rights reserved.
+REM  See COPYING in top-level directory.
+REM
+
+call %JENKINS_CONFIG_DIR%\\ciprofile.bat
+
+set TARBALL=%1
+
+sh -c "tar xfz %TARBALL%"
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+cd %TARBALL:~0,-7%\contrib\windows
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+%MSBUILD_PATH%\MSBuild hwloc.sln /p:Configuration=Release /p:Platform=x64
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+x64\Release\lstopo-no-graphics.exe
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+x64\Release\hwloc-info.exe --support
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+exit /b 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-cygwin.bat b/src/hwloc/contrib/ci.inria.fr/job-3-cygwin.bat
new file mode 100644
index 0000000..0d6a4e6
--- /dev/null
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-cygwin.bat
@@ -0,0 +1,12 @@
+REM
+REM  Copyright © 2012-2018 Inria.  All rights reserved.
+REM  See COPYING in top-level directory.
+REM
+
+call %JENKINS_CONFIG_DIR%\\ciprofile.bat
+
+sh -c "chmod 755 job-3-cygwin.sh"
+sh -c "./job-3-cygwin.sh %1"
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+exit /b 0
\ No newline at end of file
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-cygwin.sh b/src/hwloc/contrib/ci.inria.fr/job-3-cygwin.sh
new file mode 100644
index 0000000..952397b
--- /dev/null
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-cygwin.sh
@@ -0,0 +1,36 @@
+#!/bin/sh
+#
+# Copyright © 2012-2018 Inria.  All rights reserved.
+# See COPYING in top-level directory.
+#
+
+echo "############################"
+echo "Running on:"
+uname -a
+echo "Tarball: $1"
+echo "############################"
+
+set -e
+set -x
+
+# extract the tarball
+tarball="$1"
+basename=$(basename $tarball .tar.gz)
+test -d $basename && chmod -R u+rwX $basename && rm -rf $basename
+tar xfz $tarball
+rm $tarball
+cd $basename
+
+# ignore clock problems
+touch configure
+
+# build without plugins, with relative VPATH
+mkdir build
+cd build
+../configure
+make
+make check
+utils/lstopo/lstopo-no-graphics -v
+cd ..
+
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-debug.sh b/src/hwloc/contrib/ci.inria.fr/job-3-debug.sh
index ce248ba..5e4f1e8 100755
--- a/src/hwloc/contrib/ci.inria.fr/job-3-debug.sh
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-debug.sh
@@ -1,22 +1,23 @@
 #!/bin/sh
 #
-# Copyright © 2012-2015 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
+echo "############################"
+echo "Running on:"
+uname -a
+echo "Tarball: $1"
+echo "############################"
+
 set -e
 set -x
 
 # environment variables
 test -f $HOME/.ciprofile && . $HOME/.ciprofile
 
-# remove everything but the last 10 builds
-ls | grep -v ^hwloc- | grep -v ^job- | xargs rm -rf || true
-ls -td hwloc-* | tail -n +11 | xargs chmod u+w -R || true
-ls -td hwloc-* | tail -n +11 | xargs rm -rf || true
-
-# find the tarball, extract it
-tarball=$(ls -tr hwloc-*.tar.gz | grep -v build.tar.gz | tail -1)
+# extract the tarball
+tarball="$1"
 basename=$(basename $tarball .tar.gz)
 test -d $basename && chmod -R u+rwX $basename && rm -rf $basename
 tar xfz $tarball
@@ -35,8 +36,4 @@ make check
 tests/hwloc/wrapper.sh utils/lstopo/lstopo-no-graphics
 cd ..
 
-# cleanup
-rm -rf doc build-plugins-debug/doc
-cd ..
-tar cfz ${basename}.build.tar.gz $basename
-rm -rf $basename
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-embedded.sh b/src/hwloc/contrib/ci.inria.fr/job-3-embedded.sh
index 23d7fd6..8d7e066 100755
--- a/src/hwloc/contrib/ci.inria.fr/job-3-embedded.sh
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-embedded.sh
@@ -1,22 +1,23 @@
 #!/bin/sh
 #
-# Copyright © 2012-2015 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
+echo "############################"
+echo "Running on:"
+uname -a
+echo "Tarball: $1"
+echo "############################"
+
 set -e
 set -x
 
 # environment variables
 test -f $HOME/.ciprofile && . $HOME/.ciprofile
 
-# remove everything but the last 10 builds
-ls | grep -v ^hwloc- | grep -v ^job- | xargs rm -rf || true
-ls -td hwloc-* | tail -n +11 | xargs chmod u+w -R || true
-ls -td hwloc-* | tail -n +11 | xargs rm -rf || true
-
-# find the tarball, extract it
-tarball=$(ls -tr hwloc-*.tar.gz | grep -v build.tar.gz | tail -1)
+# extract the tarball
+tarball="$1"
 basename=$(basename $tarball .tar.gz)
 test -d $basename && chmod -R u+rwX $basename && rm -rf $basename
 tar xfz $tarball
@@ -29,8 +30,4 @@ touch configure
 # embedded tests
 (cd tests/hwloc/embedded && ./run-embedded-tests.sh ../../../$tarball)
 
-# cleanup
-rm -rf doc
-cd ..
-tar cfz ${basename}.build.tar.gz $basename
-rm -rf $basename
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-mingw.bat b/src/hwloc/contrib/ci.inria.fr/job-3-mingw.bat
new file mode 100644
index 0000000..a9239b8
--- /dev/null
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-mingw.bat
@@ -0,0 +1,12 @@
+REM
+REM  Copyright © 2012-2018 Inria.  All rights reserved.
+REM  See COPYING in top-level directory.
+REM
+
+call %JENKINS_CONFIG_DIR%\\ciprofile.bat
+
+sh -c "chmod 755 job-3-mingw.sh"
+sh -c "./job-3-mingw.sh %1"
+if %errorlevel% neq 0 exit /b %errorlevel%
+
+exit /b 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-mingw.sh b/src/hwloc/contrib/ci.inria.fr/job-3-mingw.sh
index 8d1c396..5a18b68 100644
--- a/src/hwloc/contrib/ci.inria.fr/job-3-mingw.sh
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-mingw.sh
@@ -1,9 +1,15 @@
 #!/bin/sh
 #
-# Copyright © 2012-2017 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
+echo "############################"
+echo "Running on:"
+uname -a
+echo "Options: $0"
+echo "############################"
+
 set -e
 set -x
 
@@ -44,6 +50,8 @@ while test $# -gt 0; do
     echo "  --no-install  Don't install"
     echo "  --help        Show this help"
     exit 0
+  else
+    break
   fi fi fi fi fi fi fi fi fi
   shift
 done
@@ -51,14 +59,16 @@ done
 oldPWD=$PWD
 oldPATH=$PATH
 
-if test x$dotar = x1; then
-  # remove everything but the last 10 builds
-  rm -rf $(ls | grep -v ^hwloc- | grep -v ^job-) || true
-  chmod u+w -R $(ls -td hwloc-* | tail -n +11) || true
-  rm -rf $(ls -td hwloc-* | tail -n +11) || true
+# remove previous artifacts so that they don't exported again by this build
+rm -f hwloc-win*-build-*.zip || true
 
-  # find the tarball and extract it
-  tarball=$(ls -tr hwloc-*.tar.gz | tail -1)
+if test x$dotar = x1; then
+  # extract the tarball
+  tarball="$1"
+  if ! test -f "$tarball"; then
+    echo "Invalid tarball parameter."
+    exit 0
+  fi
   basename=$(basename $tarball .tar.gz)
   version=$(echo $basename | cut -d- -f2-)
   test -d $basename && chmod -R u+rwX $basename && rm -rf $basename
@@ -80,7 +90,7 @@ if test x$dobuild32 = x1; then
   cd $oldPWD
 
   # for MS 'lib' program in dolib.c
-  export PATH=$PATH:"/c/Program Files (x86)/Microsoft Visual Studio 11.0/VC/bin":"/c/Program Files (x86)/Microsoft Visual Studio 11.0/Common7/IDE"
+  export PATH=$PATH:$MSLIB_PATH
 
   mkdir ${basename}/build32 || true
   cd ${basename}/build32
@@ -128,7 +138,7 @@ if test x$dobuild64 = x1; then
   cd $oldPWD
 
   # for MS 'lib' program in dolib.c
-  export PATH=$PATH:"/c/Program Files (x86)/Microsoft Visual Studio 11.0/VC/bin":"/c/Program Files (x86)/Microsoft Visual Studio 11.0/Common7/IDE"
+  export PATH=$PATH:$MSLIB_PATH
 
   mkdir ${basename}/build64 || true
   cd ${basename}/build64
@@ -167,3 +177,5 @@ if test x$dobuild64 = x1; then
 fi
 
 PATH=$oldPATH
+
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-sonarscanner.sh b/src/hwloc/contrib/ci.inria.fr/job-3-sonarscanner.sh
index 46770d1..caa4d77 100755
--- a/src/hwloc/contrib/ci.inria.fr/job-3-sonarscanner.sh
+++ b/src/hwloc/contrib/ci.inria.fr/job-3-sonarscanner.sh
@@ -4,26 +4,47 @@
 # See COPYING in top-level directory.
 #
 
+echo "############################"
+echo "Running on:"
+uname -a
+echo "Tarball: $1"
+echo "############################"
+
 set -e
 set -x
 
-# Define the version
-if test x$1 = x; then
-  echo "Missing branch name as first argument"
+git_repo_url="$1"
+hwloc_branch="$2"
+tarball="$3"
+
+if test -z "$git_repo_url" || test -z "$hwloc_branch"; then
+  echo "Need repo URL and branch name as arguments."
   exit 1
 fi
-export hwloc_branch=$1
 
 # environment variables
 test -f $HOME/.ciprofile && . $HOME/.ciprofile
 
-# remove everything but the last 10 builds
-ls | grep -v ^hwloc- | grep -v ^job- | xargs rm -rf || true
-ls -td hwloc-* | tail -n +11 | xargs chmod u+w -R || true
-ls -td hwloc-* | tail -n +11 | xargs rm -rf || true
+# check that this is either master or vX.Y
+if test x$hwloc_branch != xmaster; then
+  if test x$(echo "x${hwloc_branch}x" | sed -r -e 's/xv[0-9]+\.[0-9]+x//') != x; then
+    echo "Sending non-master and non-stable branch output to `tmp` branch on sonarqube server."
+    hwloc_branch=tmp
+  fi
+fi
 
-# find the tarball, extract it
-tarball=$(ls -tr hwloc-*.tar.gz | grep -v build.tar.gz | tail -1)
+# check that the repo is the official one
+if test x$git_repo_url != xhttps://github.com/open-mpi/hwloc.git; then
+  if test x$FORCE_SONAR_SCANNER = xtrue; then
+    echo "Sending non-official repository output to 'tmp' branch on sonarqube server."
+    hwloc_branch=tmp
+  else
+    echo "Ignoring non-official repository."
+    exit 0
+  fi
+fi
+
+# extract the tarball
 basename=$(basename $tarball .tar.gz)
 test -d $basename && chmod -R u+rwX $basename && rm -rf $basename
 tar xfz $tarball
@@ -37,8 +58,7 @@ touch configure
 export CFLAGS="-O0 -g -fPIC --coverage -Wall -Wunused-parameter -Wundef -Wno-long-long -Wsign-compare -Wmissing-prototypes -Wstrict-prototypes -Wcomment -pedantic -fdiagnostics-show-option -fno-inline"
 export LDFLAGS="--coverage"
 ./configure
-make V=1 |tee hwloc-build.log
-
+make V=1 | tee hwloc-build.log
 # Execute unitary tests (autotest)
 make check
 
@@ -48,6 +68,14 @@ find . -path '*/.libs/*.gcda' -exec rename 's@/.libs/@/@' {} \;
 lcov --directory . --capture --output-file hwloc.lcov
 lcov_cobertura.py hwloc.lcov --output hwloc-coverage.xml
 
+# Clang/Scan-build
+make distclean
+export CFLAGS="-Wall -std=gnu99"
+unset LDFLAGS
+scan-build -plist --intercept-first --analyze-headers -o analyzer_reports ./configure | tee scan-build.log
+scan-build -plist --intercept-first --analyze-headers -o analyzer_reports make | tee -a scan-build.log
+scan-build -plist --intercept-first --analyze-headers -o analyzer_reports make check | tee -a scan-build.log
+
 # Run cppcheck analysis
 SOURCES_TO_ANALYZE="hwloc tests utils"
 SOURCES_TO_EXCLUDE="-itests/hwloc/ports -ihwloc/topology-aix.c -ihwloc/topology-bgq.c -ihwloc/topology-darwin.c -ihwloc/topology-freebsd.c -ihwloc/topology-hpux.c -ihwloc/topology-netbsd.c -ihwloc/topology-solaris.c -ihwloc/topology-solaris-chiptype.c -ihwloc/topology-windows.c -ihwloc/topology-cuda.c -ihwloc/topology-gl.c -ihwloc/topology-nvml.c -ihwloc/topology-opencl.c -iutils/lstopo/lstopo-windows.c"
@@ -109,45 +137,51 @@ sonar.host.url=https://sonarqube.bordeaux.inria.fr/sonarqube
 sonar.login=$(cat ~/.sonarqube-hwloc-token)
 sonar.links.homepage=https://www.open-mpi.org/projects/hwloc/
 sonar.links.ci=https://ci.inria.fr/hwloc/
-sonar.links.scm=https://github.com/open-mpi/hwloc.git
+sonar.links.scm=https://github.com/open-mpi/hwloc
 sonar.links.issue=https://github.com/open-mpi/hwloc/issues
 sonar.projectKey=tadaam:hwloc:github:$hwloc_branch
 sonar.projectDescription=Hardware locality (hwloc)
+# SED doesn't want us to define projectName
 sonar.projectVersion=$hwloc_branch
 sonar.scm.disabled=false
+# sonar.scm.provider=git requires sonar-scanner to run inside a git clone
 sonar.sourceEncoding=UTF-8
 sonar.language=c
 sonar.sources=hwloc, tests, utils
 sonar.exclusions=tests/hwloc/ports
+sonar.c.clangsa.reportPath=analyzer_reports/*/*.plist
 sonar.c.errorRecoveryEnabled=true
 sonar.c.compiler.parser=GCC
 sonar.c.compiler.charset=UTF-8
-sonar.c.compiler.regex=^(.*):([0-9]+):[0-9]+: warning: (.*)\\[(.*)\\]$
+sonar.c.compiler.regex=^(.*):(\\\d+):\\\d+: warning: (.*)\\\[(.*)\\\]$
 sonar.c.compiler.reportPath=hwloc-build.log
 sonar.c.coverage.reportPath=hwloc-coverage.xml
 sonar.c.cppcheck.reportPath=${CPPCHECK_XMLS}
 sonar.c.includeDirectories=$(echo | gcc -E -Wp,-v - 2>&1 | grep "^ " | tr '\n' ',')include,hwloc,utils/lstopo,utils/hwloc
 sonar.c.rats.reportPath=${RATS_XMLS}
 sonar.c.valgrind.reportPath=${VALGRIND_XMLS}
-sonar.issue.ignore.multicriteria=e1,e2,e3,e4,e5,e6,e7,e8,e9,e10,e11,e12,e13,e14
+sonar.issue.ignore.multicriteria=e1,e2,e3,e4,e5,e6,e7,e8,e9,e10,e11,e12,e13,e14,e15
 # Complete the task associated to this TODO comment.
-sonar.issue.ignore.multicriteria.e1.ruleKey=cxx:TodoTagPresence
+sonar.issue.ignore.multicriteria.e1.ruleKey=c:TodoTagPresence
 sonar.issue.ignore.multicriteria.e1.resourceKey=**
 # Missing curly brace.
-sonar.issue.ignore.multicriteria.e2.ruleKey=cxx:MissingCurlyBraces
+sonar.issue.ignore.multicriteria.e2.ruleKey=c:MissingCurlyBraces
 sonar.issue.ignore.multicriteria.e2.resourceKey=**
 # Extract this magic number '3' into a constant, variable declaration or an enum.
-sonar.issue.ignore.multicriteria.e3.ruleKey=cxx:MagicNumber
+sonar.issue.ignore.multicriteria.e3.ruleKey=c:MagicNumber
 sonar.issue.ignore.multicriteria.e3.resourceKey=**
 # Undocumented API: hwloc_noos_component
-sonar.issue.ignore.multicriteria.e4.ruleKey=cxx:UndocumentedApi
+sonar.issue.ignore.multicriteria.e4.ruleKey=c:UndocumentedApi
 sonar.issue.ignore.multicriteria.e4.resourceKey=**
 # At most one statement is allowed per line, but 2 statements were found on this line.
-sonar.issue.ignore.multicriteria.e5.ruleKey=cxx:TooManyStatementsPerLine
+sonar.issue.ignore.multicriteria.e5.ruleKey=c:TooManyStatementsPerLine
 sonar.issue.ignore.multicriteria.e5.resourceKey=**
 # Split this 166 characters long line (which is greater than 160 authorized).
-sonar.issue.ignore.multicriteria.e6.ruleKey=cxx:TooLongLine
+sonar.issue.ignore.multicriteria.e6.ruleKey=c:TooLongLine
 sonar.issue.ignore.multicriteria.e6.resourceKey=**
+# Sharing some naming conventions is a key point to make it possible for a team to efficiently collaborate. This rule allows to check that all class names match a provided regular expression.
+sonar.issue.ignore.multicriteria.e15.ruleKey=c:ClassName
+sonar.issue.ignore.multicriteria.e15.resourceKey=**
 # 196 more comment lines need to be written to reach the minimum threshold of 25.0% comment density.
 # BUG: doesn't seem to match properly, even with * or so on instead of ++
 sonar.issue.ignore.multicriteria.e7.ruleKey=common-c++:InsufficientCommentDensity
@@ -178,8 +212,4 @@ EOF
 # Run the sonar-scanner analysis and submit to SonarQube server
 sonar-scanner -X > sonar.log
 
-# cleanup
-rm -rf doc
-cd ..
-tar cfz ${basename}.build.tar.gz $basename
-rm -rf $basename
+exit 0
diff --git a/src/hwloc/contrib/ci.inria.fr/job-3-visualstudio.bat b/src/hwloc/contrib/ci.inria.fr/job-3-visualstudio.bat
deleted file mode 100644
index 551e0d0..0000000
--- a/src/hwloc/contrib/ci.inria.fr/job-3-visualstudio.bat
+++ /dev/null
@@ -1,36 +0,0 @@
-REM
-REM  Copyright © 2012-2017 Inria.  All rights reserved.
-REM  See COPYING in top-level directory.
-REM
-
-set PATH=%PATH%;C:\msys64\bin;C:\msys64\usr\bin
-
-REM  remove everything but the last 10 builds
-sh -c "rm -rf $(ls | grep -v ^hwloc- | grep -v ^job-) || true"
-sh -c "rm -rf $(ls -td hwloc-* | tail -n +21) || true"
-REM  chmod not needed when not doing make distcheck
-
-REM  find the tarball name
-for /f %%i in ('sh -c "ls -tr hwloc-*.tar.gz | grep -v build.tar.gz | tail -1 | sed -e s/.tar.gz//"') do set TARBALL=%%i
-
-sh -c "tar xfz %TARBALL%.tar.gz"
-if %errorlevel% neq 0 exit /b %errorlevel%
-
-cd %TARBALL%\contrib\windows
-if %errorlevel% neq 0 exit /b %errorlevel%
-
-C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild hwloc.sln /p:Configuration=Release /p:Platform=x64
-if %errorlevel% neq 0 exit /b %errorlevel%
-
-x64\Release\lstopo-no-graphics.exe
-if %errorlevel% neq 0 exit /b %errorlevel%
-
-x64\Release\hwloc-info.exe --support
-if %errorlevel% neq 0 exit /b %errorlevel%
-
-cd ..\..\..
-
-sh -c "tar cfz %TARBALL%-build.tar.gz %TARBALL%"
-if %errorlevel% neq 0 exit /b %errorlevel%
-
-sh -c "rm -rf %TARBALL%"
diff --git a/src/hwloc/contrib/hwloc-valgrind.supp b/src/hwloc/contrib/hwloc-valgrind.supp
index 8992fa3..96f73c5 100644
--- a/src/hwloc/contrib/hwloc-valgrind.supp
+++ b/src/hwloc/contrib/hwloc-valgrind.supp
@@ -1,4 +1,4 @@
-# Copyright © 2012-2015 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 
 # suppressions file to be passed to valgrind with
@@ -126,13 +126,13 @@
    obj:*libatiadl*
 }
 
-# 
+#  libpciaccess global state leak
 {
    libpciaccess_device_name_leak
    Memcheck:Leak
    ...
    fun:pci_device_get_device_name
-   fun:hwloc_look_libpci
+   fun:hwloc_look_pci
 }
 {
    libpciaccess_leak
@@ -140,7 +140,7 @@
    ...
    obj:*libpciaccess*
    ...
-   fun:hwloc_look_libpci
+   fun:hwloc_look_pci
 }
 
 # libudev global hashes
diff --git a/src/hwloc/contrib/windows/Makefile.am b/src/hwloc/contrib/windows/Makefile.am
new file mode 100644
index 0000000..50fde5d
--- /dev/null
+++ b/src/hwloc/contrib/windows/Makefile.am
@@ -0,0 +1,7 @@
+# Copyright © 2009-2018 Inria.  All rights reserved.
+# See COPYING in top-level directory.
+
+# This Makefile doesn't run by default because it requires
+# bash, and grep built with support for -P
+
+TESTS = test-windows-version.sh
diff --git a/src/hwloc/contrib/windows/hwloc_config.h b/src/hwloc/contrib/windows/hwloc_config.h
index c9d5c3a..557aed0 100644
--- a/src/hwloc/contrib/windows/hwloc_config.h
+++ b/src/hwloc/contrib/windows/hwloc_config.h
@@ -1,6 +1,6 @@
 /*
  * Copyright © 2009 CNRS
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2012 Université Bordeaux
  * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -11,6 +11,12 @@
 #ifndef HWLOC_CONFIG_H
 #define HWLOC_CONFIG_H
 
+#define HWLOC_VERSION "2.0.3"
+#define HWLOC_VERSION_MAJOR 2
+#define HWLOC_VERSION_MINOR 0
+#define HWLOC_VERSION_RELEASE 3
+#define HWLOC_VERSION_GREEK ""
+
 #define __hwloc_restrict
 #define __hwloc_inline __inline
 
diff --git a/src/hwloc/contrib/windows/libhwloc.vcxproj b/src/hwloc/contrib/windows/libhwloc.vcxproj
index 1a104e0..8bedb46 100644
--- a/src/hwloc/contrib/windows/libhwloc.vcxproj
+++ b/src/hwloc/contrib/windows/libhwloc.vcxproj
@@ -69,28 +69,28 @@
   <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='DebugDll|x64'">
     <LinkIncremental>false</LinkIncremental>
     <EmbedManifest>true</EmbedManifest>
-    <TargetName>$(ProjectName)-12</TargetName>
+    <TargetName>$(ProjectName)-15</TargetName>
     <IntDir>$(SolutionDir)$(Platform)\$(Configuration)\</IntDir>
     <OutDir>$(SolutionDir)$(Platform)\$(Configuration)\</OutDir>
   </PropertyGroup>
   <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='DebugStatic|x64'">
     <LinkIncremental>false</LinkIncremental>
     <EmbedManifest>true</EmbedManifest>
-    <TargetName>$(ProjectName)-12</TargetName>
+    <TargetName>$(ProjectName)-15</TargetName>
     <IntDir>$(SolutionDir)$(Platform)\$(Configuration)\</IntDir>
     <OutDir>$(SolutionDir)$(Platform)\$(Configuration)\</OutDir>
   </PropertyGroup>
   <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
     <LinkIncremental>false</LinkIncremental>
     <EmbedManifest>true</EmbedManifest>
-    <TargetName>$(ProjectName)-12</TargetName>
+    <TargetName>$(ProjectName)-15</TargetName>
     <IntDir>$(SolutionDir)$(Platform)\$(Configuration)\</IntDir>
     <OutDir>$(SolutionDir)$(Platform)\$(Configuration)\</OutDir>
   </PropertyGroup>
   <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='ReleaseStatic|x64'">
     <LinkIncremental>false</LinkIncremental>
     <EmbedManifest>true</EmbedManifest>
-    <TargetName>$(ProjectName)-12</TargetName>
+    <TargetName>$(ProjectName)-15</TargetName>
     <IntDir>$(SolutionDir)$(Platform)\$(Configuration)\</IntDir>
     <OutDir>$(SolutionDir)$(Platform)\$(Configuration)\</OutDir>
   </PropertyGroup>
diff --git a/src/hwloc/contrib/windows/private_config.h b/src/hwloc/contrib/windows/private_config.h
index 7b72194..a97bdfe 100644
--- a/src/hwloc/contrib/windows/private_config.h
+++ b/src/hwloc/contrib/windows/private_config.h
@@ -59,6 +59,10 @@
    */
 #define HAVE_DECL_FABSF 1
 
+/* Define to 1 if you have the declaration of `modff', and to 0 if you don't.
+   */
+#define HAVE_DECL_MODFF 1
+
 /* Define to 1 if you have the declaration of `HW_NCPU', and to 0 if you
    don't. */
 /* #undef HAVE_DECL_HW_NCPU */
@@ -81,7 +85,7 @@
 
 /* Define to 1 if you have the declaration of `strcasecmp', and to 0 if you
    don't. */
-#define HAVE_DECL_STRCASECMP 0
+/* #undef HWLOC_HAVE_DECL_STRCASECMP */
 
 /* Define to 1 if you have the declaration of `snprintf', and to 0 if you
    don't. */
@@ -640,7 +644,6 @@
 
 
 /* Version number of package */
-#define HWLOC_VERSION "2.0.1"
 #define VERSION HWLOC_VERSION
 
 /* Define to 1 if the X Window System is missing or not being used. */
diff --git a/src/hwloc/contrib/windows/test-windows-version.sh.in b/src/hwloc/contrib/windows/test-windows-version.sh.in
new file mode 100755
index 0000000..7625c62
--- /dev/null
+++ b/src/hwloc/contrib/windows/test-windows-version.sh.in
@@ -0,0 +1,93 @@
+#!@BASH@
+#-*-sh-*-
+
+#
+# Copyright © 2018 Inria.  All rights reserved.
+# See COPYING in top-level directory.
+#
+HWLOC_top_builddir="@HWLOC_top_builddir@"
+HWLOC_top_srcdir="@HWLOC_top_srcdir@"
+windows_config_h="$HWLOC_top_srcdir/contrib/windows/hwloc_config.h"
+config_h="$HWLOC_top_builddir/include/hwloc/autogen/config.h"
+vcxproj_file="$HWLOC_top_srcdir/contrib/windows/libhwloc.vcxproj"
+version_file="$HWLOC_top_srcdir/VERSION"
+
+# get all individual version components
+echo "Looking for Windows-specific version in $windows_config_h ..."
+windows_major=$(grep -w HWLOC_VERSION_MAJOR $windows_config_h | grep -oP '[0-9]+')
+windows_minor=$(grep -w HWLOC_VERSION_MINOR $windows_config_h | grep -oP '[0-9]+')
+windows_release=$(grep -w HWLOC_VERSION_RELEASE $windows_config_h | grep -oP '[0-9]+')
+windows_greek=$(grep -w HWLOC_VERSION_GREEK $windows_config_h | grep -oP '".*"' | tr -d \")
+if [ -z "$windows_major" -o -z "$windows_minor" -o -z "$windows_release" ]; then
+	# greek is likely empty on purpose, ignore it
+	echo "ERROR: Failed to get Windows-specific HWLOC_VERSION_MAJOR/MINOR/RELEASE"
+	exit 1
+fi
+echo "  Found major=$windows_major minor=$windows_minor release=$windows_release greek=$windows_greek"
+
+# check that the version string matches
+windows_version=$(grep -w HWLOC_VERSION $windows_config_h | grep -oP '".+"' | tr -d \")
+echo "  Found windows-specific HWLOC_VERSION \"$windows_version\""
+expected_windows_version="$windows_major.$windows_minor.$windows_release$windows_greek"
+if [ "$windows_version" != "$expected_windows_version" ]; then
+	echo "ERROR: Windows-specific HWLOC_VERSION \"$windows_version\" doesn't match HWLOC_VERSION_MAJOR/MINOR/RELEASE/GREEK components \"$expected_windows_version\""
+	exit 1
+fi
+echo "  Windows-specific HWLOC_VERSION \"$windows_version\" matches HWLOC_VERSION_MAJOR/MINOR/RELEASE/GREEK components"
+
+# check that it matchs the official version, without a GREEK
+echo "Looking in $config_h ..."
+official_major=$(grep -w HWLOC_VERSION_MAJOR $config_h  | grep -oP '[0-9]+')
+official_minor=$(grep -w HWLOC_VERSION_MINOR $config_h  | grep -oP '[0-9]+')
+official_release=$(grep -w HWLOC_VERSION_RELEASE $config_h  | grep -oP '[0-9]+')
+if [ -z "$official_major" -o -z "$official_minor" -o -z "$official_release" ]; then
+	echo "ERROR: Failed to get official HWLOC_VERSION_MAJOR/MINOR/RELEASE"
+	exit 1
+fi
+echo "  Found major=$official_major minor=$official_minor release=$official_release"
+official_version_nogreek="$official_major.$official_minor.$official_release"
+if [ "$official_version_nogreek" != "$windows_version" ]; then
+	echo "ERROR: Windows-specific HWLOC_VERSION \"$windows_version\" doesn't match \"$official_version_nogreek\" without GREEK"
+	exit 1
+fi
+echo "Windows-specific HWLOC_VERSION \"$windows_version\" matches official version without greek"
+
+echo
+
+# get the windows soname
+echo "Looking in $vcxproj_file ..."
+if [ `grep '<TargetName>' $vcxproj_file | uniq -c | wc -l` != 1 ]; then
+	echo "ERROR: Couldn't find a single value for <TargetName> lines"
+	exit 1
+fi
+windows_lib_soname=$(grep -m1 '<TargetName>' $vcxproj_file | grep -oP '\d+')
+if [ -z "$windows_lib_soname" ]; then
+	echo "ERROR: Failed to get the Windows-specific soname"
+	exit 1
+fi
+echo "  Found Windows-specific soname $windows_lib_soname"
+
+# get the official soname
+echo "Looking in $version_file ..."
+official_lib_version=$(grep -w "libhwloc_so_version" $version_file | grep -oP '\d+:\d+:\d+')
+if [ -z "$official_lib_version" ]; then
+	echo "ERROR: Failed to get the official lib version"
+	exit 1
+fi
+echo "  Found official lib version \"$official_lib_version\""
+
+# bashisms to extract the soname from the version
+IFS=':' arr=(${official_lib_version})
+declare -i official_lib_soname=${arr[0]}-${arr[2]}
+echo "  Extracted official lib soname $official_lib_soname"
+
+# check that sonames match only if on a release branch
+if [ "$official_lib_version" != "0:0:0" ] ; then
+	if [ "$windows_lib_soname" != "$official_lib_soname" ]; then
+		echo "ERROR: Windows-specific lib soname $windows_lib_soname differs from $official_lib_soname (from \"$official_lib_version\")"
+		exit 1
+	fi
+	echo "Windows-specific lib soname $windows_lib_soname matches official lib soname"
+else
+	echo "Ignoring unset lib soname"
+fi
diff --git a/src/hwloc/doc/examples/Makefile.am b/src/hwloc/doc/examples/Makefile.am
index 4785a78..355d711 100644
--- a/src/hwloc/doc/examples/Makefile.am
+++ b/src/hwloc/doc/examples/Makefile.am
@@ -1,4 +1,4 @@
-# Copyright © 2009-2016 Inria.  All rights reserved.
+# Copyright © 2009-2018 Inria.  All rights reserved.
 # Copyright © 2009-2013, 2017 Université Bordeaux
 # Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 # See COPYING in top-level directory.
@@ -19,7 +19,10 @@ if HWLOC_HAVE_CXX
 TESTS += hwloc-hello-cpp
 endif HWLOC_HAVE_CXX
 
-check_PROGRAMS = $(TESTS) cpuset+bitmap+cpubind nodeset+membind+policy sharedcaches get-knl-modes gpu
+check_PROGRAMS = $(TESTS) cpuset+bitmap+cpubind nodeset+membind+policy get-knl-modes gpu
+if !HWLOC_HAVE_WINDOWS
+check_PROGRAMS += sharedcaches
+endif
 
 hwloc-hello-cpp.cpp: $(srcdir)/hwloc-hello.c
 	cp -f $(srcdir)/hwloc-hello.c $@
diff --git a/src/hwloc/doc/examples/cpuset+bitmap+cpubind.c b/src/hwloc/doc/examples/cpuset+bitmap+cpubind.c
index 9e0ae64..8b20c07 100644
--- a/src/hwloc/doc/examples/cpuset+bitmap+cpubind.c
+++ b/src/hwloc/doc/examples/cpuset+bitmap+cpubind.c
@@ -3,7 +3,7 @@
  * - retrieving the location where the current thread executes
  * - combining/modifying cpusets using the bitmap API
  *
- * Copyright © 2014-2017 Inria.  All rights reserved.
+ * Copyright © 2014-2018 Inria.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -11,7 +11,9 @@
 #include <errno.h>
 #include <stdio.h>
 #include <string.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 
 int main(void)
 {
diff --git a/src/hwloc/doc/examples/gpu.c b/src/hwloc/doc/examples/gpu.c
index aea59d1..e408e5d 100644
--- a/src/hwloc/doc/examples/gpu.c
+++ b/src/hwloc/doc/examples/gpu.c
@@ -1,14 +1,12 @@
-/* Example hwloc API program.
+/* This example program plays with:
+ * - finding GPU OS devices
+ * - getting CUDA and OpenCL attributes
+ * - displaying the locality of the GPU
  *
- * See other examples under doc/examples/ in the source tree
- * for more details.
- *
- * Copyright © 2009-2016 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2011,2017 Université Bordeaux
  * Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
- *
- * hwloc-hello.c
  */
 
 #include <hwloc.h>
@@ -37,7 +35,10 @@ int main(void)
       obj = hwloc_get_obj_by_type(topology, HWLOC_OBJ_OS_DEVICE, i);
       printf("%s:\n", obj->name);
 
+      /* obj->attr->osdev.type is HWLOC_OBJ_OSDEV_COPROC */
+
       s = hwloc_obj_get_info_by_name(obj, "Backend");
+      /* obj->subtype also contains CUDA or OpenCL since v2.0 */
 
       if (s && !strcmp(s, "CUDA")) {
         /* This is a CUDA device */
diff --git a/src/hwloc/doc/examples/nodeset+membind+policy.c b/src/hwloc/doc/examples/nodeset+membind+policy.c
index 21fffb6..466104b 100644
--- a/src/hwloc/doc/examples/nodeset+membind+policy.c
+++ b/src/hwloc/doc/examples/nodeset+membind+policy.c
@@ -3,7 +3,7 @@
  * - manipulating nodesets
  * - memory binding and binding policies
  *
- * Copyright © 2014-2017 Inria.  All rights reserved.
+ * Copyright © 2014-2018 Inria.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -11,7 +11,9 @@
 #include <errno.h>
 #include <stdio.h>
 #include <string.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 #include <assert.h>
 
 int main(void)
diff --git a/src/hwloc/doc/examples/sharedcaches.c b/src/hwloc/doc/examples/sharedcaches.c
index 91b6af4..7329d62 100644
--- a/src/hwloc/doc/examples/sharedcaches.c
+++ b/src/hwloc/doc/examples/sharedcaches.c
@@ -1,7 +1,7 @@
 /* This example program looks for caches shared between this process
  * and another one based on their current binding.
  *
- * Copyright © 2014-2015 Inria.  All rights reserved.
+ * Copyright © 2014-2018 Inria.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -9,7 +9,9 @@
 #include <errno.h>
 #include <stdio.h>
 #include <string.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 
 int main(int argc, char *argv[])
 {
diff --git a/src/hwloc/doc/hwloc.doxy b/src/hwloc/doc/hwloc.doxy
index 702a5d4..48df210 100644
--- a/src/hwloc/doc/hwloc.doxy
+++ b/src/hwloc/doc/hwloc.doxy
@@ -845,7 +845,7 @@ threads) are not displayed.
 \endhtmlonly
 \section cli_hwloc_annotate hwloc-annotate
 
-hwloc-annotate may add object attributes such as string information
+hwloc-annotate may modify object (and topology) attributes such as string information
 (see \ref attributes_info for details) or Misc children objects.
 It reads an input topology from a XML file and outputs
 the annotated topology as another XML file.
@@ -1502,9 +1502,6 @@ Indeed this OpenFabrics HCA PCI device object contains one
 one OpenFabrics software device (<em>mlx4_0</em>) and two virtual
 network interface software devices (<em>ib0</em> and <em>ib1</em>).
 
-PCI link speed is also reported for some bridges and devices
-because lstopo was privileged when it discovered the topology.
-
 
 Here is the corresponding textual output:
 
@@ -1655,51 +1652,19 @@ The user may additionally add new key-value pairs to any object using
 hwloc_obj_add_info() or the \ref cli_hwloc_annotate program.
 
 Here is a non-exhaustive list of attributes that may be automatically
-added by hwloc (with the usual corresponding object in parentheses).
+added by hwloc.
 Note that these attributes heavily depend on the ability of the
 operating system to report them.
 Many of them will therefore be missing on some OS.
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_platform">
+\endhtmlonly
+\subsection attributes_info_platform Hardware Platform Information
+
+These info attributes are attached to the root object (Machine).
+
 <dl>
-<dt>OSName, OSRelease, OSVersion, HostName, Architecture
-(Machine object)</dt>
-<dd>The operating system name, release, version, the hostname and the
-architecture name, as reported by the Unix <tt>uname</tt> command.
-</dd>
-<dt>Backend (topology root, Machine object)</dt>
-<dd>The name of the hwloc backend/component that filled the topology.
-If several components were combined, multiple Backend keys may exist,
-with different values, for instance <tt>x86</tt>, <tt>Linux</tt>
-and <tt>pci</tt>.
-</dd>
-<dt>LinuxCgroup (Machine object)</dt>
-<dd>The name the Linux control group where the calling process is
-placed.
-</dd>
-<dt>SyntheticDescription (topology root, Machine object)</dt>
-<dd>The description string that was given to hwloc to build this
-synthetic topology.
-</dd>
-<dt>CPUModel (Package or Machine)</dt>
-<dd>The processor model name.
-Usually added to Package objects, but can be in Machine instead if
-hwloc failed to discover any package.
-</dd>
-<dt>CPUType (Package)</dt>
-<dd>
-A Solaris-specific general processor type name, such as "i86pc".
-</dd>
-<dt>CPUVendor, CPUModelNumber, CPUFamilyNumber, CPUStepping (Package or Machine)</dt>
-<dd>The processor vendor name, model number, family number, and stepping number.
-Currently available for x86 and Xeon Phi processors on most systems,
-and for ia64 processors on Linux (except CPUStepping).
-Usually added to Package objects, but can be in Machine instead if
-hwloc failed to discover any package.
-</dd>
-<dt>CPURevision (Package)</dt>
-<dd>
-A POWER/PowerPC-specific general processor revision number,
-currently only available on Linux.
-</dd>
 <dt>PlatformName, PlatformModel, PlatformVendor, PlatformBoardID, PlatformRevision,</dt>
 <dt> SystemVersionRegister, ProcessorVersionRegister (Machine)</dt>
 <dd>Some POWER/PowerPC-specific attributes describing the platform
@@ -1708,7 +1673,12 @@ Currently only available on Linux.
 Usually added to Package objects, but can be in Machine instead if
 hwloc failed to discover any package.
 </dd>
-<dt>MemoryMode, ClusterMode (topology root, Machine object)</dt>
+<dt>DMIBoardVendor, DMIBoardName, etc.</dt>
+<dd>DMI hardware information such as the motherboard and chassis
+models and vendors, the BIOS revision, etc.,
+as reported by Linux under <tt>/sys/class/dmi/id/</tt>.
+</dd>
+<dt>MemoryMode, ClusterMode</dt>
 <dd>
 Intel Xeon Phi processor configuration modes.
 Available if hwloc-dump-hwdata was used (see \ref faq_knl_dump)
@@ -1721,38 +1691,115 @@ The cluster mode may be <em>Quadrant</em>, <em>Hemisphere</em>, <em>All2All</em>
 <em>SNC2</em> or <em>SNC4</em>.
 See doc/examples/get-knl-modes.c in the source directory for an example of retrieving these attributes.
 </dd>
-<dt>Inclusive (Caches)</dt>
-<dd>The inclusiveness of a cache (1 if inclusive, 0 otherwise).
-Currently only available on x86 processors.
+</dl>
+
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_os">
+\endhtmlonly
+\subsection attributes_info_os Operating System Information
+
+These info attributes are attached to the root object (Machine).
+
+<dl>
+<dt>OSName, OSRelease, OSVersion, HostName, Architecture</dt>
+<dd>The operating system name, release, version, the hostname and the
+architecture name, as reported by the Unix <tt>uname</tt> command.
 </dd>
-<dt>SolarisProcessorGroup (Group)</dt>
-<dd>
-The Solaris kstat processor group name that was used to build this Group object.
+<dt>LinuxCgroup</dt>
+<dd>The name the Linux control group where the calling process is
+placed.
 </dd>
-<dt>PCIVendor, PCIDevice (PCI devices and bridges)</dt>
-<dd>The vendor and device names of the PCI device.
+</dl>
+
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_hwloc">
+\endhtmlonly
+\subsection attributes_info_hwloc hwloc Information
+
+Unless specified, these info attributes are attached to the root object (Machine).
+
+<dl>
+<dt>Backend (topology root, or specific object added by that backend)</dt>
+<dd>The name of the hwloc backend/component that filled the topology.
+If several components were combined, multiple Backend keys may exist,
+with different values, for instance <tt>x86</tt> and <tt>Linux</tt> in the root
+object and <tt>CUDA</tt> in CUDA OS device objects.
+</dd>
+<dt>SyntheticDescription</dt>
+<dd>The description string that was given to hwloc to build this
+synthetic topology.
+</dd>
+<dt>hwlocVersion</dt>
+<dd>The version number of the hwloc library that was used to generate
+the topology. If the topology was loaded from XML, this is not the hwloc
+version that loaded it, but rather the first hwloc instance that exported
+the topology to XML earlier.
 </dd>
-<dt>PCISlot</dt>
-<dd>The name/number of the physical slot where the PCI device is plugged.
+<dt>ProcessName</dt>
+<dd>The name of the process that contains the hwloc library that was used
+to generate the topology. If the topology was from XML, this is not the
+hwloc process that loaded it, but rather the first process that exported
+the topology to XML earlier.
+</dd>
+</dl>
+
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_cpu">
+\endhtmlonly
+\subsection attributes_info_cpu CPU Information
+
+These info attributes are attached to Package objects,
+or to the root object (Machine) if package locality information is missing.
+
+<dl>
+<dt>CPUModel</dt>
+<dd>The processor model name.</dd>
+<dt>CPUVendor, CPUModelNumber, CPUFamilyNumber, CPUStepping</dt>
+<dd>The processor vendor name, model number, family number, and stepping number.
+Currently available for x86 and Xeon Phi processors on most systems,
+and for ia64 processors on Linux (except CPUStepping).
+</dd>
+<dt>CPURevision</dt>
+<dd>
+A POWER/PowerPC-specific general processor revision number,
+currently only available on Linux.
 </dd>
-<dt>Vendor, Model, Revision, SerialNumber, Size, SectorSize</dt>
+<dt>CPUType</dt>
+<dd>
+A Solaris-specific general processor type name, such as "i86pc".
+</dd>
+</dl>
+
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_osdev">
+\endhtmlonly
+\subsection attributes_info_osdev OS Device Information
+
+These info attributes are attached to OS device objects specified in parentheses.
+
+<dl>
+<dt>Vendor, Model, Revision, SerialNumber, Size, SectorSize (Block OS devices)</dt>
 <dd>The vendor and model names, revision, serial number, size (in kB)
-and SectorSize (in bytes) of a Block OS device.
+and SectorSize (in bytes).
 </dd>
-<dt>LinuxDeviceID</dt>
-<dd>The major/minor device number such as 8:0 on Linux for a Block OS device.
+<dt>LinuxDeviceID (Block OS devices)</dt>
+<dd>The major/minor device number such as 8:0 of Linux device.
 </dd>
 <dt>GPUVendor, GPUModel (GPU or Co-Processor OS devices)</dt>
 <dd>The vendor and model names of the GPU device.
 </dd>
 <dt>OpenCLDeviceType, OpenCLPlatformIndex,</dt>
-<dt>OpenCLPlatformName, OpenCLPlatformDeviceIndex (OpenCL GPU OS devices)</dt>
+<dt>OpenCLPlatformName, OpenCLPlatformDeviceIndex (OpenCL OS devices)</dt>
 <dd>The type of OpenCL device,
  the OpenCL platform index and name,
  and the index of the device within the platform.
 </dd>
-<dt>OpenCLComputeUnits, OpenCLGlobalMemorySize</dt>
-<dd>The number of compute units and global memory size (in kB) of a OpenCL device.
+<dt>OpenCLComputeUnits, OpenCLGlobalMemorySize (OpenCL OS devices)</dt>
+<dd>The number of compute units and global memory size (in kB) of an OpenCL device.
 </dd>
 <dt>NVIDIAUUID, NVIDIASerial (NVML GPU OS devices)</dt>
 <dd>The UUID and Serial of NVIDIA GPUs.
@@ -1765,7 +1812,7 @@ and SectorSize (in bytes) of a Block OS device.
  and size of the shared memory in each multiprocessor of a CUDA device.
  Sizes are in kB.
 </dd>
-<dt>MICSerialNumber</dt>
+<dt>MICSerialNumber (MIC coprocessor OS device)</dt>
 <dd>
  The serial number of an Intel Xeon Phi (MIC) coprocessor.
  hwloc may run either inside the coprocessor itself, or on the host processor.
@@ -1777,16 +1824,11 @@ and SectorSize (in bytes) of a Block OS device.
  When running hwloc inside a Xeon Phi coprocessor, the root of the topology
  (Machine object) gets this attribute.
 </dd>
-<dt>MICFamily, MICSKU, MICActiveCores, MICMemorySize</dt>
+<dt>MICFamily, MICSKU, MICActiveCores, MICMemorySize (MIC coprocessor OS device)</dt>
 <dd>The family, SKU (model),
  number of active cores, and memory size (in kB)
  of an Intel Xeon Phi (MIC) coprocessor.
 </dd>
-<dt>DMIBoardVendor, DMIBoardName, etc. (Machine object)</dt>
-<dd>DMI hardware information such as the motherboard and chassis
-models and vendors, the BIOS revision, etc.,
-as reported by Linux under <tt>/sys/class/dmi/id/</tt>.
-</dd>
 <dt>Address, Port (Network interface OS devices)</dt>
 <dd>The MAC address and the port number of a software network
 interface, such as <tt>eth4</tt> on Linux.
@@ -1798,24 +1840,46 @@ the state of a port #1 (value is 4 when active),
 the LID and LID mask count of port #2,
 and GID #1 of port #3.
 </dd>
-<dt>Vendor, AssetTag, PartNumber, DeviceLocation, BankLocation (MemoryModule Misc objects)</dt>
+</dl>
+
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_otherobjs">
+\endhtmlonly
+\subsection attributes_info_otherobjs Other Object-specific Information
+
+These info attributes are attached to objects specified in parentheses.
+
+<dl>
+<dt>Inclusive (Caches)</dt>
+<dd>The inclusiveness of a cache (1 if inclusive, 0 otherwise).
+Currently only available on x86 processors.
+</dd>
+<dt>SolarisProcessorGroup (Group)</dt>
 <dd>
-Information about memory modules (DIMMs) extracted from SMBIOS.
+The Solaris kstat processor group name that was used to build this Group object.
 </dd>
-<dt>hwlocVersion</dt>
-<dd>The version number of the hwloc library that was used to generate
-the topology. If the topology was loaded from XML, this is not the hwloc
-version that loaded it, but rather the first hwloc instance that exported
-the topology to XML earlier.
+<dt>PCIVendor, PCIDevice (PCI devices and bridges)</dt>
+<dd>The vendor and device names of the PCI device.
 </dd>
-<dt>ProcessName</dt>
-<dd>The name of the process that contains the hwloc library that was used
-to generate the topology. If the topology was from XML, this is not the
-hwloc version that loaded it, but rather the first process that exported
-the topology to XML earlier.
+<dt>PCISlot (PCI devices or Bridges)</dt>
+<dd>The name/number of the physical slot where the device is plugged.
+ If the physical device contains PCI bridges above the actual PCI device,
+ the attribute may be attached to the highest bridge
+ (i.e. the first object that actually appears below the physical slot).
+</dd>
+<dt>Vendor, AssetTag, PartNumber, DeviceLocation, BankLocation (MemoryModule Misc objects)</dt>
+<dd>
+Information about memory modules (DIMMs) extracted from SMBIOS.
 </dd>
 </dl>
 
+
+\htmlonly
+</div><div class="subsection" id="attributes_info_user">
+\endhtmlonly
+\subsection attributes_info_user User-Given Information
+
 Here is a non-exhaustive list of user-provided info attributes
 that have a special meaning:
 <dl>
@@ -2828,13 +2892,17 @@ be loaded before gathering information and binding tasks or memory.
 Fortunately this overhead may be significantly reduced by filtering
 non-interesting information out of the topology.
 For instance the following code builds a topology that only contains
-Cores, hardware threads (PUs, cannot be filtered-out),
-and NUMA nodes (cannot be filtered-out).
+Cores (explicitly filtered-in below),
+hardware threads (PUs, cannot be filtered-out),
+NUMA nodes (cannot be filtered-out),
+and the root object (usually a Machine; the root cannot be removed without breaking the tree).
 
 \verbatim
 hwloc_topology_t topology;
 hwloc_topology_init(&topology);
+/* filter everything out */
 hwloc_topology_set_all_types_filter(topology, HWLOC_TYPE_FILTER_KEEP_NONE);
+/* filter Cores back in */
 hwloc_topology_set_type_filter(topology, HWLOC_OBJ_CORE, HWLOC_TYPE_FILTER_KEEP_ALL);
 hwloc_topology_load(topology);
 \endverbatim
@@ -3263,7 +3331,7 @@ variable may avoid this.
 Also remember that these components may be disabled at build-time with
 configure flags such as <tt>\--disable-opencl</tt>, <tt>\--disable-cuda</tt> or <tt>\--disable-nvml</tt>,
 and at runtime with the environment variable
-<tt>HWLOC_COMPONENTS=-opencl,cuda,nvml</tt>.
+<tt>HWLOC_COMPONENTS=-opencl,-cuda,-nvml</tt>.
 
 
 \subsection faq_privileged Does hwloc require privileged access?
@@ -3271,8 +3339,7 @@ and at runtime with the environment variable
 hwloc discovers the topology by querying the operating system.
 Some minor features may require privileged access to the operation
 system.
-For instance memory module and PCI link speed discovery on Linux
-is reserved to root,
+For instance memory module discovery on Linux is reserved to root,
 and the entire PCI discovery on Solaris and BSDs requires access to
 some special files that are usually restricted to root
 (/dev/pci* or /devices/pci*).
@@ -3311,13 +3378,15 @@ resulting topology will miss some objects and may be asymmetric
 
 \verbatim
 ****************************************************************************
-* hwloc has encountered what looks like an error from the operating system.
+* hwloc received invalid information from the operating system.
 *
 * L3 (cpuset 0x000003f0) intersects with NUMANode (P#0 cpuset 0x0000003f) without inclusion!
 * Error occurred in topology.c line 940
 *
 * Please report this error message to the hwloc user's mailing list,
 * along with the files generated by the hwloc-gather-topology script.
+*
+* hwloc will now ignore this invalid topology information and continue.
 ****************************************************************************
 \endverbatim
 
@@ -3440,6 +3509,11 @@ and <tt>hwloc_get_api_version()</tt> came only in 1.1.1.
 Also do not use the old cpuset API since it was deprecated and superseded
 by the bitmap API in 1.1, and later removed in 1.5.
 
+If you ever need to look at the library version instead of the API version,
+you may want to use HWLOC_VERSION instead.
+Two stable releases of the same series usually have the same ::HWLOC_API_VERSION
+even if their HWLOC_VERSION are different.
+
 
 
 \htmlonly
@@ -3457,7 +3531,7 @@ Processors can be configured in various clustering modes to have up to 4 <em>Clu
 Moreover, each <em>Cluster</em> (quarter, half or whole processor) of the processor may have its own local
 parts of the DDR and of the MCDRAM.
 This memory and clustering configuration may be probed by looking at MemoryMode
-and ClusterMode attributes, see \ref attributes_info and doc/examples/get-knl-modes.c
+and ClusterMode attributes, see \ref attributes_info_platform and doc/examples/get-knl-modes.c
 in the source directory.
 
 Starting with version 2.0, hwloc properly exposes this memory
@@ -3590,6 +3664,20 @@ sysctl variable must be set to 1 to do so.
 Otherwise, only the number of logical processors will be detected.
 
 
+\subsection faq_aix_bind Why does binding fail on AIX?
+
+The AIX operating system requires specific user capabilities for
+attaching processes to resource sets (CAP_NUMA_ATTACH).
+Otherwise functions such as hwloc_set_cpubind() fail (return -1 with errno set to EPERM).
+
+This capability must also be inherited (through the additional CAP_PROPAGATE capability)
+if you plan to bind a process before forking another process,
+for instance with <tt>hwloc-bind</tt>.
+
+These capabilities may be given by the administrator with:
+\verbatim
+chuser "capabilities=CAP_PROPAGATE,CAP_NUMA_ATTACH" <username>
+\endverbatim
 
 
 \page upgrade_to_api_2x Upgrading to the hwloc 2.0 API
diff --git a/src/hwloc/hwloc/distances.c b/src/hwloc/hwloc/distances.c
index 1091ced..f0b91f0 100644
--- a/src/hwloc/hwloc/distances.c
+++ b/src/hwloc/hwloc/distances.c
@@ -345,7 +345,7 @@ int hwloc_internal_distances_add(hwloc_topology_t topology,
 /* The actual function exported to the user
  */
 int hwloc_distances_add(hwloc_topology_t topology,
-			unsigned nbobjs, hwloc_obj_t *objs, uint64_t *values,
+			unsigned nbobjs, hwloc_obj_t *objs, hwloc_uint64_t *values,
 			unsigned long kind, unsigned long flags)
 {
   hwloc_obj_type_t type;
@@ -671,20 +671,22 @@ hwloc_distances_get_by_depth(hwloc_topology_t topology, int depth,
 
 static void hwloc_report_user_distance_error(const char *msg, int line)
 {
-    static int reported = 0;
-
-    if (!reported && !hwloc_hide_errors()) {
-        fprintf(stderr, "****************************************************************************\n");
-        fprintf(stderr, "* hwloc %s has encountered what looks like an error from user-given distances.\n", HWLOC_VERSION);
-        fprintf(stderr, "*\n");
-        fprintf(stderr, "* %s\n", msg);
-        fprintf(stderr, "* Error occurred in topology.c line %d\n", line);
-        fprintf(stderr, "*\n");
-        fprintf(stderr, "* Please make sure that distances given through the interface or environment\n");
-        fprintf(stderr, "* variables do not contradict any other topology information.\n");
-        fprintf(stderr, "****************************************************************************\n");
-        reported = 1;
-    }
+  static int reported = 0;
+
+  if (!reported && !hwloc_hide_errors()) {
+    fprintf(stderr, "****************************************************************************\n");
+    fprintf(stderr, "* hwloc %s was given invalid distances by the user.\n", HWLOC_VERSION);
+    fprintf(stderr, "*\n");
+    fprintf(stderr, "* %s\n", msg);
+    fprintf(stderr, "* Error occurred in topology.c line %d\n", line);
+    fprintf(stderr, "*\n");
+    fprintf(stderr, "* Please make sure that distances given through the programming API\n");
+    fprintf(stderr, "* do not contradict any other topology information.\n");
+    fprintf(stderr, "* \n");
+    fprintf(stderr, "* hwloc will now ignore this invalid topology information and continue.\n");
+    fprintf(stderr, "****************************************************************************\n");
+    reported = 1;
+  }
 }
 
 static int hwloc_compare_values(uint64_t a, uint64_t b, float accuracy)
diff --git a/src/hwloc/hwloc/misc.c b/src/hwloc/hwloc/misc.c
index 1889294..16dacf6 100644
--- a/src/hwloc/hwloc/misc.c
+++ b/src/hwloc/hwloc/misc.c
@@ -2,7 +2,7 @@
  * Copyright © 2009 CNRS
  * Copyright © 2009-2015 Inria.  All rights reserved.
  * Copyright © 2009-2010 Université Bordeaux
- * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.
+ * Copyright © 2009-2018 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -128,18 +128,18 @@ char *
 hwloc_progname(struct hwloc_topology *topology __hwloc_attribute_unused)
 {
 #if HAVE_DECL_GETMODULEFILENAME
-  char name[256], *basename;
+  char name[256], *local_basename;
   unsigned res = GetModuleFileName(NULL, name, sizeof(name));
   if (res == sizeof(name) || !res)
     return NULL;
-  basename = strrchr(name, '\\');
-  if (!basename)
-    basename = name;
+  local_basename = strrchr(name, '\\');
+  if (!local_basename)
+    local_basename = name;
   else
-    basename++;
-  return strdup(basename);
+    local_basename++;
+  return strdup(local_basename);
 #else /* !HAVE_GETMODULEFILENAME */
-  const char *name, *basename;
+  const char *name, *local_basename;
 #if HAVE_DECL_GETPROGNAME
   name = getprogname(); /* FreeBSD, NetBSD, some Solaris */
 #elif HAVE_DECL_GETEXECNAME
@@ -156,11 +156,11 @@ hwloc_progname(struct hwloc_topology *topology __hwloc_attribute_unused)
 #endif
   if (!name)
     return NULL;
-  basename = strrchr(name, '/');
-  if (!basename)
-    basename = name;
+  local_basename = strrchr(name, '/');
+  if (!local_basename)
+    local_basename = name;
   else
-    basename++;
-  return strdup(basename);
+    local_basename++;
+  return strdup(local_basename);
 #endif /* !HAVE_GETMODULEFILENAME */
 }
diff --git a/src/hwloc/hwloc/pci-common.c b/src/hwloc/hwloc/pci-common.c
index 3eda455..00f08a9 100644
--- a/src/hwloc/hwloc/pci-common.c
+++ b/src/hwloc/hwloc/pci-common.c
@@ -1,5 +1,5 @@
 /*
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -16,7 +16,7 @@
 #endif
 #include <sys/stat.h>
 
-#ifdef HWLOC_WIN_SYS
+#if defined(HWLOC_WIN_SYS) && !defined(__CYGWIN__)
 #include <io.h>
 #define open _open
 #define read _read
@@ -753,7 +753,6 @@ hwloc_pcidisc_setup_bridge_attr(hwloc_obj_t obj,
 		pattr->domain, pattr->bus, pattr->dev, pattr->func, config[HWLOC_PCI_PRIMARY_BUS]);
   }
 
-  obj->type = HWLOC_OBJ_BRIDGE;
   battr->upstream_type = HWLOC_OBJ_BRIDGE_PCI;
   battr->downstream_type = HWLOC_OBJ_BRIDGE_PCI;
   battr->downstream.pci.domain = pattr->domain;
diff --git a/src/hwloc/hwloc/shmem.c b/src/hwloc/hwloc/shmem.c
index cdd7fc3..6c507f5 100644
--- a/src/hwloc/hwloc/shmem.c
+++ b/src/hwloc/hwloc/shmem.c
@@ -1,5 +1,5 @@
 /*
- * Copyright © 2017 Inria.  All rights reserved.
+ * Copyright © 2017-2018 Inria.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -11,7 +11,9 @@
 #ifndef HWLOC_WIN_SYS
 
 #include <sys/mman.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 #include <assert.h>
 
 #define HWLOC_SHMEM_HEADER_VERSION 1
@@ -76,7 +78,7 @@ hwloc_shmem_topology_get_length(hwloc_topology_t topology,
 
 int
 hwloc_shmem_topology_write(hwloc_topology_t topology,
-			   int fd, uint64_t fileoffset,
+			   int fd, hwloc_uint64_t fileoffset,
 			   void *mmap_address, size_t length,
 			   unsigned long flags)
 {
@@ -144,7 +146,7 @@ hwloc_shmem_topology_write(hwloc_topology_t topology,
 
 int
 hwloc_shmem_topology_adopt(hwloc_topology_t *topologyp,
-			   int fd, uint64_t fileoffset,
+			   int fd, hwloc_uint64_t fileoffset,
 			   void *mmap_address, size_t length,
 			   unsigned long flags)
 {
@@ -259,7 +261,7 @@ hwloc_shmem_topology_get_length(hwloc_topology_t topology __hwloc_attribute_unus
 
 int
 hwloc_shmem_topology_write(hwloc_topology_t topology __hwloc_attribute_unused,
-			   int fd __hwloc_attribute_unused, uint64_t fileoffset __hwloc_attribute_unused,
+			   int fd __hwloc_attribute_unused, hwloc_uint64_t fileoffset __hwloc_attribute_unused,
 			   void *mmap_address __hwloc_attribute_unused, size_t length __hwloc_attribute_unused,
 			   unsigned long flags __hwloc_attribute_unused)
 {
@@ -269,7 +271,7 @@ hwloc_shmem_topology_write(hwloc_topology_t topology __hwloc_attribute_unused,
 
 int
 hwloc_shmem_topology_adopt(hwloc_topology_t *topologyp __hwloc_attribute_unused,
-			   int fd __hwloc_attribute_unused, uint64_t fileoffset __hwloc_attribute_unused,
+			   int fd __hwloc_attribute_unused, hwloc_uint64_t fileoffset __hwloc_attribute_unused,
 			   void *mmap_address __hwloc_attribute_unused, size_t length __hwloc_attribute_unused,
 			   unsigned long flags __hwloc_attribute_unused)
 {
diff --git a/src/hwloc/hwloc/topology-linux.c b/src/hwloc/hwloc/topology-linux.c
index 2c60b1e..f276b71 100644
--- a/src/hwloc/hwloc/topology-linux.c
+++ b/src/hwloc/hwloc/topology-linux.c
@@ -2,7 +2,7 @@
  * Copyright © 2009 CNRS
  * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2013, 2015 Université Bordeaux
- * Copyright © 2009-2014 Cisco Systems, Inc.  All rights reserved.
+ * Copyright © 2009-2018 Cisco Systems, Inc.  All rights reserved.
  * Copyright © 2015 Intel, Inc.  All rights reserved.
  * Copyright © 2010 IBM
  * See COPYING in top-level directory.
@@ -3134,8 +3134,10 @@ list_sysfsnode(struct hwloc_linux_backend_data_s *data,
     return NULL;
 
   nodeset = hwloc_bitmap_alloc();
-  if (!nodeset)
+  if (!nodeset) {
+    closedir(dir);
     return NULL;
+  }
 
   while ((dirent = readdir(dir)) != NULL) {
     if (strncmp(dirent->d_name, "node", 4))
@@ -3569,7 +3571,7 @@ look_sysfscpu(struct hwloc_topology *topology,
       sprintf(str, "%s/cpu%d/topology/thread_siblings", path, i);
       coreset = hwloc__alloc_read_path_as_cpumask(str, data->root_fd);
       if (coreset) {
-        unsigned mycoreid;
+        unsigned mycoreid = (unsigned) -1;
 	int gotcoreid = 0; /* to avoid reading the coreid twice */
 	hwloc_bitmap_and(coreset, coreset, cpuset);
 	if (hwloc_bitmap_weight(coreset) > 1 && threadwithcoreid == -1) {
@@ -4927,7 +4929,7 @@ hwloc_linuxfs_block_class_fillinfos(struct hwloc_backend *backend __hwloc_attrib
   struct hwloc_linux_backend_data_s *data = backend->private_data;
 #endif
   FILE *file;
-  char path[256];
+  char path[296]; /* osdevpath <= 256 */
   char line[128];
   char vendor[64] = "";
   char model[64] = "";
@@ -5140,7 +5142,7 @@ hwloc_linuxfs_net_class_fillinfos(int root_fd,
 				  struct hwloc_obj *obj, const char *osdevpath)
 {
   struct stat st;
-  char path[256];
+  char path[296]; /* osdevpath <= 256 */
   char address[128];
   snprintf(path, sizeof(path), "%s/address", osdevpath);
   if (!hwloc_read_path_by_length(path, address, sizeof(address), root_fd)) {
@@ -5207,7 +5209,7 @@ static void
 hwloc_linuxfs_infiniband_class_fillinfos(int root_fd,
 					 struct hwloc_obj *obj, const char *osdevpath)
 {
-  char path[256];
+  char path[296]; /* osdevpath <= 256 */
   char guidvalue[20];
   unsigned i,j;
 
@@ -5328,7 +5330,7 @@ static void
 hwloc_linuxfs_mic_class_fillinfos(int root_fd,
 				  struct hwloc_obj *obj, const char *osdevpath)
 {
-  char path[256];
+  char path[296]; /* osdevpath <= 256 */
   char family[64];
   char sku[64];
   char sn[64];
@@ -5815,8 +5817,22 @@ hwloc_linuxfs_pci_look_pcidevices(struct hwloc_backend *backend)
 
     /* try to get the link speed */
     offset = hwloc_pcidisc_find_cap(config_space_cache, HWLOC_PCI_CAP_ID_EXP);
-    if (offset > 0 && offset + 20 /* size of PCI express block up to link status */ <= CONFIG_SPACE_CACHESIZE)
+    if (offset > 0 && offset + 20 /* size of PCI express block up to link status */ <= CONFIG_SPACE_CACHESIZE) {
       hwloc_pcidisc_find_linkspeed(config_space_cache, offset, &attr->linkspeed);
+    } else {
+      /* if not available from config-space (extended part is root-only), look in sysfs files added in 4.13 */
+      float speed = 0.f;
+      unsigned width = 0;
+      err = snprintf(path, sizeof(path), "/sys/bus/pci/devices/%s/current_link_speed", dirent->d_name);
+      if ((size_t) err < sizeof(path)
+	  && !hwloc_read_path_by_length(path, value, sizeof(value), root_fd))
+	speed = hwloc_linux_pci_link_speed_from_string(value);
+      err = snprintf(path, sizeof(path), "/sys/bus/pci/devices/%s/current_link_width", dirent->d_name);
+      if ((size_t) err < sizeof(path)
+	  && !hwloc_read_path_by_length(path, value, sizeof(value), root_fd))
+	width = atoi(value);
+      attr->linkspeed = speed*width/8;
+    }
 
     hwloc_pcidisc_tree_insert_by_busid(&tree, obj);
   }
@@ -5891,12 +5907,23 @@ hwloc_linuxfs_pci_look_pcislots(struct hwloc_backend *backend)
       if ((size_t) err < sizeof(path)
 	  && !hwloc_read_path_by_length(path, buf, sizeof(buf), root_fd)
 	  && sscanf(buf, "%x:%x:%x", &domain, &bus, &dev) == 3) {
+	/* may also be %x:%x without a device number but that's only for hotplug when nothing is plugged, ignore those */
 	hwloc_obj_t obj = hwloc_linuxfs_pci_find_pcislot_obj(hwloc_get_root_obj(topology)->io_first_child, domain, bus, dev);
-	if (obj) {
-	  while (obj && obj->attr->pcidev.dev == dev /* sibling have same domain+bus */) {
-	    hwloc_obj_add_info(obj, "PCISlot", dirent->d_name);
-	    obj = obj->next_sibling;
-	  }
+	while (obj) {
+	  /* Apply the slot to that device and its siblings with same domain/bus/dev ID.
+	   * Make sure that siblings are still PCI and on the same bus
+	   * (optional bridge filtering can put different things together).
+	   */
+	  if (obj->type != HWLOC_OBJ_PCI_DEVICE &&
+	      (obj->type != HWLOC_OBJ_BRIDGE || obj->attr->bridge.upstream_type != HWLOC_OBJ_BRIDGE_PCI))
+	    break;
+	  if (obj->attr->pcidev.domain != domain
+	      || obj->attr->pcidev.bus != bus
+	      || obj->attr->pcidev.dev != dev)
+	    break;
+
+	  hwloc_obj_add_info(obj, "PCISlot", dirent->d_name);
+	  obj = obj->next_sibling;
 	}
       }
     }
diff --git a/src/hwloc/hwloc/topology-opencl.c b/src/hwloc/hwloc/topology-opencl.c
index e11dc60..6889f65 100644
--- a/src/hwloc/hwloc/topology-opencl.c
+++ b/src/hwloc/hwloc/topology-opencl.c
@@ -12,6 +12,7 @@
 #include <private/misc.h>
 #include <private/debug.h>
 
+#define CL_TARGET_OPENCL_VERSION 220
 #ifdef __APPLE__
 #include <OpenCL/cl_ext.h>
 #else
diff --git a/src/hwloc/hwloc/topology-pci.c b/src/hwloc/hwloc/topology-pci.c
index fdd570e..0e2d554 100644
--- a/src/hwloc/hwloc/topology-pci.c
+++ b/src/hwloc/hwloc/topology-pci.c
@@ -2,7 +2,7 @@
  * Copyright © 2009 CNRS
  * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2011, 2013 Université Bordeaux
- * Copyright © 2014 Cisco Systems, Inc.  All rights reserved.
+ * Copyright © 2014-2018 Cisco Systems, Inc.  All rights reserved.
  * Copyright © 2015      Research Organization for Information Science
  *                       and Technology (RIST). All rights reserved.
  * See COPYING in top-level directory.
@@ -142,19 +142,21 @@ hwloc_look_pci(struct hwloc_backend *backend)
     unsigned char config_space_cache[CONFIG_SPACE_CACHESIZE];
     hwloc_obj_type_t type;
     struct hwloc_obj *obj;
-    unsigned domain;
+    unsigned domain, bus, dev, func;
     unsigned device_class;
     unsigned short tmp16;
     unsigned offset;
 
+    domain = pcidev->domain;
+    bus = pcidev->bus;
+    dev = pcidev->dev;
+    func = pcidev->func;
+
     /* initialize the config space in case we fail to read it (missing permissions, etc). */
     memset(config_space_cache, 0xff, CONFIG_SPACE_CACHESIZE);
     pci_device_probe(pcidev);
     pci_device_cfg_read(pcidev, config_space_cache, 0, CONFIG_SPACE_CACHESIZE, NULL);
 
-    /* try to read the domain */
-    domain = pcidev->domain;
-
     /* try to read the device_class */
     device_class = pcidev->device_class >> 8;
 
@@ -204,26 +206,26 @@ hwloc_look_pci(struct hwloc_backend *backend)
       char path[64];
       char value[16];
       FILE *file;
-      size_t read;
+      size_t bytes_read;
 
       snprintf(path, sizeof(path), "/sys/bus/pci/devices/%04x:%02x:%02x.%01x/vendor",
-	       domain, pcidev->bus, pcidev->dev, pcidev->func);
+	       domain, bus, dev, func);
       file = fopen(path, "r");
       if (file) {
-	read = fread(value, 1, sizeof(value), file);
+	bytes_read = fread(value, 1, sizeof(value), file);
 	fclose(file);
-	if (read)
+	if (bytes_read)
 	  /* fixup the pciaccess struct so that pci_device_get_vendor_name() is correct later. */
           pcidev->vendor_id = strtoul(value, NULL, 16);
       }
 
       snprintf(path, sizeof(path), "/sys/bus/pci/devices/%04x:%02x:%02x.%01x/device",
-	       domain, pcidev->bus, pcidev->dev, pcidev->func);
+	       domain, bus, dev, func);
       file = fopen(path, "r");
       if (file) {
-	read = fread(value, 1, sizeof(value), file);
+	bytes_read = fread(value, 1, sizeof(value), file);
 	fclose(file);
-	if (read)
+	if (bytes_read)
 	  /* fixup the pciaccess struct so that pci_device_get_device_name() is correct later. */
           pcidev->device_id = strtoul(value, NULL, 16);
       }
@@ -232,9 +234,9 @@ hwloc_look_pci(struct hwloc_backend *backend)
 
     obj = hwloc_alloc_setup_object(topology, type, HWLOC_UNKNOWN_INDEX);
     obj->attr->pcidev.domain = domain;
-    obj->attr->pcidev.bus = pcidev->bus;
-    obj->attr->pcidev.dev = pcidev->dev;
-    obj->attr->pcidev.func = pcidev->func;
+    obj->attr->pcidev.bus = bus;
+    obj->attr->pcidev.dev = dev;
+    obj->attr->pcidev.func = func;
     obj->attr->pcidev.vendor_id = pcidev->vendor_id;
     obj->attr->pcidev.device_id = pcidev->device_id;
     obj->attr->pcidev.class_id = device_class;
@@ -243,8 +245,38 @@ hwloc_look_pci(struct hwloc_backend *backend)
     obj->attr->pcidev.linkspeed = 0; /* unknown */
     offset = hwloc_pcidisc_find_cap(config_space_cache, PCI_CAP_ID_EXP);
 
-    if (offset > 0 && offset + 20 /* size of PCI express block up to link status */ <= CONFIG_SPACE_CACHESIZE)
+    if (offset > 0 && offset + 20 /* size of PCI express block up to link status */ <= CONFIG_SPACE_CACHESIZE) {
       hwloc_pcidisc_find_linkspeed(config_space_cache, offset, &obj->attr->pcidev.linkspeed);
+#ifdef HWLOC_LINUX_SYS
+    } else {
+      /* if not available from config-space (extended part is root-only), look in Linux sysfs files added in 4.13 */
+      char path[64];
+      char value[16];
+      FILE *file;
+      size_t bytes_read;
+      float speed = 0.f;
+      unsigned width = 0;
+      snprintf(path, sizeof(path), "/sys/bus/pci/devices/%04x:%02x:%02x.%01x/current_link_speed",
+	       domain, bus, dev, func);
+      file = fopen(path, "r");
+      if (file) {
+	bytes_read = fread(value, 1, sizeof(value), file);
+	fclose(file);
+	if (bytes_read)
+	  speed = hwloc_linux_pci_link_speed_from_string(value);
+      }
+      snprintf(path, sizeof(path), "/sys/bus/pci/devices/%04x:%02x:%02x.%01x/current_link_width",
+	       domain, bus, dev, func);
+      file = fopen(path, "r");
+      if (file) {
+	bytes_read = fread(value, 1, sizeof(value), file);
+	fclose(file);
+	if (bytes_read)
+	  width = atoi(value);
+      }
+      obj->attr->pcidev.linkspeed = speed*width/8;
+#endif
+    }
 
     if (type == HWLOC_OBJ_BRIDGE) {
       if (hwloc_pcidisc_setup_bridge_attr(obj, config_space_cache) < 0)
@@ -274,7 +306,7 @@ hwloc_look_pci(struct hwloc_backend *backend)
       hwloc_obj_add_info(obj, "PCIDevice", devicename);
 
     hwloc_debug("  %04x:%02x:%02x.%01x %04x %04x:%04x %s %s\n",
-		domain, pcidev->bus, pcidev->dev, pcidev->func,
+		domain, bus, dev, func,
 		device_class, pcidev->vendor_id, pcidev->device_id,
 		vendorname && *vendorname ? vendorname : "??",
 		devicename && *devicename ? devicename : "??");
diff --git a/src/hwloc/hwloc/topology-solaris-chiptype.c b/src/hwloc/hwloc/topology-solaris-chiptype.c
index 1ab85b5..1b8e833 100644
--- a/src/hwloc/hwloc/topology-solaris-chiptype.c
+++ b/src/hwloc/hwloc/topology-solaris-chiptype.c
@@ -1,7 +1,7 @@
 /*
  * Copyright © 2009-2010 Oracle and/or its affiliates.  All rights reserved.
  * Copyright © 2013 Université Bordeaux.  All rights reserved.
- * Copyright © 2016-2017 Inria.  All rights reserved.
+ * Copyright © 2016-2018 Inria.  All rights reserved.
  *
  * $COPYRIGHT$
  *
@@ -150,8 +150,8 @@ Default values are for Unknown so we can build up from there.
 *****************************************************************************/
 
 static int  called_cpu_probe      = 0;
-static char dss_chip_type[PICL_PROPNAMELEN_MAX];
-static char dss_chip_model[PICL_PROPNAMELEN_MAX];
+static char dss_chip_type[PICL_PROPNAMELEN_MAX+1];
+static char dss_chip_model[PICL_PROPNAMELEN_MAX+1];
 static long dss_chip_mode         = MODE_UNKNOWN;
 
 struct hwloc_solaris_chip_info_s chip_info;
@@ -356,7 +356,7 @@ static int probe_cpu(picl_nodehdl_t node_hdl, void* dummy_arg __hwloc_attribute_
   unsigned int    index;
   int             int_val;
   int             val;
-  char            string_val[PICL_PROPNAMELEN_MAX];
+  char            string_val[PICL_PROPNAMELEN_MAX+1];
 
   val = picl_get_first_prop(node_hdl, &p_hdl);
   while (val == PICL_SUCCESS) {
diff --git a/src/hwloc/hwloc/topology-synthetic.c b/src/hwloc/hwloc/topology-synthetic.c
index ebe8eab..2fa7121 100644
--- a/src/hwloc/hwloc/topology-synthetic.c
+++ b/src/hwloc/hwloc/topology-synthetic.c
@@ -576,7 +576,6 @@ hwloc_backend_synthetic_init(struct hwloc_synthetic_backend_data_s *data,
       errno = EINVAL;
       goto error;
     }
-    data->level[count-1].arity = (unsigned)item;
 
     totalarity *= item;
     data->level[count].totalwidth = totalarity;
@@ -602,6 +601,7 @@ hwloc_backend_synthetic_init(struct hwloc_synthetic_backend_data_s *data,
       goto error;
     }
 
+    data->level[count-1].arity = (unsigned)item;
     count++;
   }
 
@@ -783,7 +783,7 @@ hwloc_backend_synthetic_init(struct hwloc_synthetic_backend_data_s *data,
 	  curlevel->attr.memorysize = 32*1024;
 	else
 	  /* *4 at each level, starting from 1MB for L2, unified */
-	  curlevel->attr.memorysize = 256*1024 << (2*curlevel->attr.depth);
+	  curlevel->attr.memorysize = 256ULL*1024 << (2*curlevel->attr.depth);
       }
 
     } else if (type == HWLOC_OBJ_NUMANODE && !curlevel->attr.memorysize) {
@@ -1162,8 +1162,8 @@ hwloc__export_synthetic_indexes(hwloc_obj_t *level, unsigned total,
   /* dump all indexes */
   cur = level[0];
   while (cur) {
-    res = snprintf(tmp, tmplen, "%u%s", cur->os_index,
-		   cur->next_cousin ? "," : ")");
+    res = hwloc_snprintf(tmp, tmplen, "%u%s", cur->os_index,
+			 cur->next_cousin ? "," : ")");
     if (hwloc__export_synthetic_update_status(&ret, &tmp, &tmplen, res) < 0)
       return -1;
     cur = cur->next_cousin;
@@ -1225,7 +1225,7 @@ hwloc__export_synthetic_obj_attr(struct hwloc_topology * topology,
 	level = topology->levels[obj->depth];
       }
 
-      res = snprintf(tmp, tmplen, "%sindexes=", prefix);
+      res = hwloc_snprintf(tmp, tmplen, "%sindexes=", prefix);
       if (hwloc__export_synthetic_update_status(&ret, &tmp, &tmplen, res) < 0)
 	return -1;
 
diff --git a/src/hwloc/hwloc/topology-windows.c b/src/hwloc/hwloc/topology-windows.c
index cb8e23c..d03645c 100644
--- a/src/hwloc/hwloc/topology-windows.c
+++ b/src/hwloc/hwloc/topology-windows.c
@@ -811,7 +811,7 @@ hwloc_look_windows(struct hwloc_backend *backend)
 
 	obj = hwloc_alloc_setup_object(topology, type, id);
         obj->cpuset = hwloc_bitmap_alloc();
-	hwloc_debug("%s#%u mask %lx\n", hwloc_obj_type_string(type), id, procInfo[i].ProcessorMask);
+	hwloc_debug("%s#%u mask %llx\n", hwloc_obj_type_string(type), id, (unsigned long long) procInfo[i].ProcessorMask);
 	/* ProcessorMask is a ULONG_PTR */
 	hwloc_bitmap_set_ith_ULONG_PTR(obj->cpuset, 0, procInfo[i].ProcessorMask);
 	hwloc_debug_2args_bitmap("%s#%u bitmap %s\n", hwloc_obj_type_string(type), id, obj->cpuset);
diff --git a/src/hwloc/hwloc/topology-x86.c b/src/hwloc/hwloc/topology-x86.c
index 425da4c..0509256 100644
--- a/src/hwloc/hwloc/topology-x86.c
+++ b/src/hwloc/hwloc/topology-x86.c
@@ -210,6 +210,7 @@ enum cpuid_type {
   intel,
   amd,
   zhaoxin,
+  hygon,
   unknown
 };
 
@@ -293,13 +294,13 @@ static void look_proc(struct hwloc_backend *backend, struct procinfo *infos, uns
   _extendedmodel  = (eax>>16) & 0xf;
   _family         = (eax>>8) & 0xf;
   _extendedfamily = (eax>>20) & 0xff;
-  if ((cpuid_type == intel || cpuid_type == amd) && _family == 0xf) {
+  if ((cpuid_type == intel || cpuid_type == amd || cpuid_type == hygon) && _family == 0xf) {
     infos->cpufamilynumber = _family + _extendedfamily;
   } else {
     infos->cpufamilynumber = _family;
   }
   if ((cpuid_type == intel && (_family == 0x6 || _family == 0xf))
-      || (cpuid_type == amd && _family == 0xf)
+      || ((cpuid_type == amd || cpuid_type == hygon) && _family == 0xf)
       || (cpuid_type == zhaoxin && (_family == 0x6 || _family == 0x7))) {
     infos->cpumodelnumber = _model + (_extendedmodel << 4);
   } else {
@@ -387,12 +388,13 @@ static void look_proc(struct hwloc_backend *backend, struct procinfo *infos, uns
       node_id = 0;
       nodes_per_proc = 1;
     } else {
+      /* AMD other families or Hygon family 18h */
       node_id = ecx & 0xff;
       nodes_per_proc = ((ecx >> 8) & 7) + 1;
     }
     infos->nodeid = node_id;
     if ((infos->cpufamilynumber == 0x15 && nodes_per_proc > 2)
-	|| (infos->cpufamilynumber == 0x17 && nodes_per_proc > 4)) {
+	|| ((infos->cpufamilynumber == 0x17 || infos->cpufamilynumber == 0x18) && nodes_per_proc > 4)) {
       hwloc_debug("warning: undefined nodes_per_proc value %u, assuming it means %u\n", nodes_per_proc, nodes_per_proc);
     }
 
@@ -492,7 +494,7 @@ static void look_proc(struct hwloc_backend *backend, struct procinfo *infos, uns
   /* Get thread/core + cache information from cpuid 0x04
    * (not supported on AMD)
    */
-  if (cpuid_type != amd && highest_cpuid >= 0x04) {
+  if ((cpuid_type != amd && cpuid_type != hygon) && highest_cpuid >= 0x04) {
     unsigned max_nbcores;
     unsigned max_nbthreads;
     unsigned level;
@@ -525,7 +527,9 @@ static void look_proc(struct hwloc_backend *backend, struct procinfo *infos, uns
     }
 
     tmpcaches = realloc(infos->cache, infos->numcaches * sizeof(*infos->cache));
-    if (tmpcaches) {
+    if (!tmpcaches) {
+     infos->numcaches = oldnumcaches;
+    } else {
      infos->cache = tmpcaches;
      cache = &infos->cache[oldnumcaches];
 
@@ -672,6 +676,15 @@ static void look_proc(struct hwloc_backend *backend, struct procinfo *infos, uns
 	cache->cacheid = (infos->apicid % legacy_max_log_proc) / cache->nbthreads_sharing /* cacheid within the package */
 	  + 2 * (infos->apicid / legacy_max_log_proc); /* add 2 cache per previous package */
       }
+    } else if (cpuid_type == hygon) {
+      if (infos->cpufamilynumber == 0x18
+	  && cache->level == 3 && cache->nbthreads_sharing == 6) {
+        /* Hygon family 0x18 always shares L3 between 8 APIC ids,
+         * even when only 6 APIC ids are enabled and reported in nbthreads_sharing
+         * (on 24-core CPUs).
+         */
+        cache->cacheid = infos->apicid / 8;
+      }
     }
   }
 
@@ -816,11 +829,11 @@ static void summarize(struct hwloc_backend *backend, struct procinfo *infos, int
   }
 
   if (hwloc_filter_check_keep_object_type(topology, HWLOC_OBJ_GROUP)) {
-    /* Look for Compute units inside packages */
     if (fulldiscovery) {
       hwloc_bitmap_t unit_cpuset;
       hwloc_obj_t unit;
 
+      /* Look for Compute units inside packages */
       hwloc_bitmap_copy(remaining_cpuset, complete_cpuset);
       while ((i = hwloc_bitmap_first(remaining_cpuset)) != (unsigned) -1) {
 	unsigned packageid = infos[i].packageid;
@@ -851,33 +864,33 @@ static void summarize(struct hwloc_backend *backend, struct procinfo *infos, int
 				unitid, unit_cpuset);
 	hwloc_insert_object_by_cpuset(topology, unit);
       }
-    }
 
-    /* Look for unknown objects */
-    if (infos[one].otherids) {
-      for (level = infos[one].levels-1; level <= infos[one].levels-1; level--) {
-	if (infos[one].otherids[level] != UINT_MAX) {
-	  hwloc_bitmap_t unknown_cpuset;
-	  hwloc_obj_t unknown_obj;
-
-	  hwloc_bitmap_copy(remaining_cpuset, complete_cpuset);
-	  while ((i = hwloc_bitmap_first(remaining_cpuset)) != (unsigned) -1) {
-	    unsigned unknownid = infos[i].otherids[level];
-
-	    unknown_cpuset = hwloc_bitmap_alloc();
-	    for (j = i; j < nbprocs; j++) {
-	      if (infos[j].otherids[level] == unknownid) {
-		hwloc_bitmap_set(unknown_cpuset, j);
-		hwloc_bitmap_clr(remaining_cpuset, j);
+      /* Look for unknown objects */
+      if (infos[one].otherids) {
+	for (level = infos[one].levels-1; level <= infos[one].levels-1; level--) {
+	  if (infos[one].otherids[level] != UINT_MAX) {
+	    hwloc_bitmap_t unknown_cpuset;
+	    hwloc_obj_t unknown_obj;
+
+	    hwloc_bitmap_copy(remaining_cpuset, complete_cpuset);
+	    while ((i = hwloc_bitmap_first(remaining_cpuset)) != (unsigned) -1) {
+	      unsigned unknownid = infos[i].otherids[level];
+
+	      unknown_cpuset = hwloc_bitmap_alloc();
+	      for (j = i; j < nbprocs; j++) {
+		if (infos[j].otherids[level] == unknownid) {
+		  hwloc_bitmap_set(unknown_cpuset, j);
+		  hwloc_bitmap_clr(remaining_cpuset, j);
+		}
 	      }
+	      unknown_obj = hwloc_alloc_setup_object(topology, HWLOC_OBJ_GROUP, unknownid);
+	      unknown_obj->cpuset = unknown_cpuset;
+	      unknown_obj->attr->group.kind = HWLOC_GROUP_KIND_INTEL_X2APIC_UNKNOWN;
+	      unknown_obj->attr->group.subkind = level;
+	      hwloc_debug_2args_bitmap("os unknown%u %u has cpuset %s\n",
+				       level, unknownid, unknown_cpuset);
+	      hwloc_insert_object_by_cpuset(topology, unknown_obj);
 	    }
-	    unknown_obj = hwloc_alloc_setup_object(topology, HWLOC_OBJ_GROUP, unknownid);
-	    unknown_obj->cpuset = unknown_cpuset;
-	    unknown_obj->attr->group.kind = HWLOC_GROUP_KIND_INTEL_X2APIC_UNKNOWN;
-	    unknown_obj->attr->group.subkind = level;
-	    hwloc_debug_2args_bitmap("os unknown%u %u has cpuset %s\n",
-				     level, unknownid, unknown_cpuset);
-	    hwloc_insert_object_by_cpuset(topology, unknown_obj);
 	  }
 	}
       }
@@ -1122,6 +1135,11 @@ static void hwloc_x86_os_state_restore(hwloc_x86_os_state_t *state __hwloc_attri
 #define AMD_EDX ('e' | ('n'<<8) | ('t'<<16) | ('i'<<24))
 #define AMD_ECX ('c' | ('A'<<8) | ('M'<<16) | ('D'<<24))
 
+/* HYGON "HygonGenuine" */
+#define HYGON_EBX ('H' | ('y'<<8) | ('g'<<16) | ('o'<<24))
+#define HYGON_EDX ('n' | ('G'<<8) | ('e'<<16) | ('n'<<24))
+#define HYGON_ECX ('u' | ('i'<<8) | ('n'<<16) | ('e'<<24))
+
 /* (Zhaoxin) CentaurHauls */
 #define ZX_EBX ('C' | ('e'<<8) | ('n'<<16) | ('t'<<24))
 #define ZX_EDX ('a' | ('u'<<8) | ('r'<<16) | ('H'<<24))
@@ -1221,6 +1239,8 @@ int hwloc_look_x86(struct hwloc_backend *backend, int fulldiscovery)
   else if ((ebx == ZX_EBX && ecx == ZX_ECX && edx == ZX_EDX)
 	   || (ebx == SH_EBX && ecx == SH_ECX && edx == SH_EDX))
     cpuid_type = zhaoxin;
+  else if (ebx == HYGON_EBX && ecx == HYGON_ECX && edx == HYGON_EDX)
+    cpuid_type = hygon;
 
   hwloc_debug("highest cpuid %x, cpuid type %u\n", highest_cpuid, cpuid_type);
   if (highest_cpuid < 0x01) {
@@ -1362,14 +1382,15 @@ fulldiscovery:
 static int
 hwloc_x86_check_cpuiddump_input(const char *src_cpuiddump_path, hwloc_bitmap_t set)
 {
-#if !(defined HWLOC_WIN_SYS && !defined __MINGW32__) /* needs a lot of work */
+
+#if !(defined HWLOC_WIN_SYS && !defined __MINGW32__ && !defined __CYGWIN__) /* needs a lot of work */
   struct dirent *dirent;
   DIR *dir;
   FILE *file;
   char line [32];
 
   dir = opendir(src_cpuiddump_path);
-  if (!dir)
+  if (!dir) 
     return -1;
 
   char path[strlen(src_cpuiddump_path) + strlen("/hwloc-cpuid-info") + 1];
diff --git a/src/hwloc/hwloc/topology-xml-libxml.c b/src/hwloc/hwloc/topology-xml-libxml.c
index d087678..da3e89c 100644
--- a/src/hwloc/hwloc/topology-xml-libxml.c
+++ b/src/hwloc/hwloc/topology-xml-libxml.c
@@ -502,6 +502,11 @@ hwloc_libxml_export_buffer(hwloc_topology_t topology, struct hwloc__xml_export_d
   xmlDocDumpFormatMemoryEnc(doc, (xmlChar **)xmlbuffer, buflen, "UTF-8", 1);
   xmlFreeDoc(doc);
   hwloc_libxml2_cleanup();
+  if (!*xmlbuffer) {
+    *buflen = 0;
+    return -1;
+  }
+  *buflen += 1; /* ending \0 was added but not counted in the length */
   return 0;
 }
 
@@ -571,6 +576,11 @@ hwloc_libxml_export_diff_buffer(hwloc_topology_diff_t diff, const char *refname,
   xmlDocDumpFormatMemoryEnc(doc, (xmlChar **)xmlbuffer, buflen, "UTF-8", 1);
   xmlFreeDoc(doc);
   hwloc_libxml2_cleanup();
+  if (!*xmlbuffer) {
+    *buflen = 0;
+    return -1;
+  }
+  *buflen += 1; /* ending \0 was added but not counted in the length */
   return 0;
 }
 
diff --git a/src/hwloc/hwloc/topology-xml-nolibxml.c b/src/hwloc/hwloc/topology-xml-nolibxml.c
index 4042968..5a0d02d 100644
--- a/src/hwloc/hwloc/topology-xml-nolibxml.c
+++ b/src/hwloc/hwloc/topology-xml-nolibxml.c
@@ -416,11 +416,12 @@ hwloc_nolibxml_backend_init(struct hwloc_xml_backend_data_s *bdata,
   bdata->data = nbdata;
 
   if (xmlbuffer) {
-    nbdata->buffer = malloc(xmlbuflen);
+    nbdata->buffer = malloc(xmlbuflen+1);
     if (!nbdata->buffer)
       goto out_with_nbdata;
-    nbdata->buflen = xmlbuflen;
+    nbdata->buflen = xmlbuflen+1;
     memcpy(nbdata->buffer, xmlbuffer, xmlbuflen);
+    nbdata->buffer[xmlbuflen] = '\0';
 
   } else {
     int err = hwloc_nolibxml_read_file(xmlpath, &nbdata->buffer, &nbdata->buflen);
@@ -429,9 +430,10 @@ hwloc_nolibxml_backend_init(struct hwloc_xml_backend_data_s *bdata,
   }
 
   /* allocate a temporary copy buffer that we may modify during parsing */
-  nbdata->copy = malloc(nbdata->buflen);
+  nbdata->copy = malloc(nbdata->buflen+1);
   if (!nbdata->copy)
     goto out_with_buffer;
+  nbdata->copy[nbdata->buflen] = '\0';
 
   bdata->look_init = hwloc_nolibxml_look_init;
   bdata->look_done = hwloc_nolibxml_look_done;
@@ -498,7 +500,7 @@ hwloc_nolibxml_import_diff(struct hwloc__xml_import_state_s *state,
   ret = hwloc__nolibxml_import_find_child(state, &childstate, &tag);
   if (ret < 0)
     goto out_with_buffer;
-  if (strcmp(tag, "topologydiff"))
+  if (!tag || strcmp(tag, "topologydiff"))
     goto out_with_buffer;
 
   while (1) {
@@ -523,6 +525,7 @@ hwloc_nolibxml_import_diff(struct hwloc__xml_import_state_s *state,
 
 out_with_buffer:
   free(buffer);
+  free(refname);
 out:
   return -1;
 }
@@ -714,7 +717,7 @@ hwloc___nolibxml_prepare_export(hwloc_topology_t topology, struct hwloc__xml_exp
   hwloc__xml_export_topology (&childstate, topology, flags);
   hwloc__nolibxml_export_end_object(&childstate, "topology");
 
-  return ndata->written+1;
+  return ndata->written+1; /* ending \0 */
 }
 
 static int
diff --git a/src/hwloc/hwloc/topology-xml.c b/src/hwloc/hwloc/topology-xml.c
index cfa90f8..3e1dbc0 100644
--- a/src/hwloc/hwloc/topology-xml.c
+++ b/src/hwloc/hwloc/topology-xml.c
@@ -2,7 +2,7 @@
  * Copyright © 2009 CNRS
  * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2011 Université Bordeaux
- * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.
+ * Copyright © 2009-2018 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -598,8 +598,11 @@ hwloc__xml_v1import_distances(struct hwloc_xml_backend_data_s *data,
       matrix[i] = val * latbase;
 
       ret = state->global->close_tag(&childstate);
-      if (ret < 0)
+      if (ret < 0) {
+	free(matrix);
+	free(v1dist);
 	return -1;
+      }
 
       state->global->close_child(&childstate);
     }
@@ -1804,18 +1807,18 @@ hwloc_topology_diff_load_xml(const char *xmlpath,
   struct hwloc__xml_import_state_s state;
   struct hwloc_xml_backend_data_s fakedata; /* only for storing global info during parsing */
   hwloc_localeswitch_declare;
-  const char *basename;
+  const char *local_basename;
   int force_nolibxml;
   int ret;
 
   state.global = &fakedata;
 
-  basename = strrchr(xmlpath, '/');
-  if (basename)
-    basename++;
+  local_basename = strrchr(xmlpath, '/');
+  if (local_basename)
+    local_basename++;
   else
-    basename = xmlpath;
-  fakedata.msgprefix = strdup(basename);
+    local_basename = xmlpath;
+  fakedata.msgprefix = strdup(local_basename);
 
   hwloc_components_init();
   assert(hwloc_nolibxml_callbacks);
@@ -2732,7 +2735,7 @@ hwloc_xml_component_instantiate(struct hwloc_disc_component *component,
   const char * xmlpath = (const char *) _data1;
   const char * xmlbuffer = (const char *) _data2;
   int xmlbuflen = (int)(uintptr_t) _data3;
-  const char *basename;
+  const char *local_basename;
   int err;
 
   assert(hwloc_nolibxml_callbacks); /* the core called components_init() for the component's topology */
@@ -2764,15 +2767,15 @@ hwloc_xml_component_instantiate(struct hwloc_disc_component *component,
   backend->is_thissystem = 0;
 
   if (xmlpath) {
-    basename = strrchr(xmlpath, '/');
-    if (basename)
-      basename++;
+    local_basename = strrchr(xmlpath, '/');
+    if (local_basename)
+      local_basename++;
     else
-      basename = xmlpath;
+      local_basename = xmlpath;
   } else {
-    basename = "xmlbuffer";
+    local_basename = "xmlbuffer";
   }
-  data->msgprefix = strdup(basename);
+  data->msgprefix = strdup(local_basename);
 
   force_nolibxml = hwloc_nolibxml_import();
 retry:
diff --git a/src/hwloc/hwloc/topology.c b/src/hwloc/hwloc/topology.c
index fb88c39..6e51aa4 100644
--- a/src/hwloc/hwloc/topology.c
+++ b/src/hwloc/hwloc/topology.c
@@ -74,26 +74,28 @@ int hwloc_hide_errors(void)
 
 void hwloc_report_os_error(const char *msg, int line)
 {
-    static int reported = 0;
-
-    if (!reported && !hwloc_hide_errors()) {
-        fprintf(stderr, "****************************************************************************\n");
-        fprintf(stderr, "* hwloc %s has encountered what looks like an error from the operating system.\n", HWLOC_VERSION);
-        fprintf(stderr, "*\n");
-        fprintf(stderr, "* %s\n", msg);
-        fprintf(stderr, "* Error occurred in topology.c line %d\n", line);
-        fprintf(stderr, "*\n");
-        fprintf(stderr, "* The following FAQ entry in the hwloc documentation may help:\n");
-        fprintf(stderr, "*   What should I do when hwloc reports \"operating system\" warnings?\n");
-        fprintf(stderr, "* Otherwise please report this error message to the hwloc user's mailing list,\n");
+  static int reported = 0;
+
+  if (!reported && !hwloc_hide_errors()) {
+    fprintf(stderr, "****************************************************************************\n");
+    fprintf(stderr, "* hwloc %s received invalid information from the operating system.\n", HWLOC_VERSION);
+    fprintf(stderr, "*\n");
+    fprintf(stderr, "* %s\n", msg);
+    fprintf(stderr, "* Error occurred in topology.c line %d\n", line);
+    fprintf(stderr, "*\n");
+    fprintf(stderr, "* The following FAQ entry in the hwloc documentation may help:\n");
+    fprintf(stderr, "*   What should I do when hwloc reports \"operating system\" warnings?\n");
+    fprintf(stderr, "* Otherwise please report this error message to the hwloc user's mailing list,\n");
 #ifdef HWLOC_LINUX_SYS
-        fprintf(stderr, "* along with the files generated by the hwloc-gather-topology script.\n");
+    fprintf(stderr, "* along with the files generated by the hwloc-gather-topology script.\n");
 #else
-	fprintf(stderr, "* along with any relevant topology information from your platform.\n");
+    fprintf(stderr, "* along with any relevant topology information from your platform.\n");
 #endif
-        fprintf(stderr, "****************************************************************************\n");
-        reported = 1;
-    }
+    fprintf(stderr, "* \n");
+    fprintf(stderr, "* hwloc will now ignore this invalid topology information and continue.\n");
+    fprintf(stderr, "****************************************************************************\n");
+    reported = 1;
+  }
 }
 
 #if defined(HAVE_SYSCTLBYNAME)
@@ -235,7 +237,7 @@ hwloc_setup_pu_level(struct hwloc_topology *topology,
 static void
 hwloc_debug_print_object(int indent __hwloc_attribute_unused, hwloc_obj_t obj)
 {
-  char type[64], idx[10], attr[1024], *cpuset = NULL;
+  char type[64], idx[12], attr[1024], *cpuset = NULL;
   hwloc_debug("%*s", 2*indent, "");
   hwloc_obj_type_snprintf(type, sizeof(type), obj, 1);
   if (obj->os_index != HWLOC_UNKNOWN_INDEX)
@@ -1377,7 +1379,7 @@ hwloc___insert_object_by_cpuset(struct hwloc_topology *topology, hwloc_obj_t cur
         if (report_error) {
 	  char childstr[512];
 	  char objstr[512];
-	  char msg[1024];
+	  char msg[1100];
 	  hwloc__report_error_format_obj(objstr, sizeof(objstr), obj);
 	  hwloc__report_error_format_obj(childstr, sizeof(childstr), child);
 	  snprintf(msg, sizeof(msg), "%s intersects with %s without inclusion!", objstr, childstr);
@@ -3131,11 +3133,19 @@ next_noncpubackend:
   hwloc_filter_bridges(topology, topology->levels[0][0]);
   hwloc_debug_print_objects(0, topology->levels[0][0]);
 
-  hwloc_debug("%s", "\nRemoving empty objects except numa nodes and PCI devices\n");
+  hwloc_debug("%s", "\nRemoving empty objects\n");
   remove_empty(topology, &topology->levels[0][0]);
-    if (!topology->levels[0][0]) {
+  if (!topology->levels[0][0]) {
     fprintf(stderr, "Topology became empty, aborting!\n");
-    abort();
+    return -1;
+  }
+  if (hwloc_bitmap_iszero(topology->levels[0][0]->cpuset)) {
+    fprintf(stderr, "Topology does not contain any PU, aborting!\n");
+    return -1;
+  }
+  if (hwloc_bitmap_iszero(topology->levels[0][0]->nodeset)) {
+    fprintf(stderr, "Topology does not contain any NUMA node, aborting!\n");
+    return -1;
   }
   hwloc_debug_print_objects(0, topology->levels[0][0]);
 
@@ -3671,8 +3681,13 @@ restrict_object_by_cpuset(hwloc_topology_t topology, unsigned long flags, hwloc_
   if (modified) {
     for_each_child_safe(child, obj, pchild)
       restrict_object_by_cpuset(topology, flags, pchild, droppedcpuset, droppednodeset);
+    /* if some hwloc_bitmap_first(child->complete_cpuset) changed, children might need to be reordered */
+    hwloc__reorder_children(obj);
+
     for_each_memory_child_safe(child, obj, pchild)
       restrict_object_by_cpuset(topology, flags, pchild, droppedcpuset, droppednodeset);
+    /* local NUMA nodes have the same cpusets, no need to reorder them */
+
     /* Nothing to restrict under I/O or Misc */
   }
 
diff --git a/src/hwloc/hwloc/traversal.c b/src/hwloc/hwloc/traversal.c
index f5d610a..9c5e626 100644
--- a/src/hwloc/hwloc/traversal.c
+++ b/src/hwloc/hwloc/traversal.c
@@ -442,7 +442,7 @@ hwloc_obj_type_snprintf(char * __hwloc_restrict string, size_t size, hwloc_obj_t
     else
       return hwloc_snprintf(string, size, "%s", hwloc_obj_type_string(type));
   case HWLOC_OBJ_BRIDGE:
-    return snprintf(string, size, obj->attr->bridge.upstream_type == HWLOC_OBJ_BRIDGE_PCI ? "PCIBridge" : "HostBridge");
+    return hwloc_snprintf(string, size, obj->attr->bridge.upstream_type == HWLOC_OBJ_BRIDGE_PCI ? "PCIBridge" : "HostBridge");
   case HWLOC_OBJ_PCI_DEVICE:
     return hwloc_snprintf(string, size, "PCI");
   case HWLOC_OBJ_OS_DEVICE:
@@ -561,9 +561,9 @@ hwloc_obj_attr_snprintf(char * __hwloc_restrict string, size_t size, hwloc_obj_t
       snprintf(down, sizeof(down), "buses=%04x:[%02x-%02x]",
 	       obj->attr->bridge.downstream.pci.domain, obj->attr->bridge.downstream.pci.secondary_bus, obj->attr->bridge.downstream.pci.subordinate_bus);
       if (*up)
-	res = snprintf(string, size, "%s%s%s", up, separator, down);
+	res = hwloc_snprintf(string, size, "%s%s%s", up, separator, down);
       else
-	res = snprintf(string, size, "%s", down);
+	res = hwloc_snprintf(string, size, "%s", down);
     }
     break;
   case HWLOC_OBJ_PCI_DEVICE:
@@ -571,10 +571,10 @@ hwloc_obj_attr_snprintf(char * __hwloc_restrict string, size_t size, hwloc_obj_t
       char linkspeed[64]= "";
       if (obj->attr->pcidev.linkspeed)
         snprintf(linkspeed, sizeof(linkspeed), "%slink=%.2fGB/s", separator, obj->attr->pcidev.linkspeed);
-      res = snprintf(string, size, "busid=%04x:%02x:%02x.%01x%sid=%04x:%04x%sclass=%04x(%s)%s",
-		     obj->attr->pcidev.domain, obj->attr->pcidev.bus, obj->attr->pcidev.dev, obj->attr->pcidev.func, separator,
-		     obj->attr->pcidev.vendor_id, obj->attr->pcidev.device_id, separator,
-		     obj->attr->pcidev.class_id, hwloc_pci_class_string(obj->attr->pcidev.class_id), linkspeed);
+      res = hwloc_snprintf(string, size, "busid=%04x:%02x:%02x.%01x%sid=%04x:%04x%sclass=%04x(%s)%s",
+			   obj->attr->pcidev.domain, obj->attr->pcidev.bus, obj->attr->pcidev.dev, obj->attr->pcidev.func, separator,
+			   obj->attr->pcidev.vendor_id, obj->attr->pcidev.device_id, separator,
+			   obj->attr->pcidev.class_id, hwloc_pci_class_string(obj->attr->pcidev.class_id), linkspeed);
     }
     break;
   default:
diff --git a/src/hwloc/include/Makefile.am b/src/hwloc/include/Makefile.am
index 1b79404..1b2017b 100644
--- a/src/hwloc/include/Makefile.am
+++ b/src/hwloc/include/Makefile.am
@@ -1,4 +1,4 @@
-# Copyright © 2009-2017 Inria.  All rights reserved.
+# Copyright © 2009-2018 Inria.  All rights reserved.
 # Copyright © 2009-2010 Université Bordeaux
 # Copyright © 2009-2014 Cisco Systems, Inc.  All rights reserved.
 # Copyright © 2011      Oracle and/or its affiliates.  All rights reserved.
@@ -42,6 +42,7 @@ noinst_HEADERS = \
         private/misc.h \
         private/xml.h \
         private/components.h \
+        private/internal-components.h \
         private/cpuid-x86.h \
         private/netloc.h \
         netloc/utarray.h \
diff --git a/src/hwloc/include/hwloc.h b/src/hwloc/include/hwloc.h
index ce475cb..38117e4 100644
--- a/src/hwloc/include/hwloc.h
+++ b/src/hwloc/include/hwloc.h
@@ -87,6 +87,10 @@ extern "C" {
  *
  * Users may check for available features at build time using this number
  * (see \ref faq_upgrade).
+ *
+ * \note This should not be confused with HWLOC_VERSION, the library version.
+ * Two stable releases of the same series usually have the same ::HWLOC_API_VERSION
+ * even if their HWLOC_VERSION are different.
  */
 #define HWLOC_API_VERSION 0x00020000
 
@@ -1025,10 +1029,13 @@ HWLOC_DECLSPEC int hwloc_obj_add_info(hwloc_obj_t obj, const char *name, const c
 
 /** \defgroup hwlocality_cpubinding CPU binding
  *
- * It is often useful to call hwloc_bitmap_singlify() first so that a single CPU
- * remains in the set. This way, the process will not even migrate between
- * different CPUs inside the given set.
- * Some operating systems also only support that kind of binding.
+ * Some operating systems only support binding threads or processes to a single PU.
+ * Others allow binding to larger sets such as entire Cores or Packages or
+ * even random sets of invididual PUs. In such operating system, the scheduler
+ * is free to run the task on one of these PU, then migrate it to another PU, etc.
+ * It is often useful to call hwloc_bitmap_singlify() on the target CPU set before
+ * passing it to the binding function to avoid these expensive migrations.
+ * See the documentation of hwloc_bitmap_singlify() for details.
  *
  * Some operating systems do not provide all hwloc-supported
  * mechanisms to bind processes, threads, etc.
diff --git a/src/hwloc/include/hwloc/autogen/config.h.in b/src/hwloc/include/hwloc/autogen/config.h.in
index 58fa76e..e479efc 100644
--- a/src/hwloc/include/hwloc/autogen/config.h.in
+++ b/src/hwloc/include/hwloc/autogen/config.h.in
@@ -1,6 +1,6 @@
 /* -*- c -*-
  * Copyright © 2009 CNRS
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2012 Université Bordeaux
  * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -11,6 +11,12 @@
 #ifndef HWLOC_CONFIG_H
 #define HWLOC_CONFIG_H
 
+#undef HWLOC_VERSION
+#undef HWLOC_VERSION_MAJOR
+#undef HWLOC_VERSION_MINOR
+#undef HWLOC_VERSION_RELEASE
+#undef HWLOC_VERSION_GREEK
+
 #if (__GNUC__ > 2 || (__GNUC__ == 2 && __GNUC_MINOR__ >= 95))
 # define __hwloc_restrict __restrict
 #else
@@ -127,6 +133,7 @@
 # define __hwloc_attribute_pure
 #endif
 
+#ifndef __hwloc_attribute_deprecated /* allow the user to disable these warnings by defining this macro to nothing */
 #ifdef HWLOC_HAVE_ATTRIBUTE_DEPRECATED
 #define __HWLOC_HAVE_ATTRIBUTE_DEPRECATED HWLOC_HAVE_ATTRIBUTE_DEPRECATED 
 #elif defined(__GNUC__)
@@ -139,6 +146,7 @@
 #else
 # define __hwloc_attribute_deprecated
 #endif
+#endif
 
 #ifdef HWLOC_HAVE_ATTRIBUTE_MAY_ALIAS
 #define __HWLOC_HAVE_ATTRIBUTE_MAY_ALIAS HWLOC_HAVE_ATTRIBUTE_MAY_ALIAS
diff --git a/src/hwloc/include/hwloc/bitmap.h b/src/hwloc/include/hwloc/bitmap.h
index d8adf0b..bae623c 100644
--- a/src/hwloc/include/hwloc/bitmap.h
+++ b/src/hwloc/include/hwloc/bitmap.h
@@ -1,6 +1,6 @@
 /*
  * Copyright © 2009 CNRS
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2012 Université Bordeaux
  * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -24,19 +24,31 @@ extern "C" {
 
 /** \defgroup hwlocality_bitmap The bitmap API
  *
- * The ::hwloc_bitmap_t type represents a set of objects, typically OS
- * processors -- which may actually be hardware threads (represented
- * by ::hwloc_cpuset_t, which is a typedef for ::hwloc_bitmap_t) -- or
- * memory nodes (represented by ::hwloc_nodeset_t, which is also a
- * typedef for ::hwloc_bitmap_t).
- *
- * <em>Both CPU and node sets are always indexed by OS physical number.</em>
- *
- * \note CPU sets and nodesets are described in \ref hwlocality_object_sets.
- *
+ * The ::hwloc_bitmap_t type represents a set of integers (positive or null).
  * A bitmap may be of infinite size (all bits are set after some point).
  * A bitmap may even be full if all bits are set.
  *
+ * Bitmaps are used by hwloc for sets of OS processors
+ * (which may actually be hardware threads) as by ::hwloc_cpuset_t
+ * (a typedef for ::hwloc_bitmap_t), or sets of NUMA memory nodes
+ * as ::hwloc_nodeset_t (also a typedef for ::hwloc_bitmap_t).
+ * Those are used for cpuset and nodeset fields in the ::hwloc_obj structure,
+ * see \ref hwlocality_object_sets.
+ *
+ * <em>Both CPU and node sets are always indexed by OS physical number.</em>
+ * However users should usually not build CPU and node sets manually
+ * (e.g. with hwloc_bitmap_set()).
+ * One should rather use existing object sets and combine them with
+ * hwloc_bitmap_or(), etc.
+ * For instance, binding the current thread on a pair of cores may be performed with:
+ * \code
+ * hwloc_obj_t core1 = ... , core2 = ... ;
+ * hwloc_bitmap_t set = hwloc_bitmap_alloc();
+ * hwloc_bitmap_or(set, core1->cpuset, core2->cpuset);
+ * hwloc_set_cpubind(topology, set, HWLOC_CPUBIND_THREAD);
+ * hwloc_bitmap_free(set);
+ * \endcode
+ *
  * \note Most functions below return an int that may be negative in case of
  * error. The usual error case would be an internal failure to realloc/extend
  * the storage of the bitmap (\p errno would be set to \c ENOMEM).
@@ -217,6 +229,19 @@ HWLOC_DECLSPEC int hwloc_bitmap_clr_range(hwloc_bitmap_t bitmap, unsigned begin,
  * May be useful before binding so that the process does not
  * have a chance of migrating between multiple logical CPUs
  * in the original mask.
+ * Instead of running the task on any PU inside the given CPU set,
+ * the operating system scheduler will be forced to run it on a single
+ * of these PUs.
+ * It avoids a migration overhead and cache-line ping-pongs between PUs.
+ *
+ * \note This function is NOT meant to distribute multiple processes
+ * within a single CPU set. It always return the same single bit when
+ * called multiple times on the same input set. hwloc_distrib() may
+ * be used for generating CPU sets to distribute multiple tasks below
+ * a single multi-PU object.
+ *
+ * \note This function cannot be applied to an object set directly. It
+ * should be applied to a copy (which may be obtained with hwloc_bitmap_dup()).
  */
 HWLOC_DECLSPEC int hwloc_bitmap_singlify(hwloc_bitmap_t bitmap);
 
@@ -231,14 +256,22 @@ HWLOC_DECLSPEC unsigned long hwloc_bitmap_to_ulong(hwloc_const_bitmap_t bitmap)
 /** \brief Convert the \p i -th subset of bitmap \p bitmap into unsigned long mask */
 HWLOC_DECLSPEC unsigned long hwloc_bitmap_to_ith_ulong(hwloc_const_bitmap_t bitmap, unsigned i) __hwloc_attribute_pure;
 
-/** \brief Test whether index \p id is part of bitmap \p bitmap */
+/** \brief Test whether index \p id is part of bitmap \p bitmap.
+ *
+ * \return 1 if the bit at index \p id is set in bitmap \p bitmap, 0 otherwise.
+ */
 HWLOC_DECLSPEC int hwloc_bitmap_isset(hwloc_const_bitmap_t bitmap, unsigned id) __hwloc_attribute_pure;
 
-/** \brief Test whether bitmap \p bitmap is empty */
+/** \brief Test whether bitmap \p bitmap is empty
+ *
+ * \return 1 if bitmap is empty, 0 otherwise.
+ */
 HWLOC_DECLSPEC int hwloc_bitmap_iszero(hwloc_const_bitmap_t bitmap) __hwloc_attribute_pure;
 
 /** \brief Test whether bitmap \p bitmap is completely full
  *
+ * \return 1 if bitmap is full, 0 otherwise.
+ *
  * \note A full bitmap is always infinitely set.
  */
 HWLOC_DECLSPEC int hwloc_bitmap_isfull(hwloc_const_bitmap_t bitmap) __hwloc_attribute_pure;
@@ -365,22 +398,42 @@ HWLOC_DECLSPEC int hwloc_bitmap_not (hwloc_bitmap_t res, hwloc_const_bitmap_t bi
  * Comparing bitmaps.
  */
 
-/** \brief Test whether bitmaps \p bitmap1 and \p bitmap2 intersects */
+/** \brief Test whether bitmaps \p bitmap1 and \p bitmap2 intersects.
+ *
+ * \return 1 if bitmaps intersect, 0 otherwise.
+ */
 HWLOC_DECLSPEC int hwloc_bitmap_intersects (hwloc_const_bitmap_t bitmap1, hwloc_const_bitmap_t bitmap2) __hwloc_attribute_pure;
 
 /** \brief Test whether bitmap \p sub_bitmap is part of bitmap \p super_bitmap.
  *
+ * \return 1 if \p sub_bitmap is included in \p super_bitmap, 0 otherwise.
+ *
  * \note The empty bitmap is considered included in any other bitmap.
  */
 HWLOC_DECLSPEC int hwloc_bitmap_isincluded (hwloc_const_bitmap_t sub_bitmap, hwloc_const_bitmap_t super_bitmap) __hwloc_attribute_pure;
 
-/** \brief Test whether bitmap \p bitmap1 is equal to bitmap \p bitmap2 */
+/** \brief Test whether bitmap \p bitmap1 is equal to bitmap \p bitmap2.
+ *
+ * \return 1 if bitmaps are equal, 0 otherwise.
+ */
 HWLOC_DECLSPEC int hwloc_bitmap_isequal (hwloc_const_bitmap_t bitmap1, hwloc_const_bitmap_t bitmap2) __hwloc_attribute_pure;
 
 /** \brief Compare bitmaps \p bitmap1 and \p bitmap2 using their lowest index.
  *
- * Smaller least significant bit is smaller.
- * The empty bitmap is considered higher than anything.
+ * A bitmap is considered smaller if its least significant bit is smaller.
+ * The empty bitmap is considered higher than anything (because its least significant bit does not exist).
+ *
+ * \return -1 if \p bitmap1 is considered smaller than \p bitmap2.
+ * \return 1 if \p bitmap1 is considered larger than \p bitmap2.
+ *
+ * For instance comparing binary bitmaps 0011 and 0110 returns -1
+ * (hence 0011 is considered smaller than 0110)
+ * because least significant bit of 0011 (0001) is smaller than least significant bit of 0110 (0010).
+ * Comparing 01001 and 00110 would also return -1 for the same reason.
+ *
+ * \return 0 if bitmaps are considered equal, even if they are not strictly equal.
+ * They just need to have the same least significant bit.
+ * For instance, comparing binary bitmaps 0010 and 0110 returns 0 because they have the same least significant bit.
  */
 HWLOC_DECLSPEC int hwloc_bitmap_compare_first(hwloc_const_bitmap_t bitmap1, hwloc_const_bitmap_t bitmap2) __hwloc_attribute_pure;
 
@@ -390,6 +443,14 @@ HWLOC_DECLSPEC int hwloc_bitmap_compare_first(hwloc_const_bitmap_t bitmap1, hwlo
  * Compare last indexes first, then second, etc.
  * The empty bitmap is considered lower than anything.
  *
+ * \return -1 if \p bitmap1 is considered smaller than \p bitmap2.
+ * \return 1 if \p bitmap1 is considered larger than \p bitmap2.
+ * \return 0 if bitmaps are equal (contrary to hwloc_bitmap_compare_first()).
+ *
+ * For instance comparing binary bitmaps 0011 and 0110 returns -1
+ * (hence 0011 is considered smaller than 0110).
+ * Comparing 00101 and 01010 returns -1 too.
+ *
  * \note This is different from the non-existing hwloc_bitmap_compare_last()
  * which would only compare the highest index of each bitmap.
  */
diff --git a/src/hwloc/include/hwloc/diff.h b/src/hwloc/include/hwloc/diff.h
index 3588d26..79f2df3 100644
--- a/src/hwloc/include/hwloc/diff.h
+++ b/src/hwloc/include/hwloc/diff.h
@@ -1,5 +1,5 @@
 /*
- * Copyright © 2013-2017 Inria.  All rights reserved.
+ * Copyright © 2013-2018 Inria.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -43,6 +43,8 @@ extern "C" {
  * More complex differences such as adding or removing objects cannot
  * be represented in the difference structures and therefore return
  * errors.
+ * Differences between object sets or topology-wide allowed sets,
+ * cannot be represented either.
  *
  * It means that there is no need to apply the difference when
  * looking at the tree organization (how many levels, how many
@@ -269,6 +271,9 @@ HWLOC_DECLSPEC int hwloc_topology_diff_load_xmlbuffer(const char *xmlbuffer, int
  * that contains the reference topology.
  * This attribute is given back when reading the diff from XML.
  *
+ * The returned buffer ends with a \0 that is included in the returned
+ * length.
+ *
  * \note The XML buffer should later be freed with hwloc_free_xmlbuffer().
  */
 HWLOC_DECLSPEC int hwloc_topology_diff_export_xmlbuffer(hwloc_topology_diff_t diff, const char *refname, char **xmlbuffer, int *buflen);
diff --git a/src/hwloc/include/hwloc/export.h b/src/hwloc/include/hwloc/export.h
index c7691c0..b178b77 100644
--- a/src/hwloc/include/hwloc/export.h
+++ b/src/hwloc/include/hwloc/export.h
@@ -1,5 +1,5 @@
 /*
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2012 Université Bordeaux
  * Copyright © 2009-2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -86,6 +86,9 @@ HWLOC_DECLSPEC int hwloc_topology_export_xml(hwloc_topology_t topology, const ch
  * back by a process using hwloc 1.x, one should consider detecting
  * it at runtime and using the corresponding export format.
  *
+ * The returned buffer ends with a \0 that is included in the returned
+ * length.
+ *
  * \p flags is a OR'ed set of ::hwloc_topology_export_xml_flags_e.
  *
  * \return -1 if a failure occured.
diff --git a/src/hwloc/include/hwloc/helper.h b/src/hwloc/include/hwloc/helper.h
index 25ca600..57a7643 100644
--- a/src/hwloc/include/hwloc/helper.h
+++ b/src/hwloc/include/hwloc/helper.h
@@ -367,7 +367,13 @@ hwloc_get_next_obj_covering_cpuset_by_type(hwloc_topology_t topology, hwloc_cons
  * package has fewer caches than its peers.
  */
 
-/** \brief Returns the ancestor object of \p obj at depth \p depth. */
+/** \brief Returns the ancestor object of \p obj at depth \p depth.
+ *
+ * \note \p depth should not be the depth of PU or NUMA objects
+ * since they are ancestors of no objects (except Misc or I/O).
+ * This function rather expects an intermediate level depth,
+ * such as the depth of Packages, Cores, or Caches.
+ */
 static __hwloc_inline hwloc_obj_t
 hwloc_get_ancestor_obj_by_depth (hwloc_topology_t topology __hwloc_attribute_unused, int depth, hwloc_obj_t obj) __hwloc_attribute_pure;
 static __hwloc_inline hwloc_obj_t
@@ -381,7 +387,13 @@ hwloc_get_ancestor_obj_by_depth (hwloc_topology_t topology __hwloc_attribute_unu
   return ancestor;
 }
 
-/** \brief Returns the ancestor object of \p obj with type \p type. */
+/** \brief Returns the ancestor object of \p obj with type \p type.
+ *
+ * \note \p type should not be ::HWLOC_OBJ_PU or ::HWLOC_OBJ_NUMANODE
+ * since these objects are ancestors of no objects (except Misc or I/O).
+ * This function rather expects an intermediate object type,
+ * such as ::HWLOC_OBJ_PACKAGE, ::HWLOC_OBJ_CORE, etc.
+ */
 static __hwloc_inline hwloc_obj_t
 hwloc_get_ancestor_obj_by_type (hwloc_topology_t topology __hwloc_attribute_unused, hwloc_obj_type_t type, hwloc_obj_t obj) __hwloc_attribute_pure;
 static __hwloc_inline hwloc_obj_t
diff --git a/src/hwloc/include/hwloc/rename.h b/src/hwloc/include/hwloc/rename.h
index 04d6a64..7cef1b2 100644
--- a/src/hwloc/include/hwloc/rename.h
+++ b/src/hwloc/include/hwloc/rename.h
@@ -585,6 +585,7 @@ extern "C" {
 #define hwloc_bitmap_compare_inclusion HWLOC_NAME(bitmap_compare_inclusion)
 
 #define hwloc_pci_class_string HWLOC_NAME(pci_class_string)
+#define hwloc_linux_pci_link_speed_from_string HWLOC_NAME(linux_pci_link_speed_from_string)
 
 #define hwloc_cache_type_by_depth_type HWLOC_NAME(cache_type_by_depth_type)
 #define hwloc__obj_type_is_normal HWLOC_NAME(_obj_type_is_normal)
@@ -636,6 +637,33 @@ extern "C" {
 #define hwloc_components_init HWLOC_NAME(components_init)
 #define hwloc_components_fini HWLOC_NAME(components_fini)
 
+/* private/internal-private.h */
+
+#define hwloc_xml_component HWLOC_NAME(xml_component)
+#define hwloc_synthetic_component HWLOC_NAME(synthetic_component)
+
+#define hwloc_aix_component HWLOC_NAME(aix_component)
+#define hwloc_bgq_component HWLOC_NAME(bgq_component)
+#define hwloc_darwin_component HWLOC_NAME(darwin_component)
+#define hwloc_freebsd_component HWLOC_NAME(freebsd_component)
+#define hwloc_hpux_component HWLOC_NAME(hpux_component)
+#define hwloc_linux_component HWLOC_NAME(linux_component)
+#define hwloc_netbsd_component HWLOC_NAME(netbsd_component)
+#define hwloc_noos_component HWLOC_NAME(noos_component)
+#define hwloc_solaris_component HWLOC_NAME(solaris_component)
+#define hwloc_windows_component HWLOC_NAME(windows_component)
+#define hwloc_x86_component HWLOC_NAME(x86_component)
+
+#define hwloc_cuda_component HWLOC_NAME(cuda_component)
+#define hwloc_gl_component HWLOC_NAME(gl_component)
+#define hwloc_linuxio_component HWLOC_NAME(linuxio_component)
+#define hwloc_nvml_component HWLOC_NAME(nvml_component)
+#define hwloc_opencl_component HWLOC_NAME(opencl_component)
+#define hwloc_pci_component HWLOC_NAME(pci_component)
+
+#define hwloc_xml_libxml_component HWLOC_NAME(xml_libxml_component)
+#define hwloc_xml_nolibxml_component HWLOC_NAME(xml_nolibxml_component)
+
 /* private/private.h */
 
 #define hwloc_special_level_s HWLOC_NAME(special_level_s)
diff --git a/src/hwloc/include/private/internal-components.h b/src/hwloc/include/private/internal-components.h
new file mode 100644
index 0000000..b138a0e
--- /dev/null
+++ b/src/hwloc/include/private/internal-components.h
@@ -0,0 +1,41 @@
+/*
+ * Copyright © 2018 Inria.  All rights reserved.
+ *
+ * See COPYING in top-level directory.
+ */
+
+/* List of components defined inside hwloc */
+
+#ifndef PRIVATE_INTERNAL_COMPONENTS_H
+#define PRIVATE_INTERNAL_COMPONENTS_H
+
+/* global discovery */
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_xml_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_synthetic_component;
+
+/* CPU discovery */
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_aix_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_bgq_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_darwin_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_freebsd_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_hpux_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_linux_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_netbsd_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_noos_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_solaris_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_windows_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_x86_component;
+
+/* I/O discovery */
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_cuda_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_gl_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_linuxio_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_nvml_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_opencl_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_pci_component;
+
+/* XML backend */
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_xml_nolibxml_component;
+HWLOC_DECLSPEC extern const struct hwloc_component hwloc_xml_libxml_component;
+
+#endif /* PRIVATE_INTERNAL_COMPONENTS_H */
diff --git a/src/hwloc/include/private/misc.h b/src/hwloc/include/private/misc.h
index 70e3037..e9b90b8 100644
--- a/src/hwloc/include/private/misc.h
+++ b/src/hwloc/include/private/misc.h
@@ -406,6 +406,29 @@ HWLOC_DECLSPEC int hwloc_bitmap_compare_inclusion(hwloc_const_bitmap_t bitmap1,
 /* Return a stringified PCI class. */
 HWLOC_DECLSPEC extern const char * hwloc_pci_class_string(unsigned short class_id);
 
+/* Parse a PCI link speed (GT/s) string from Linux sysfs */
+#ifdef HWLOC_LINUX_SYS
+#include <stdlib.h> /* for atof() */
+static __hwloc_inline float
+hwloc_linux_pci_link_speed_from_string(const char *string)
+{
+  /* don't parse Gen1 with atof() since it expects a localized string
+   * while the kernel sysfs files aren't.
+   */
+  if (!strncmp(string, "2.5 ", 4))
+    /* "2.5 GT/s" is Gen1 with 8/10 encoding */
+    return 2.5 * .8;
+
+  /* also hardwire Gen2 since it also has a specific encoding */
+  if (!strncmp(string, "5 ", 2))
+    /* "5 GT/s" is Gen2 with 8/10 encoding */
+    return 5 * .8;
+
+  /* handle Gen3+ in a generic way */
+  return atof(string) * 128./130; /* Gen3+ encoding is 128/130 */
+}
+#endif
+
 /* Traverse children of a parent */
 #define for_each_child(child, parent) for(child = parent->first_child; child; child = child->next_sibling)
 #define for_each_memory_child(child, parent) for(child = parent->memory_first_child; child; child = child->next_sibling)
@@ -494,6 +517,10 @@ hwloc__obj_type_is_icache(hwloc_obj_type_t type)
 #define fabsf(f) fabs((double)(f))
 #endif
 
+#if !HAVE_DECL_MODFF
+#define modff(x,iptr) (float)modf((double)x,(double *)iptr)
+#endif
+
 #if HAVE_DECL__SC_PAGE_SIZE
 #define hwloc_getpagesize() sysconf(_SC_PAGE_SIZE)
 #elif HAVE_DECL__SC_PAGESIZE
@@ -528,7 +555,10 @@ typedef SSIZE_T ssize_t;
 #  ifndef S_ISDIR
 #    define S_ISDIR(m) (((m) & S_IFMT) == S_IFDIR)
 #  endif
-#  if !HAVE_DECL_STRCASECMP
+#  ifndef S_IRWXU
+#    define S_IRWXU 00700
+#  endif
+#  ifndef HWLOC_HAVE_DECL_STRCASECMP
 #    define strcasecmp _stricmp
 #  endif
 #  if !HAVE_DECL_SNPRINTF
@@ -542,7 +572,7 @@ typedef SSIZE_T ssize_t;
 #  endif
 #endif
 
-#if defined HWLOC_WIN_SYS && !defined __MINGW32__
+#if defined HWLOC_WIN_SYS && !defined __MINGW32__ && !defined(__CYGWIN__)
 /* MSVC doesn't support C99 variable-length array */
 #include <malloc.h>
 #define HWLOC_VLA(_type, _name, _nb) _type *_name = (_type*) _alloca((_nb)*sizeof(_type))
diff --git a/src/hwloc/netloc/support.c b/src/hwloc/netloc/support.c
index 7ad9513..e17c937 100644
--- a/src/hwloc/netloc/support.c
+++ b/src/hwloc/netloc/support.c
@@ -1,7 +1,7 @@
 /*
  * Copyright © 2013-2014 University of Wisconsin-La Crosse.
  *                         All rights reserved.
- * Copyright © 2016-2017 Inria.  All rights reserved.
+ * Copyright © 2016-2018 Inria.  All rights reserved.
  *
  * $COPYRIGHT$
  *
@@ -17,7 +17,9 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 
 char *netloc_line_get_next_token(char **string, char c)
 {
diff --git a/src/hwloc/tests/hwloc/hwloc_backends.c b/src/hwloc/tests/hwloc/hwloc_backends.c
index f969c45..745961a 100644
--- a/src/hwloc/tests/hwloc/hwloc_backends.c
+++ b/src/hwloc/tests/hwloc/hwloc_backends.c
@@ -19,6 +19,7 @@
 #include <fcntl.h>
 #include <sys/stat.h>
 #include <sys/types.h>
+#include <private/misc.h> /* for S_IRWXU */
 static inline int mkstemp(char *name)
 {
   mktemp(name);
diff --git a/src/hwloc/tests/hwloc/hwloc_distances.c b/src/hwloc/tests/hwloc/hwloc_distances.c
index 0a7c8d1..8af0802 100644
--- a/src/hwloc/tests/hwloc/hwloc_distances.c
+++ b/src/hwloc/tests/hwloc/hwloc_distances.c
@@ -64,7 +64,7 @@ int main(void)
   hwloc_topology_t topology;
   struct hwloc_distances_s *distances[2];
   hwloc_obj_t objs[16];
-  uint64_t values[16*16], value1, value2;
+  hwloc_uint64_t values[16*16], value1, value2;
   int topodepth;
   unsigned i, j, k, nr;
   int err;
diff --git a/src/hwloc/tests/hwloc/hwloc_get_next_obj_covering_cpuset.c b/src/hwloc/tests/hwloc/hwloc_get_next_obj_covering_cpuset.c
index 68a84ba..144e6cc 100644
--- a/src/hwloc/tests/hwloc/hwloc_get_next_obj_covering_cpuset.c
+++ b/src/hwloc/tests/hwloc/hwloc_get_next_obj_covering_cpuset.c
@@ -1,6 +1,6 @@
 /*
  * Copyright © 2009 CNRS
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2010 Université Bordeaux
  * Copyright © 2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -33,7 +33,7 @@ main (void)
   err = hwloc_topology_init (&topology);
   if (err)
     return EXIT_FAILURE;
-  hwloc_topology_set_synthetic (topology, "pack:8 cores:2 1");
+  hwloc_topology_set_synthetic (topology, "pack:8 core:2 1");
   err = hwloc_topology_load (topology);
   if (err)
     return EXIT_FAILURE;
@@ -60,7 +60,7 @@ main (void)
   err = hwloc_topology_init (&topology);
   if (err)
     return EXIT_FAILURE;
-  hwloc_topology_set_synthetic (topology, "nodes:2 pack:5 cores:3 4");
+  hwloc_topology_set_synthetic (topology, "node:2 pack:5 core:3 4");
   err = hwloc_topology_load (topology);
   if (err)
     return EXIT_FAILURE;
diff --git a/src/hwloc/tests/hwloc/hwloc_get_obj_inside_cpuset.c b/src/hwloc/tests/hwloc/hwloc_get_obj_inside_cpuset.c
index bd989ce..e6fa4c9 100644
--- a/src/hwloc/tests/hwloc/hwloc_get_obj_inside_cpuset.c
+++ b/src/hwloc/tests/hwloc/hwloc_get_obj_inside_cpuset.c
@@ -1,6 +1,6 @@
 /*
  * Copyright © 2009 CNRS
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009 Université Bordeaux
  * Copyright © 2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -28,7 +28,7 @@ main (void)
   if (err)
     return EXIT_FAILURE;
 
-  hwloc_topology_set_synthetic (topology, "nodes:2 pack:3 l2:4 cores:5 6");
+  hwloc_topology_set_synthetic (topology, "node:2 pack:3 l2:4 core:5 6");
 
   err = hwloc_topology_load (topology);
   if (err)
diff --git a/src/hwloc/tests/hwloc/hwloc_groups.c b/src/hwloc/tests/hwloc/hwloc_groups.c
index 9e713b5..24457a7 100644
--- a/src/hwloc/tests/hwloc/hwloc_groups.c
+++ b/src/hwloc/tests/hwloc/hwloc_groups.c
@@ -16,7 +16,7 @@ int main(void)
   hwloc_topology_t topology;
   hwloc_obj_t obj;
   hwloc_obj_t objs[32];
-  uint64_t values[32*32];
+  hwloc_uint64_t values[32*32];
   int depth;
   hwloc_obj_type_t type;
   unsigned width;
diff --git a/src/hwloc/tests/hwloc/hwloc_topology_dup.c b/src/hwloc/tests/hwloc/hwloc_topology_dup.c
index 3e44b8d..6688839 100644
--- a/src/hwloc/tests/hwloc/hwloc_topology_dup.c
+++ b/src/hwloc/tests/hwloc/hwloc_topology_dup.c
@@ -17,7 +17,7 @@ int main(void)
   hwloc_bitmap_t cpuset = hwloc_bitmap_alloc();
   struct hwloc_distances_s *distances;
   hwloc_obj_t nodes[3], cores[6];
-  uint64_t node_distances[9], core_distances[36];
+  hwloc_uint64_t node_distances[9], core_distances[36];
   unsigned i,j,nr;
   int err;
 
diff --git a/src/hwloc/tests/hwloc/hwloc_topology_restrict.c b/src/hwloc/tests/hwloc/hwloc_topology_restrict.c
index 131a72a..803ebd9 100644
--- a/src/hwloc/tests/hwloc/hwloc_topology_restrict.c
+++ b/src/hwloc/tests/hwloc/hwloc_topology_restrict.c
@@ -1,5 +1,5 @@
 /*
- * Copyright © 2011-2017 Inria.  All rights reserved.
+ * Copyright © 2011-2018 Inria.  All rights reserved.
  * Copyright © 2011 Université Bordeaux.  All rights reserved.
  * See COPYING in top-level directory.
  */
@@ -106,7 +106,7 @@ int main(void)
 {
   hwloc_bitmap_t cpuset = hwloc_bitmap_alloc();
   hwloc_obj_t nodes[3], cores[6];
-  uint64_t node_distances[9], core_distances[36];
+  hwloc_uint64_t node_distances[9], core_distances[36];
   hwloc_obj_t obj;
   unsigned i,j;
   int err;
@@ -224,6 +224,17 @@ int main(void)
   hwloc_topology_check(topology);
   hwloc_topology_destroy(topology);
 
+  /* check that restricting PUs maintains ordering of normal children */
+  printf("restricting so that PUs get reordered\n");
+  hwloc_topology_init(&topology);
+  hwloc_topology_set_synthetic(topology, "node:1 core:2 pu:2(indexes=0,2,1,3)");
+  hwloc_topology_load(topology);
+  hwloc_bitmap_zero(cpuset);
+  hwloc_bitmap_set_range(cpuset, 1, 2);
+  err = hwloc_topology_restrict(topology, cpuset, 0);
+  assert(!err);
+  hwloc_topology_destroy(topology);
+
   hwloc_bitmap_free(cpuset);
 
   return 0;
diff --git a/src/hwloc/tests/hwloc/linux/allowed/test-topology.sh.in b/src/hwloc/tests/hwloc/linux/allowed/test-topology.sh.in
index 4d67fc4..5ddc9ff 100644
--- a/src/hwloc/tests/hwloc/linux/allowed/test-topology.sh.in
+++ b/src/hwloc/tests/hwloc/linux/allowed/test-topology.sh.in
@@ -73,10 +73,10 @@ test_topology ()
     else
 	if [ "$HWLOC_UPDATE_TEST_TOPOLOGY_OUTPUT" != 1 ]
 	then
-	    diff @HWLOC_DIFF_U@ -b "$expected_output" "$output"
+	    @DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ "$expected_output" "$output"
 	    result=$?
 	else
-	    if ! diff "$expected_output" "$output" >/dev/null
+	    if ! @DIFF@ "$expected_output" "$output" >/dev/null
 	    then
 		cp -f "$output" "$expected_output"
 		echo "Updated $expected_output"
diff --git a/src/hwloc/tests/hwloc/linux/gather/test-gather-topology.sh.in b/src/hwloc/tests/hwloc/linux/gather/test-gather-topology.sh.in
index 07b6951..90415f1 100644
--- a/src/hwloc/tests/hwloc/linux/gather/test-gather-topology.sh.in
+++ b/src/hwloc/tests/hwloc/linux/gather/test-gather-topology.sh.in
@@ -2,7 +2,7 @@
 #-*-sh-*-
 
 #
-# Copyright © 2012-2017 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # Copyright © 2010-2014 Cisco Systems, Inc.  All rights reserved.
 # Copyright © 2011 Université Bordeaux
 # See COPYING in top-level directory.
@@ -82,7 +82,7 @@ if ! "$lstopo" --no-io "$tmpdir/save2.xml" ; then
 fi
 
 echo "Comparing XML outputs..."
-( cd $tmpdir && diff -u save1.xml save2.xml )
+( cd $tmpdir && @DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ save1.xml save2.xml )
 result=$?
 
 rm -rf "$tmpdir"
diff --git a/src/hwloc/tests/hwloc/linux/test-topology.sh.in b/src/hwloc/tests/hwloc/linux/test-topology.sh.in
index cc094aa..107eca9 100644
--- a/src/hwloc/tests/hwloc/linux/test-topology.sh.in
+++ b/src/hwloc/tests/hwloc/linux/test-topology.sh.in
@@ -65,10 +65,10 @@ test_topology ()
     else
 	if [ "$HWLOC_UPDATE_TEST_TOPOLOGY_OUTPUT" != 1 ]
 	then
-	    diff @HWLOC_DIFF_U@ -b "$expected_output" "$output"
+	    @DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ "$expected_output" "$output"
 	    result=$?
 	else
-	    if ! diff "$expected_output" "$output" >/dev/null
+	    if ! @DIFF@ "$expected_output" "$output" >/dev/null
 	    then
 		cp -f "$output" "$expected_output"
 		echo "Updated $expected_output"
diff --git a/src/hwloc/tests/hwloc/opencl.c b/src/hwloc/tests/hwloc/opencl.c
index 74592b7..322224a 100644
--- a/src/hwloc/tests/hwloc/opencl.c
+++ b/src/hwloc/tests/hwloc/opencl.c
@@ -5,6 +5,7 @@
 
 #include <stdio.h>
 #include <assert.h>
+#define CL_TARGET_OPENCL_VERSION 220
 #ifdef __APPLE__
 #include <OpenCL/cl.h>
 #else
@@ -35,8 +36,10 @@ int main(void)
   if (!platform_ids)
     return 0;
   clret = clGetPlatformIDs(nrp, platform_ids, &nrp);
-  if (CL_SUCCESS != clret || !nrp)
+  if (CL_SUCCESS != clret || !nrp) {
+    free(platform_ids);
     return 0;
+  }
 
   count = 0;
   for(i=0; i<nrp; i++) {
@@ -49,8 +52,10 @@ int main(void)
     if (!device_ids)
       continue;
     clret = clGetDeviceIDs(platform_ids[i], CL_DEVICE_TYPE_ALL, nrd, device_ids, &nrd);
-    if (CL_SUCCESS != clret || !nrd)
+    if (CL_SUCCESS != clret || !nrd) {
+      free(device_ids);
       continue;
+    }
 
     for(j=0; j<nrd; j++) {
       hwloc_bitmap_t set;
@@ -112,7 +117,9 @@ int main(void)
 
       count++;
     }
+    free(device_ids);
   }
+  free(platform_ids);
 
   hwloc_topology_destroy(topology);
 
diff --git a/src/hwloc/tests/hwloc/rename/main.c b/src/hwloc/tests/hwloc/rename/main.c
index a843573..24b5851 100644
--- a/src/hwloc/tests/hwloc/rename/main.c
+++ b/src/hwloc/tests/hwloc/rename/main.c
@@ -41,6 +41,7 @@
 
 #include "private/autogen/config.h"
 #include "private/components.h"
+#include "private/internal-components.h"
 #include "private/cpuid-x86.h"
 #include "private/debug.h"
 #include "private/misc.h"
diff --git a/src/hwloc/tests/hwloc/shmem.c b/src/hwloc/tests/hwloc/shmem.c
index c2b8abb..11a1ae0 100644
--- a/src/hwloc/tests/hwloc/shmem.c
+++ b/src/hwloc/tests/hwloc/shmem.c
@@ -10,7 +10,9 @@
 #include <stdlib.h>
 #include <fcntl.h>
 #include <stdio.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 #include <sys/mman.h>
 #include <sys/types.h>
 #include <sys/stat.h>
diff --git a/src/hwloc/tests/hwloc/wrapper.sh.in b/src/hwloc/tests/hwloc/wrapper.sh.in
index 1f1b2a9..d175160 100644
--- a/src/hwloc/tests/hwloc/wrapper.sh.in
+++ b/src/hwloc/tests/hwloc/wrapper.sh.in
@@ -2,11 +2,12 @@
 #-*-sh-*-
 
 #
-# Copyright © 2012-2017 Inria.  All rights reserved.
+# Copyright © 2012-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
 HWLOC_top_builddir="@HWLOC_top_builddir@"
+xmlbuffer=xmlbuffer@EXEEXT@
 
 HWLOC_PLUGINS_PATH=${HWLOC_top_builddir}/src
 export HWLOC_PLUGINS_PATH
@@ -17,4 +18,11 @@ export HWLOC_DEBUG_CHECK
 HWLOC_LIBXML_CLEANUP=1
 export HWLOC_LIBXML_CLEANUP
 
-"$@"
+if test "`basename $1`" = "$xmlbuffer"; then
+    "$@" 1 1
+    "$@" 0 1
+    "$@" 1 0
+    "$@" 0 0
+else
+    "$@"
+fi
diff --git a/src/hwloc/tests/hwloc/x86/test-topology.sh.in b/src/hwloc/tests/hwloc/x86/test-topology.sh.in
index bfad8af..3e1315b 100644
--- a/src/hwloc/tests/hwloc/x86/test-topology.sh.in
+++ b/src/hwloc/tests/hwloc/x86/test-topology.sh.in
@@ -61,10 +61,10 @@ test_topology ()
     else
 	if [ "$HWLOC_UPDATE_TEST_TOPOLOGY_OUTPUT" != 1 ]
 	then
-	    diff -b @HWLOC_DIFF_U@ "$expected_output" "$output"
+	    @DIFF@ -b @HWLOC_DIFF_U@ "$expected_output" "$output"
 	    result=$?
 	else
-	    if ! diff "$expected_output" "$output" >/dev/null
+	    if ! @DIFF@ "$expected_output" "$output" >/dev/null
 	    then
 		cp -f "$output" "$expected_output"
 		echo "Updated $expected_output"
diff --git a/src/hwloc/tests/hwloc/xml/test-topology.sh.in b/src/hwloc/tests/hwloc/xml/test-topology.sh.in
index b87d295..c283e63 100644
--- a/src/hwloc/tests/hwloc/xml/test-topology.sh.in
+++ b/src/hwloc/tests/hwloc/xml/test-topology.sh.in
@@ -3,7 +3,7 @@
 
 #
 # Copyright © 2009 CNRS
-# Copyright © 2009-2017 Inria.  All rights reserved.
+# Copyright © 2009-2018 Inria.  All rights reserved.
 # Copyright © 2009-2012 Université Bordeaux
 # Copyright © 2010-2014 Cisco Systems, Inc.  All rights reserved.
 # See COPYING in top-level directory.
@@ -85,9 +85,9 @@ do_run()
 
   if [ "$HWLOC_UPDATE_TEST_TOPOLOGY_OUTPUT" != 1 ]
   then
-    diff @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ "$output" "$file"
+    @DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ "$output" "$file"
   else
-    if ! diff "$output" "$file" >/dev/null
+    if ! @DIFF@ "$output" "$file" >/dev/null
     then
 	cp -f "$file" "$output"
 	echo "Updated $filename"
@@ -110,9 +110,9 @@ do_run_with_output()
 
   if [ "$HWLOC_UPDATE_TEST_TOPOLOGY_OUTPUT" != 1 ]
   then
-    diff @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ "$output" "$file"
+    @DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ "$output" "$file"
   else
-    if ! diff "$output" "$file" >/dev/null
+    if ! @DIFF@ "$output" "$file" >/dev/null
     then
         cp -f "$file" "$output"
         echo "Updated ${basename}.xml"
diff --git a/src/hwloc/tests/hwloc/xmlbuffer.c b/src/hwloc/tests/hwloc/xmlbuffer.c
index b3f3ed2..3b90dbd 100644
--- a/src/hwloc/tests/hwloc/xmlbuffer.c
+++ b/src/hwloc/tests/hwloc/xmlbuffer.c
@@ -13,7 +13,7 @@ static int one_test(void)
 {
   hwloc_topology_t topology;
   int size1, size2;
-  char *buf1, *buf2;
+  char *buf1, *copy1, *buf2;
   int err = 0, i;
   char s[129];
   char t[10];
@@ -43,9 +43,16 @@ static int one_test(void)
   hwloc_topology_destroy(topology);
   printf("exported to buffer %p length %d\n", buf1, size1);
 
+  /* copy the returned buffer to a newly malloc'd one
+   * to check that the returned length is correct (contains ending 0, etc).
+   */
+  copy1 = malloc(size1);
+  assert(copy1);
+  memcpy(copy1, buf1, size1);
+
   hwloc_topology_init(&topology);
   hwloc_topology_set_all_types_filter(topology, HWLOC_TYPE_FILTER_KEEP_ALL);
-  assert(!hwloc_topology_set_xmlbuffer(topology, buf1, size1));
+  assert(!hwloc_topology_set_xmlbuffer(topology, copy1, size1));
   hwloc_topology_load(topology);
   assert(!hwloc_topology_is_thissystem(topology));
   if (strcmp(hwloc_obj_get_info_by_name(hwloc_get_root_obj(topology), "UglyString"), s))
@@ -67,42 +74,42 @@ static int one_test(void)
 
   hwloc_free_xmlbuffer(topology, buf1);
   hwloc_free_xmlbuffer(topology, buf2);
+  free(copy1);
 
   hwloc_topology_destroy(topology);
 
   return err;
 }
 
-int main(void)
+int main(int argc, char *argv[])
 {
   int err;
 
-  putenv("HWLOC_LIBXML_CLEANUP=1");
+  if (argc < 3) {
+    fprintf(stderr, "Need 0 or 1 twice as arguments for enabling/disabling libxml import and export\n");
+    fprintf(stderr, "For instance `xmlbuffer 0 1' enables libxml for export only\n");
+    fprintf(stderr, "Those arguments are passed by wrapper.sh during make check\n");
+    exit(EXIT_FAILURE);
+  }
 
-  printf("using default import and export\n");
-  putenv("HWLOC_LIBXML_IMPORT=1");
-  putenv("HWLOC_LIBXML_EXPORT=1");
-  err = one_test();
-  if (err < 0)
-    return err;
+  putenv("HWLOC_LIBXML_CLEANUP=1");
 
-  printf("using minimalistic import and default export\n");
-  putenv("HWLOC_LIBXML_IMPORT=0");
-  putenv("HWLOC_LIBXML_EXPORT=1");
-  err = one_test();
-  if (err < 0)
-    return err;
+  if (atoi(argv[1])) {
+    putenv("HWLOC_LIBXML_IMPORT=1");
+    printf("import=libxml   ");
+  } else {
+    putenv("HWLOC_LIBXML_IMPORT=0");
+    printf("import=nolibxml ");
+  }
 
-  printf("using default import and minimalistic export\n");
-  putenv("HWLOC_LIBXML_IMPORT=1");
-  putenv("HWLOC_LIBXML_EXPORT=0");
-  err = one_test();
-  if (err < 0)
-    return err;
+  if (atoi(argv[2])) {
+    putenv("HWLOC_LIBXML_EXPORT=1");
+    printf("export=libxml\n");
+  } else {
+    putenv("HWLOC_LIBXML_EXPORT=0");
+    printf("export=nolibxml\n");
+  }
 
-  printf("using minimalistic import and export\n");
-  putenv("HWLOC_LIBXML_IMPORT=0");
-  putenv("HWLOC_LIBXML_EXPORT=0");
   err = one_test();
   if (err < 0)
     return err;
diff --git a/src/hwloc/utils/hwloc/Makefile.am b/src/hwloc/utils/hwloc/Makefile.am
index 3e25454..ed0df3a 100644
--- a/src/hwloc/utils/hwloc/Makefile.am
+++ b/src/hwloc/utils/hwloc/Makefile.am
@@ -1,4 +1,4 @@
-# Copyright © 2009-2016 Inria.  All rights reserved.
+# Copyright © 2009-2018 Inria.  All rights reserved.
 # Copyright © 2009-2012, 2014, 2016 Université Bordeaux
 # Copyright © 2009-2014 Cisco Systems, Inc.  All rights reserved.
 #
@@ -75,9 +75,9 @@ TESTS += test-fake-plugin.sh
 endif HWLOC_HAVE_PLUGINS
 endif !HWLOC_HAVE_MINGW32
 
-SEDMAN = $(SED) -e 's/\#PACKAGE_NAME\#/@PACKAGE_NAME@/g' \
-	  -e 's/\#PACKAGE_VERSION\#/@PACKAGE_VERSION@/g' \
-	  -e 's/\#HWLOC_DATE\#/@HWLOC_RELEASE_DATE@/g'
+SEDMAN = $(SED) -e 's/%PACKAGE_NAME%/@PACKAGE_NAME@/g' \
+	  -e 's/%PACKAGE_VERSION%/@PACKAGE_VERSION@/g' \
+	  -e 's/%HWLOC_DATE%/@HWLOC_RELEASE_DATE@/g'
 
 # Only install man pages if we're building in standalone mode
 man7_pages = hwloc.7
@@ -130,7 +130,7 @@ nodist_man_MANS += $(hdh_page)
 hwloc-dump-hwdata.1: hwloc-dump-hwdata.1in
 	@ echo Creating $@ man page...
 	@ $(SEDMAN) \
-	  -e 's/#RUNSTATEDIR#/$(subst /,\/,$(HWLOC_runstatedir))/g' \
+	  -e 's/%RUNSTATEDIR%/$(subst /,\/,$(HWLOC_runstatedir))/g' \
 	  > $@ < $<
 endif HWLOC_HAVE_X86
 endif HWLOC_HAVE_LINUX
diff --git a/src/hwloc/utils/hwloc/hwloc-annotate.1in b/src/hwloc/utils/hwloc/hwloc-annotate.1in
index d87f6fe..f78bd08 100644
--- a/src/hwloc/utils/hwloc/hwloc-annotate.1in
+++ b/src/hwloc/utils/hwloc/hwloc-annotate.1in
@@ -1,9 +1,9 @@
 .\" -*- nroff -*-
-.\" Copyright © 2013-2017 Inria.  All rights reserved.
+.\" Copyright © 2013-2018 Inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-ANNOTATE "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-ANNOTATE "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
-hwloc-annotate \- Add info attributes to a XML topology
+hwloc-annotate \- Modify attributes in a XML topology
 .
 .\" **************************
 .\"    Synopsis Section
diff --git a/src/hwloc/utils/hwloc/hwloc-annotate.c b/src/hwloc/utils/hwloc/hwloc-annotate.c
index 00c6af5..11fbd1c 100644
--- a/src/hwloc/utils/hwloc/hwloc-annotate.c
+++ b/src/hwloc/utils/hwloc/hwloc-annotate.c
@@ -120,7 +120,7 @@ add_distances(hwloc_topology_t topology, int topodepth)
 	unsigned long kind = 0;
 	unsigned nbobjs = 0;
 	hwloc_obj_t *objs = NULL;
-	uint64_t *values = NULL;
+	hwloc_uint64_t *values = NULL;
 	FILE *file;
 	char line[64];
 	unsigned i, x, y, z;
diff --git a/src/hwloc/utils/hwloc/hwloc-bind.1in b/src/hwloc/utils/hwloc/hwloc-bind.1in
index 5f259ac..a1be7d6 100644
--- a/src/hwloc/utils/hwloc/hwloc-bind.1in
+++ b/src/hwloc/utils/hwloc/hwloc-bind.1in
@@ -3,7 +3,7 @@
 .\" Copyright © 2010 Université of Bordeaux
 .\" Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-BIND "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-BIND "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-bind \- Launch a command that is bound to specific processors
 and/or memory, or consult the binding of an existing program
diff --git a/src/hwloc/utils/hwloc/hwloc-bind.c b/src/hwloc/utils/hwloc/hwloc-bind.c
index 5dbf3e5..abc8565 100644
--- a/src/hwloc/utils/hwloc/hwloc-bind.c
+++ b/src/hwloc/utils/hwloc/hwloc-bind.c
@@ -2,7 +2,7 @@
  * Copyright © 2009 CNRS
  * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2010, 2012 Université Bordeaux
- * Copyright © 2009 Cisco Systems, Inc.  All rights reserved.
+ * Copyright © 2009-2018 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
  */
 
@@ -66,7 +66,7 @@ int main(int argc, char *argv[])
 {
   hwloc_topology_t topology;
   int loaded = 0;
-  int depth;
+  int depth = -1;
   hwloc_bitmap_t cpubind_set, membind_set;
   int got_cpubind = 0, got_membind = 0;
   int working_on_cpubind = 1; /* membind if 0 */
@@ -303,7 +303,10 @@ int main(int argc, char *argv[])
   }
 
   if (pid_number > 0) {
-    pid = hwloc_pid_from_number(pid_number, !(get_binding || get_last_cpu_location));
+    if (hwloc_pid_from_number(&pid, pid_number, !(get_binding || get_last_cpu_location), 1 /* verbose */) < 0) {
+      fprintf(stderr, "failed to use pid\n");
+      return EXIT_FAILURE;
+    }
     /* no need to set_pid()
      * the doc just says we're operating on pid, not that we're retrieving the topo/cpuset as seen from inside pid
      */
diff --git a/src/hwloc/utils/hwloc/hwloc-calc.1in b/src/hwloc/utils/hwloc/hwloc-calc.1in
index cb15303..e5943ba 100644
--- a/src/hwloc/utils/hwloc/hwloc-calc.1in
+++ b/src/hwloc/utils/hwloc/hwloc-calc.1in
@@ -2,7 +2,7 @@
 .\" Copyright © 2010-2016 Inria.  All rights reserved.
 .\" Copyright © 2009 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-CALC "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-CALC "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-calc \- Operate on cpu mask strings and objects
 .
diff --git a/src/hwloc/utils/hwloc/hwloc-compress-dir.1in b/src/hwloc/utils/hwloc/hwloc-compress-dir.1in
index ea67876..1d2e29b 100644
--- a/src/hwloc/utils/hwloc/hwloc-compress-dir.1in
+++ b/src/hwloc/utils/hwloc/hwloc-compress-dir.1in
@@ -1,7 +1,7 @@
 .\" -*- nroff -*-
 .\" Copyright © 2013 inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-COMPRESS-DIR "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-COMPRESS-DIR "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-compress-dir \- Compress a directory of XML topologies
 .
diff --git a/src/hwloc/utils/hwloc/hwloc-diff.1in b/src/hwloc/utils/hwloc/hwloc-diff.1in
index 2707627..7185351 100644
--- a/src/hwloc/utils/hwloc/hwloc-diff.1in
+++ b/src/hwloc/utils/hwloc/hwloc-diff.1in
@@ -1,7 +1,7 @@
 .\" -*- nroff -*-
 .\" Copyright © 2013-2016 Inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-DIFF "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-DIFF "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-diff \- Compute differences between two XML topologies
 .
diff --git a/src/hwloc/utils/hwloc/hwloc-diff.c b/src/hwloc/utils/hwloc/hwloc-diff.c
index d6deee4..b5fe380 100644
--- a/src/hwloc/utils/hwloc/hwloc-diff.c
+++ b/src/hwloc/utils/hwloc/hwloc-diff.c
@@ -13,9 +13,9 @@ void usage(const char *callname __hwloc_attribute_unused, FILE *where)
 {
 	fprintf(where, "Usage: hwloc-diff [options] <old.xml> <new.xml> [<output.diff.xml>]\n");
 	fprintf(where, "Options:\n");
-	fprintf(where, "  --refname        Change the XML reference identifier in the output\n");
-	fprintf(where, "                   (default is the filename of the first topology\n");
-	fprintf(where, "  --version        Report version and exit\n");
+	fprintf(where, "  --refname <name>  Change the XML reference identifier to <name> in the output\n");
+	fprintf(where, "                    (default is the filename of the first topology\n");
+	fprintf(where, "  --version         Report version and exit\n");
 }
 
 int main(int argc, char *argv[])
@@ -40,6 +40,10 @@ int main(int argc, char *argv[])
 
 	while (argc && *argv[0] == '-') {
 		if (!strcmp (argv[0], "--refname")) {
+			if (argc < 2) {
+				usage(callname, stderr);
+				exit(EXIT_FAILURE);
+			}
 			refname = argv[1];
 			argc--;
 			argv++;
diff --git a/src/hwloc/utils/hwloc/hwloc-distrib.1in b/src/hwloc/utils/hwloc/hwloc-distrib.1in
index b1e09d4..6da0332 100644
--- a/src/hwloc/utils/hwloc/hwloc-distrib.1in
+++ b/src/hwloc/utils/hwloc/hwloc-distrib.1in
@@ -2,7 +2,7 @@
 .\" Copyright © 2010-2017 Inria.  All rights reserved.
 .\" Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-DISTRIB "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-DISTRIB "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-distrib \- Build a number of cpu masks distributed on the system
 .
diff --git a/src/hwloc/utils/hwloc/hwloc-dump-hwdata-knl.c b/src/hwloc/utils/hwloc/hwloc-dump-hwdata-knl.c
index e71e514..00e14ea 100644
--- a/src/hwloc/utils/hwloc/hwloc-dump-hwdata-knl.c
+++ b/src/hwloc/utils/hwloc/hwloc-dump-hwdata-knl.c
@@ -10,7 +10,9 @@
 #include <dirent.h>
 #include <errno.h>
 #include <fcntl.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 #include <stdlib.h>
 #include <string.h>
 #include <sys/stat.h>
diff --git a/src/hwloc/utils/hwloc/hwloc-dump-hwdata.1in b/src/hwloc/utils/hwloc/hwloc-dump-hwdata.1in
index f507577..27ced3d 100644
--- a/src/hwloc/utils/hwloc/hwloc-dump-hwdata.1in
+++ b/src/hwloc/utils/hwloc/hwloc-dump-hwdata.1in
@@ -1,7 +1,7 @@
 .\" -*- nroff -*-
 .\" Copyright © 2015-2018 Inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-DUMP-HWDATA "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-DUMP-HWDATA "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-dump-hwdata \- Dump topology and locality information from hardware tables
 .
@@ -21,7 +21,7 @@ hwloc-dump-hwdata \- Dump topology and locality information from hardware tables
 .TP 10
 \fB\-o <dir>\fR
 save output files to directory <dir> instead of the default
-\fI#RUNSTATEDIR#/hwloc/\fR that was specified at configure time.
+\fI%RUNSTATEDIR%/hwloc/\fR that was specified at configure time.
 
 You may want to set the HWLOC_DUMPED_HWDATA_DIR environment variable
 as well so that the hwloc library looks for dumped files in that same
diff --git a/src/hwloc/utils/hwloc/hwloc-dump-hwdata.c b/src/hwloc/utils/hwloc/hwloc-dump-hwdata.c
index fba927c..e29c081 100644
--- a/src/hwloc/utils/hwloc/hwloc-dump-hwdata.c
+++ b/src/hwloc/utils/hwloc/hwloc-dump-hwdata.c
@@ -11,7 +11,9 @@
 #include <fcntl.h>
 #include <sys/stat.h>
 #include <sys/types.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 #include <errno.h>
 #include <assert.h>
 
diff --git a/src/hwloc/utils/hwloc/hwloc-gather-cpuid.1in b/src/hwloc/utils/hwloc/hwloc-gather-cpuid.1in
index aa4ca8e..5ce7576 100644
--- a/src/hwloc/utils/hwloc/hwloc-gather-cpuid.1in
+++ b/src/hwloc/utils/hwloc/hwloc-gather-cpuid.1in
@@ -1,7 +1,7 @@
 .\" -*- nroff -*-
 .\" Copyright © 2015-2016 Inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-GATHER-CPUID "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-GATHER-CPUID "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-gather-cpuid \- Dumps the relevant x86 cpuid values
 for later (possibly offline) usage
diff --git a/src/hwloc/utils/hwloc/hwloc-gather-cpuid.c b/src/hwloc/utils/hwloc/hwloc-gather-cpuid.c
index cfa2d56..7286970 100644
--- a/src/hwloc/utils/hwloc/hwloc-gather-cpuid.c
+++ b/src/hwloc/utils/hwloc/hwloc-gather-cpuid.c
@@ -15,7 +15,7 @@
 
 #include <private/cpuid-x86.h>
 
-#ifdef HWLOC_WIN_SYS
+#if defined(HWLOC_WIN_SYS) && !defined(__CYGWIN__)
 #include <direct.h>
 #define mkdir(name, mode) _mkdir(name)
 #include <io.h>
@@ -47,6 +47,10 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
   unsigned regs[4];
   unsigned highest_cpuid, highest_ext_cpuid;
   unsigned i;
+  int has_intel_x2apic = 0;
+  int has_intel_pconfig = 0;
+  int has_intel_sgx = 0;
+  int has_amd_topoext = 0;
   FILE *output;
   int err;
 
@@ -88,6 +92,8 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
   if (highest_cpuid >= 0x1) {
     regs[0] = 0x1;
     dump_one_cpuid(output, regs, 0x1);
+    if (regs[2] & (1 << 21))
+      has_intel_x2apic = 1;
   }
 
   /* 0x2 = Cache + TLB on Intel ; Reserved on AMD */
@@ -129,6 +135,10 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
     unsigned max;
     regs[0] = 0x7; regs[2] = 0;
     dump_one_cpuid(output, regs, 0x5);
+    if (regs[3] & (1<<18))
+      has_intel_pconfig = 1;
+    if (regs[1] & (1<<2))
+      has_intel_sgx = 1;
     max = regs[0];
     for(i=1; i<=max; i++) {
       regs[0] = 0x7; regs[2] = i;
@@ -149,7 +159,7 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
   }
 
   /* 0xb = Extended topology on Intel ; Reserved on AMD */
-  if (highest_cpuid >= 0xb) {
+  if (has_intel_x2apic && highest_cpuid >= 0xb) {
     for(i=0; ; i++) {
       regs[0] = 0xb; regs[2] = i;
       dump_one_cpuid(output, regs, 0x5);
@@ -194,16 +204,40 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
 
   /* 0x10 = Platform/L3 QoS enforcement enumeration on Intel ; Reserved on AMD */
   if (highest_cpuid >= 0x10) {
+    /* Intel Resource Director Technology (Intel RDT) Allocation */
     regs[0] = 0x10; regs[2] = 0;
     dump_one_cpuid(output, regs, 0x5);
+    /* L3 Cache Allocation Technology */
     regs[0] = 0x10; regs[2] = 1;
     dump_one_cpuid(output, regs, 0x5);
+    /* L2 Cache Allocation Technology */
+    regs[0] = 0x10; regs[2] = 2;
+    dump_one_cpuid(output, regs, 0x5);
+    /* Memory Bandwidth Allocation */
+    regs[0] = 0x10; regs[2] = 3;
+    dump_one_cpuid(output, regs, 0x5);
+  }
+
+  /* 0x12 = SGX Attributes Enumeration on Intel ; Reserved on AMD */
+  if (has_intel_sgx && highest_cpuid >= 0x12) {
+    regs[0] = 0x12; regs[2] = 0;
+    dump_one_cpuid(output, regs, 0x5);
+    regs[0] = 0x12; regs[2] = 1;
+    dump_one_cpuid(output, regs, 0x5);
+    for(i=2; ; i++) {
+      regs[0] = 0x12; regs[2] = i;
+      dump_one_cpuid(output, regs, 0x5);
+      if (!(regs[0] & 0xf))
+	break;
+    }
   }
 
   /* 0x14 = Processor trace enumeration on Intel ; Reserved on AMD */
   if (highest_cpuid >= 0x14) {
     regs[0] = 0x14; regs[2] = 0;
     dump_one_cpuid(output, regs, 0x5);
+    regs[0] = 0x14; regs[2] = 1;
+    dump_one_cpuid(output, regs, 0x5);
   }
 
   /* 0x15 = Timestamp counter/core crystal clock on Intel ; Reserved on AMD */
@@ -218,7 +252,51 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
     dump_one_cpuid(output, regs, 0x1);
   }
 
-  if (highest_cpuid > 0x16) {
+  /* 0x17 = System-On-Chip Vendor Attribute on Intel ; Reserved on AMD */
+  if (highest_cpuid >= 0x17) {
+    unsigned maxsocid;
+    regs[0] = 0x17; regs[2] = 0;
+    dump_one_cpuid(output, regs, 0x5);
+    maxsocid = regs[0];
+    for(i=1; i<=maxsocid; i++) {
+      regs[0] = 0x17; regs[2] = i;
+      dump_one_cpuid(output, regs, 0x5);
+    }
+  }
+
+  /* 0x18 = Deterministic Address Translation Parameters on Intel ; Reserved on AMD */
+  if (highest_cpuid >= 0x18) {
+    unsigned max;
+    regs[0] = 0x18; regs[2] = 0;
+    dump_one_cpuid(output, regs, 0x5);
+    max = regs[0];
+    for(i=1; i<=max; i++) {
+      regs[0] = 0x18; regs[2] = i;
+      dump_one_cpuid(output, regs, 0x5);
+    }
+  }
+
+  /* 0x1b = PCONFIG Information on Intel ; Reserved on AMD */
+  if (has_intel_pconfig && highest_cpuid >= 0x1b) {
+    for(i=0; ; i++) {
+      regs[0] = 0x1b; regs[2] = i;
+      dump_one_cpuid(output, regs, 0x5);
+      if (!(regs[0] & 0xfff))
+	break;
+    }
+  }
+
+  /* 0x1f = V2 Extended Topology Enumeration on Intel ; Reserved on AMD */
+  if (highest_cpuid >= 0x1f) {
+    for(i=0; ; i++) {
+      regs[0] = 0x1f; regs[2] = i;
+      dump_one_cpuid(output, regs, 0x5);
+      if (!regs[0] && !regs[1])
+	break;
+    }
+  }
+
+  if (highest_cpuid > 0x1f) {
     static int reported = 0;
     if (!reported)
       fprintf(stderr, "WARNING: Processor supports new CPUID leaves upto 0x%x\n", highest_cpuid);
@@ -233,6 +311,8 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
   if (highest_ext_cpuid >= 0x80000001) {
     regs[0] = 0x80000001;
     dump_one_cpuid(output, regs, 0x1);
+    if (regs[2] & (1 << 22))
+      has_amd_topoext = 1;
   }
 
   /* 0x80000002-4 = Processor name string */
@@ -308,12 +388,18 @@ static int dump_one_proc(hwloc_topology_t topo, hwloc_obj_t pu, const char *path
   }
 
   /* 0x8000001e = Topoext on AMD ; Reserved on Intel */
-  if (highest_ext_cpuid >= 0x8000001e) {
+  if (has_amd_topoext && highest_ext_cpuid >= 0x8000001e) {
     regs[0] = 0x8000001e;
     dump_one_cpuid(output, regs, 0x1);
   }
 
-  if (highest_ext_cpuid > 0x8000001e) {
+  /* 0x8000001f = Encrypted Memory Capabilities ; Reserved on Intel */
+  if (highest_ext_cpuid >= 0x8000001f) {
+    regs[0] = 0x8000001f;
+    dump_one_cpuid(output, regs, 0x1);
+  }
+
+  if (highest_ext_cpuid > 0x8000001f) {
     static int reported = 0;
     if (!reported)
       fprintf(stderr, "WARNING: Processor supports new extended CPUID leaves upto 0x%x\n", highest_ext_cpuid);
diff --git a/src/hwloc/utils/hwloc/hwloc-gather-topology.1in b/src/hwloc/utils/hwloc/hwloc-gather-topology.1in
index 0c33e70..9cb729f 100644
--- a/src/hwloc/utils/hwloc/hwloc-gather-topology.1in
+++ b/src/hwloc/utils/hwloc/hwloc-gather-topology.1in
@@ -2,7 +2,7 @@
 .\" Copyright © 2010 Jirka Hladky
 .\" Copyright © 2010-2018 Inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-GATHER-TOPOLOGY "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-GATHER-TOPOLOGY "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-gather-topology \- Saves the relevant Linux topology files
 and the lstopo textual and XML outputs for later (possibly offline) usage
diff --git a/src/hwloc/utils/hwloc/hwloc-info.1in b/src/hwloc/utils/hwloc/hwloc-info.1in
index d35f9c4..414129b 100644
--- a/src/hwloc/utils/hwloc/hwloc-info.1in
+++ b/src/hwloc/utils/hwloc/hwloc-info.1in
@@ -3,7 +3,7 @@
 .\" Copyright © 2009-2010 Université of Bordeaux
 .\" Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-INFO "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-INFO "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-info \- Show some information about some objects or about a topology or about support features
 .
diff --git a/src/hwloc/utils/hwloc/hwloc-info.c b/src/hwloc/utils/hwloc/hwloc-info.c
index c0e3f41..f032acc 100644
--- a/src/hwloc/utils/hwloc/hwloc-info.c
+++ b/src/hwloc/utils/hwloc/hwloc-info.c
@@ -47,7 +47,7 @@ void usage(const char *name, FILE *where)
   fprintf (where, "  --restrict <cpuset>   Restrict the topology to processors listed in <cpuset>\n");
   fprintf (where, "  --restrict binding    Restrict the topology to the current process binding\n");
   fprintf (where, "  --filter <type>:<knd> Filter objects of the given type, or all.\n");
-  fprintf (where, "     <knd> may be `all' (keep all), `none' (remove all), `structure' or `basic'\n");
+  fprintf (where, "     <knd> may be `all' (keep all), `none' (remove all), `structure' or `important'\n");
   fprintf (where, "  --no-icaches          Do not show instruction caches\n");
   fprintf (where, "  --no-io               Do not show any I/O device or bridge\n");
   fprintf (where, "  --no-bridges          Do not any I/O bridge except hostbridges\n");
@@ -526,8 +526,8 @@ main (int argc, char *argv[])
   }
 
   if (pid_number > 0) {
-    pid = hwloc_pid_from_number(pid_number, 0);
-    if (hwloc_topology_set_pid(topology, pid)) {
+    if (hwloc_pid_from_number(&pid, pid_number, 0, 1 /* verbose */) < 0
+	|| hwloc_topology_set_pid(topology, pid)) {
       perror("Setting target pid");
       return EXIT_FAILURE;
     }
diff --git a/src/hwloc/utils/hwloc/hwloc-patch.1in b/src/hwloc/utils/hwloc/hwloc-patch.1in
index cf33db2..ca0c59f 100644
--- a/src/hwloc/utils/hwloc/hwloc-patch.1in
+++ b/src/hwloc/utils/hwloc/hwloc-patch.1in
@@ -1,7 +1,7 @@
 .\" -*- nroff -*-
 .\" Copyright © 2013-2016 Inria.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-PATCH "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-PATCH "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-patch \- Apply a topology difference to an existing XML topology
 .
diff --git a/src/hwloc/utils/hwloc/hwloc-ps.1in b/src/hwloc/utils/hwloc/hwloc-ps.1in
index 3d8eff2..d6037b7 100644
--- a/src/hwloc/utils/hwloc/hwloc-ps.1in
+++ b/src/hwloc/utils/hwloc/hwloc-ps.1in
@@ -2,7 +2,7 @@
 .\" Copyright © 2010-2017 Inria.  All rights reserved.
 .\" Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC-PS "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC-PS "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc-ps \- List currently-running processes or threads that are bound
 .
diff --git a/src/hwloc/utils/hwloc/hwloc.7in b/src/hwloc/utils/hwloc/hwloc.7in
index 7efd71a..d0ad70b 100644
--- a/src/hwloc/utils/hwloc/hwloc.7in
+++ b/src/hwloc/utils/hwloc/hwloc.7in
@@ -1,9 +1,9 @@
 .\" -*- nroff -*-
-.\" Copyright © 2010-2017 Inria.  All rights reserved.
+.\" Copyright © 2010-2018 Inria.  All rights reserved.
 .\" Copyright © 2010 Université of Bordeaux
 .\" Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH HWLOC "7" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH HWLOC "7" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 hwloc - General information about hwloc ("hardware locality").
 .
diff --git a/src/hwloc/utils/hwloc/misc.h b/src/hwloc/utils/hwloc/misc.h
index 448b460..31379e5 100644
--- a/src/hwloc/utils/hwloc/misc.h
+++ b/src/hwloc/utils/hwloc/misc.h
@@ -293,7 +293,7 @@ hwloc_utils_enable_input_format(struct hwloc_topology *topology,
 }
 
 static __hwloc_inline void
-hwloc_utils_print_distance_matrix(FILE *output, unsigned nbobjs, hwloc_obj_t *objs, uint64_t *matrix, int logical)
+hwloc_utils_print_distance_matrix(FILE *output, unsigned nbobjs, hwloc_obj_t *objs, hwloc_uint64_t *matrix, int logical)
 {
   unsigned i, j;
 
@@ -320,24 +320,27 @@ hwloc_utils_print_distance_matrix(FILE *output, unsigned nbobjs, hwloc_obj_t *ob
   }
 }
 
-static __hwloc_inline hwloc_pid_t
-hwloc_pid_from_number(int pid_number, int set_info __hwloc_attribute_unused)
+static __hwloc_inline int
+hwloc_pid_from_number(hwloc_pid_t *pidp, int pid_number, int set_info __hwloc_attribute_unused, int verbose __hwloc_attribute_unused)
 {
   hwloc_pid_t pid;
 #ifdef HWLOC_WIN_SYS
   pid = OpenProcess(set_info ? PROCESS_SET_INFORMATION : PROCESS_QUERY_INFORMATION, FALSE, pid_number);
   if (!pid) {
-    DWORD error = GetLastError();
-    char *message;
-    FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM,
-                  NULL, error, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), (char *)&message, 0, NULL);
-    fprintf(stderr, "OpenProcess %d failed %lu: %s\n", pid_number, (unsigned long) error, message);
-    exit(EXIT_FAILURE);
+    if (verbose) {
+      DWORD error = GetLastError();
+      char *message;
+      FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM,
+		    NULL, error, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), (char *)&message, 0, NULL);
+      fprintf(stderr, "OpenProcess %d failed %lu: %s\n", pid_number, (unsigned long) error, message);
+    }
+    return -1;
   }
 #else
   pid = pid_number;
 #endif
-  return pid;
+  *pidp = pid;
+  return 0;
 }
 
 static __hwloc_inline void
diff --git a/src/hwloc/utils/hwloc/test-hwloc-annotate.sh.in b/src/hwloc/utils/hwloc/test-hwloc-annotate.sh.in
index eaf0893..be72109 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-annotate.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-annotate.sh.in
@@ -68,5 +68,5 @@ pu:1
 EOF
 $annotate $file $file dummy distances $distances
 
-diff @HWLOC_DIFF_U@ $srcdir/test-hwloc-annotate.output "$file"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-hwloc-annotate.output "$file"
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/hwloc/test-hwloc-calc.sh.in b/src/hwloc/utils/hwloc/test-hwloc-calc.sh.in
index 3d604d9..3f31f7b 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-calc.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-calc.sh.in
@@ -103,5 +103,5 @@ node:0 node:3
 root
 EOF
 ) > "$file"
-diff @HWLOC_DIFF_U@ $srcdir/test-hwloc-calc.output "$file"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-hwloc-calc.output "$file"
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/hwloc/test-hwloc-compress-dir.sh.in b/src/hwloc/utils/hwloc/test-hwloc-compress-dir.sh.in
index b50fa79..b3cda16 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-compress-dir.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-compress-dir.sh.in
@@ -2,7 +2,7 @@
 #-*-sh-*-
 
 #
-# Copyright © 2013 Inria.  All rights reserved.
+# Copyright © 2013-2018 Inria.  All rights reserved.
 # Copyright © 2014 Cisco Systems, Inc.  All rights reserved.
 # See COPYING in top-level directory.
 #
@@ -46,10 +46,10 @@ set -e
 
 $compress "$tmp/test-hwloc-compress-dir.input" "$tmp/test-hwloc-compress-dir.newoutput"
 
-diff @HWLOC_DIFF_U@ -r "$tmp/test-hwloc-compress-dir.output" "$tmp/test-hwloc-compress-dir.newoutput"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ -r "$tmp/test-hwloc-compress-dir.output" "$tmp/test-hwloc-compress-dir.newoutput"
 
 $compress -R "$tmp/test-hwloc-compress-dir.newoutput" "$tmp/test-hwloc-compress-dir.newoutput2"
 
-diff @HWLOC_DIFF_U@ -r "$tmp/test-hwloc-compress-dir.input" "$tmp/test-hwloc-compress-dir.newoutput2"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ -r "$tmp/test-hwloc-compress-dir.input" "$tmp/test-hwloc-compress-dir.newoutput2"
 
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/hwloc/test-hwloc-diffpatch.sh.in b/src/hwloc/utils/hwloc/test-hwloc-diffpatch.sh.in
index efc8daf..5a7e5e6 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-diffpatch.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-diffpatch.sh.in
@@ -2,7 +2,7 @@
 #-*-sh-*-
 
 #
-# Copyright © 2009-2013 Inria.  All rights reserved.
+# Copyright © 2009-2018 Inria.  All rights reserved.
 # Copyright © 2014 Cisco Systems, Inc.  All rights reserved.
 # See COPYING in top-level directory.
 #
@@ -52,8 +52,8 @@ cp $srcdir/test-hwloc-diffpatch.input1 .
 cat $diffoutput | $patch refname - $output1
 $patch -R $srcdir/test-hwloc-diffpatch.input2 $diffoutput $output2
 
-diff -u $srcdir/test-hwloc-diffpatch.input1 "$output2"
-diff -u $srcdir/test-hwloc-diffpatch.input2 "$output1"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-hwloc-diffpatch.input1 "$output2"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-hwloc-diffpatch.input2 "$output1"
 
 cd ..
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/hwloc/test-hwloc-distrib.sh.in b/src/hwloc/utils/hwloc/test-hwloc-distrib.sh.in
index 67ffc1b..b6e5a4a 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-distrib.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-distrib.sh.in
@@ -3,7 +3,7 @@
 
 #
 # Copyright © 2009 CNRS
-# Copyright © 2009-2017 Inria.  All rights reserved.
+# Copyright © 2009-2018 Inria.  All rights reserved.
 # Copyright © 2009 Université Bordeaux
 # Copyright © 2014 Cisco Systems, Inc.  All rights reserved.
 # See COPYING in top-level directory.
@@ -69,5 +69,5 @@ set -e
   $distrib --if synthetic --input "2 2 2 2" --to core 9
   echo
 ) > "$file"
-diff @HWLOC_DIFF_U@ $srcdir/test-hwloc-distrib.output "$file"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-hwloc-distrib.output "$file"
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/hwloc/test-hwloc-dump-hwdata/test-hwloc-dump-hwdata.sh.in b/src/hwloc/utils/hwloc/test-hwloc-dump-hwdata/test-hwloc-dump-hwdata.sh.in
index 0654f6b..bf34a5f 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-dump-hwdata/test-hwloc-dump-hwdata.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-dump-hwdata/test-hwloc-dump-hwdata.sh.in
@@ -2,7 +2,7 @@
 #-*-sh-*-
 
 #
-# Copyright © 2015-2016 Inria.  All rights reserved.
+# Copyright © 2015-2018 Inria.  All rights reserved.
 # See COPYING in top-level directory.
 #
 
@@ -33,6 +33,6 @@ export HWLOC_FSROOT
 
 $hdhd -o $tmp/output
 
-diff @HWLOC_DIFF_U@ -r "$HWLOC_FSROOT/expected_output" "$tmp/output"
+@DIFF@ @HWLOC_DIFF_U@ -r "$HWLOC_FSROOT/expected_output" "$tmp/output"
 
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/hwloc/test-hwloc-info.sh.in b/src/hwloc/utils/hwloc/test-hwloc-info.sh.in
index 298f8cf..b5a3ff1 100644
--- a/src/hwloc/utils/hwloc/test-hwloc-info.sh.in
+++ b/src/hwloc/utils/hwloc/test-hwloc-info.sh.in
@@ -64,5 +64,5 @@ set -e
  > "$file"
 # filtered hwlocVersion since it often changes
 # filtered ProcessName since it may be hwloc-info or lt-hwloc-info
-diff @HWLOC_DIFF_U@ $srcdir/test-hwloc-info.output "$file"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-hwloc-info.output "$file"
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/lstopo/Makefile.am b/src/hwloc/utils/lstopo/Makefile.am
index 8b34e64..fc6a9a9 100644
--- a/src/hwloc/utils/lstopo/Makefile.am
+++ b/src/hwloc/utils/lstopo/Makefile.am
@@ -71,9 +71,9 @@ APPLICATIONSdir = @datarootdir@/applications
 dist_APPLICATIONS_DATA = lstopo.desktop
 endif
 
-SEDMAN = $(SED) -e 's/\#PACKAGE_NAME\#/@PACKAGE_NAME@/g' \
-	  -e 's/\#PACKAGE_VERSION\#/@PACKAGE_VERSION@/g' \
-	  -e 's/\#HWLOC_DATE\#/@HWLOC_RELEASE_DATE@/g'
+SEDMAN = $(SED) -e 's/%PACKAGE_NAME%/@PACKAGE_NAME@/g' \
+	  -e 's/%PACKAGE_VERSION%/@PACKAGE_VERSION@/g' \
+	  -e 's/%HWLOC_DATE%/@HWLOC_RELEASE_DATE@/g'
 
 .1in.1:
 	@ echo Creating $@ man page...
diff --git a/src/hwloc/utils/lstopo/lstopo-draw.c b/src/hwloc/utils/lstopo/lstopo-draw.c
index b35ccd9..06f1cf4 100644
--- a/src/hwloc/utils/lstopo/lstopo-draw.c
+++ b/src/hwloc/utils/lstopo/lstopo-draw.c
@@ -363,9 +363,8 @@ place_children(struct lstopo_output *loutput, hwloc_obj_t parent,
     return;
 
 
-  /* no separator between core or L1 children */
-  if (parent->type == HWLOC_OBJ_CORE
-      || (hwloc_obj_type_is_cache(parent->type) && parent->attr->cache.depth == 1))
+  /* no separator between PUs */
+  if ((unsigned)parent->depth == loutput->depth-2)
     separator = 0;
 
   /* place non-memory children */
@@ -559,7 +558,11 @@ lstopo__prepare_custom_styles(struct lstopo_output *loutput, hwloc_obj_t obj)
 	s->bg.b = forceb & 255;
 	lud->style_set |= LSTOPO_STYLE_BG;
 	loutput->methods->declare_color(loutput, &s->bg);
-	s->t.r = s->t.g = s->t.b = (s->bg.r + s->bg.g + s->bg.b < 0xff) ? 0xff : 0;
+	/* if there's no style for text, make sure it's not dark over dark bg */
+	if (!(lud->style_set & LSTOPO_STYLE_T)) {
+	  s->t.r = s->t.g = s->t.b = (s->bg.r + s->bg.g + s->bg.b < 0xff) ? 0xff : 0;
+	  lud->style_set |= LSTOPO_STYLE_T;
+	}
       } else if (sscanf(stylestr, "Text=#%02x%02x%02x", &forcer, &forceg, &forceb) == 3) {
 	s->t.r = forcer & 255;
 	s->t.g = forceg & 255;
@@ -1097,7 +1100,7 @@ output_draw(struct lstopo_output *loutput)
   time_t t;
   char text[3][128];
   unsigned ntext = 0;
-  char hostname[128] = "";
+  char hostname[122] = "";
   const char *forcedhostname = NULL;
   unsigned long hostname_size = sizeof(hostname);
   unsigned maxtextwidth = 0, textwidth;
diff --git a/src/hwloc/utils/lstopo/lstopo-no-graphics.1in b/src/hwloc/utils/lstopo/lstopo-no-graphics.1in
index 4d5c704..e186ea4 100644
--- a/src/hwloc/utils/lstopo/lstopo-no-graphics.1in
+++ b/src/hwloc/utils/lstopo/lstopo-no-graphics.1in
@@ -3,7 +3,7 @@
 .\" Copyright © 2009-2010 Université of Bordeaux
 .\" Copyright © 2009-2010 Cisco Systems, Inc.  All rights reserved.
 .\" See COPYING in top-level directory.
-.TH LSTOPO "1" "#HWLOC_DATE#" "#PACKAGE_VERSION#" "#PACKAGE_NAME#"
+.TH LSTOPO "1" "%HWLOC_DATE%" "%PACKAGE_VERSION%" "%PACKAGE_NAME%"
 .SH NAME
 lstopo, lstopo-no-graphics, hwloc-ls \- Show the topology of the system
 .
@@ -61,7 +61,7 @@ The <specification> string must end with a number of PUs.
 Enforce the input in the given format, among \fBxml\fR, \fBfsroot\fR,
 \fBcpuid\fR and \fBsynthetic\fR.
 .TP
-\fB\-\-export\-synthetic\-flags\fR <flags>
+\fB\-\-export\-xml\-flags\fR <flags>
 Enforce flags when exporting to the XML format.
 These flags are passed to \fIhwloc_topology_export_xml()\fR.
 A value of 1 reverts to the format of hwloc v1.x.
@@ -214,7 +214,7 @@ machine are shown.  On Linux, kernel threads are not shown.
 If many processes appear, the output may become hard to read anyway,
 making the hwloc-ps program more practical.
 .TP
-\fB\-\-children\-order=<order>\fR
+\fB\-\-children\-order <order>\fR
 Change the order of the different kinds of children with respect to
 their parent in the graphical output.
 
@@ -237,54 +237,51 @@ Set size of margin between elements.
 .TP
 \fB\-\-horiz\fR, \fB\-\-horiz\fR=<type1,...>
 Horizontal graphical layout instead of nearly 4/3 ratio.
-If a comma-separated list of types is given, the layout only
-applies to the corresponding containers.
+If a comma-separated list of object types is given, the layout only
+applies to the corresponding container objects.
 Ignored for bridges since their children are always vertically aligned.
 .TP
 \fB\-\-vert\fR, \fB\-\-vert\fR=<type1,...>
 Vertical graphical layout instead of nearly 4/3 ratio.
-If a comma-separated list of types is given, the layout only
-applies to the corresponding containers.
+If a comma-separated list of object types is given, the layout only
+applies to the corresponding container objects.
 .TP
 \fB\-\-rect\fR, \fB\-\-rect\fR=<type1,...>
 Rectangular graphical layout with nearly 4/3 ratio.
-If a comma-separated list of types is given, the layout only
-applies to the corresponding containers.
+If a comma-separated list of object types is given, the layout only
+applies to the corresponding container objects.
 Ignored for bridges since their children are always vertically aligned.
 .TP
 \fB\-\-no\-text\fR, \fB\-\-no\-text=<type1,...>\fR
 Do not display any text in boxes in the graphical output.
-If a comma-separated list of types is given, indexes are only
-disabled for the given objects.
+If a comma-separated list of object types is given, text is disabled for the corresponding objects.
 This is mostly useful for removing text from Group objects.
 This feature is currently ignored for Bridges and PCI Devices.
 .TP
-\fB\-\-index\fR, \fB\-\-index=<type1,...>\fR
+\fB\-\-text\fR, \fB\-\-text=<type1,...>\fR
 Display text in boxes in the graphical output (default).
-If a comma-separated list of types is given, indexes are only
-enabled for the given objects.
+If a comma-separated list of object types is given, text is reenabled for the corresponding objects
+(if it was previously disabled with \fB\-\-no\-text\fR).
 .TP
 \fB\-\-no\-index\fR, \fB\-\-no\-index=<type1,...>\fR
 Do not show object indexes in the graphical output.
-If a comma-separated list of types is given, indexes are only
-disabled for the given objects.
+If a comma-separated list of object types is given, indexes are disabled for the corresponding objects.
 .TP
 \fB\-\-index\fR, \fB\-\-index=<type1,...>\fR
 Show object indexes in the graphical output (default).
-If a comma-separated list of types is given, indexes are only
-enabled for the given objects.
+If a comma-separated list of object types is given, indexes are reenabled for the corresponding objects
+(if they were previously disabled with \fB\-\-no\-index\fR).
 .TP
 \fB\-\-no\-attrs\fR, \fB\-\-no\-attrs=<type1,...>\fR
 Do not show object attributes (such as memory size, cache size, PCI bus ID, PCI link speed, etc.)
 in the graphical output.
-If a comma-separated list of types is given, attributes are only
-disabled for the given objects.
+If a comma-separated list of object types is given, attributes are disabled for the corresponding objects.
 .TP
 \fB\-\-attrs\fR, \fB\-\-attrs=<type1,...>\fR
 Show object attributes (such as memory size, cache size, PCI bus ID, PCI link speed, etc.)
 in the graphical output (default).
-If a comma-separated list of types is given, attributes are only
-enabled for the given objects.
+If a comma-separated list of object types is given, attributes are reenabled for the corresponding objects
+(if they were previously disabled with \fB\-\-no\-attrs\fR).
 .TP
 \fB\-\-no\-legend\fR
 Remove the text legend at the bottom.
diff --git a/src/hwloc/utils/lstopo/lstopo-windows.c b/src/hwloc/utils/lstopo/lstopo-windows.c
index 8a51dc5..09b406d 100644
--- a/src/hwloc/utils/lstopo/lstopo-windows.c
+++ b/src/hwloc/utils/lstopo/lstopo-windows.c
@@ -1,6 +1,6 @@
 /*
  * Copyright © 2009 CNRS
- * Copyright © 2009-2017 Inria.  All rights reserved.
+ * Copyright © 2009-2018 Inria.  All rights reserved.
  * Copyright © 2009-2010, 2012 Université Bordeaux
  * Copyright © 2011 Cisco Systems, Inc.  All rights reserved.
  * See COPYING in top-level directory.
@@ -394,6 +394,7 @@ output_windows (struct lstopo_output *loutput, const char *dummy __hwloc_attribu
   printf(" Scroll to the bottom-right corner . End\n");
   printf(" Exit .............................. q Q Esc\n");
   printf("\n\n");
+  fflush(stdout);
 
   /* ready */
   declare_colors(loutput);
diff --git a/src/hwloc/utils/lstopo/lstopo.c b/src/hwloc/utils/lstopo/lstopo.c
index 83cae53..4b4bf6d 100644
--- a/src/hwloc/utils/lstopo/lstopo.c
+++ b/src/hwloc/utils/lstopo/lstopo.c
@@ -44,6 +44,12 @@
 # endif
 #endif
 
+#ifdef HAVE_CLOCK_GETTIME
+# ifndef CLOCK_MONOTONIC /* HP-UX doesn't have CLOCK_MONOTONIC */
+#  define CLOCK_MONOTONIC CLOCK_REALTIME
+# endif
+#endif
+
 static unsigned int top = 0;
 
 FILE *open_output(const char *filename, int overwrite)
@@ -138,7 +144,8 @@ static void add_process_objects(hwloc_topology_t topology)
 
     snprintf(name, sizeof(name), "%ld", local_pid_number);
 
-    local_pid = hwloc_pid_from_number(local_pid_number, 0);
+    if (hwloc_pid_from_number(&local_pid, local_pid_number, 0, 0 /* ignore failures */) < 0)
+      continue;
 
     proc_cpubind = hwloc_get_proc_cpubind(topology, local_pid, cpuset, 0) != -1;
 
@@ -468,7 +475,7 @@ void usage(const char *name, FILE *where)
   fprintf (where, "  --taskset             Show taskset-specific cpuset strings\n");
   fprintf (where, "Object filtering options:\n");
   fprintf (where, "  --filter <type>:<knd> Filter objects of the given type, or all.\n");
-  fprintf (where, "     <knd> may be `all' (keep all), `none' (remove all), `structure' or `basic'\n");
+  fprintf (where, "     <knd> may be `all' (keep all), `none' (remove all), `structure' or `important'\n");
   fprintf (where, "  --ignore <type>       Ignore objects of the given type\n");
   fprintf (where, "  --no-caches           Do not show caches\n");
   fprintf (where, "  --no-useless-caches   Do not show caches which do not have a hierarchical\n"
@@ -490,7 +497,7 @@ void usage(const char *name, FILE *where)
   fprintf (where, "  --pid <pid>           Detect topology as seen by process <pid>\n");
   fprintf (where, "  --whole-system        Do not consider administration limitations\n");
   fprintf (where, "Graphical output options:\n");
-  fprintf (where, "  --children-order=plain\n"
+  fprintf (where, "  --children-order plain\n"
 		  "                        Display memory children below the parent like any other child\n");
   fprintf (where, "  --fontsize 10         Set size of text font\n");
   fprintf (where, "  --gridsize 10         Set size of margin between elements\n");
@@ -897,13 +904,14 @@ main (int argc, char *argv[])
 	}
       }
 
-      else if (!strncmp (argv[0], "--children-order=", 18)) {
-	char *tmp = argv[0]+18;
-	argv[0][17] = '\0';
-	if (!strcmp(tmp, "plain"))
+      else if (!strcmp (argv[0], "--children-order")) {
+	if (argc < 2)
+	  goto out_usagefailure;
+	if (!strcmp(argv[1], "plain"))
 	  loutput.plain_children_order = 1;
-	else if (strcmp(tmp, "memoryabove"))
-	  fprintf(stderr, "Unsupported order `%s' passed to %s, ignoring.\n", tmp, argv[0]);
+	else if (strcmp(argv[1], "memoryabove"))
+	  fprintf(stderr, "Unsupported order `%s' passed to %s, ignoring.\n", argv[1], argv[0]);
+	opt = 1;
       }
       else if (!strcmp (argv[0], "--fontsize")) {
 	if (argc < 2)
@@ -987,8 +995,8 @@ main (int argc, char *argv[])
   }
 
   if (loutput.pid_number > 0) {
-    loutput.pid = hwloc_pid_from_number(loutput.pid_number, 0);
-    if (hwloc_topology_set_pid(topology, loutput.pid)) {
+    if (hwloc_pid_from_number(&loutput.pid, loutput.pid_number, 0, 1 /* verbose */) < 0
+	|| hwloc_topology_set_pid(topology, loutput.pid)) {
       perror("Setting target pid");
       goto out_with_topology;
     }
@@ -1143,6 +1151,7 @@ main (int argc, char *argv[])
   }
 
   loutput.topology = topology;
+  loutput.depth = hwloc_topology_get_depth(topology);
   loutput.file = NULL;
 
   lstopo_populate_userdata(hwloc_get_root_obj(topology));
diff --git a/src/hwloc/utils/lstopo/lstopo.h b/src/hwloc/utils/lstopo/lstopo.h
index e491874..c2aa125 100644
--- a/src/hwloc/utils/lstopo/lstopo.h
+++ b/src/hwloc/utils/lstopo/lstopo.h
@@ -32,6 +32,7 @@ struct draw_methods;
 /* if embedded in backend-specific output structure, must be at the beginning */
 struct lstopo_output {
   hwloc_topology_t topology;
+  unsigned depth;
 
   /* file config */
   FILE *file;
diff --git a/src/hwloc/utils/lstopo/test-lstopo.sh.in b/src/hwloc/utils/lstopo/test-lstopo.sh.in
index deff4ef..7530ad7 100644
--- a/src/hwloc/utils/lstopo/test-lstopo.sh.in
+++ b/src/hwloc/utils/lstopo/test-lstopo.sh.in
@@ -60,5 +60,5 @@ $ls
   $ls --export-xml-flags 1 -f $tmp/test.v1.xml
   $ls --input "pa:1 no:2 co:1 l2:2 2" $tmp/test.synthetic
 ) > "$file"
-diff @HWLOC_DIFF_U@ $srcdir/test-lstopo.output "$file"
+@DIFF@ @HWLOC_DIFF_U@ @HWLOC_DIFF_W@ $srcdir/test-lstopo.output "$file"
 rm -rf "$tmp"
diff --git a/src/hwloc/utils/netloc/infiniband/netloc_ib_extract_dats.c b/src/hwloc/utils/netloc/infiniband/netloc_ib_extract_dats.c
index 4620070..6f612d8 100644
--- a/src/hwloc/utils/netloc/infiniband/netloc_ib_extract_dats.c
+++ b/src/hwloc/utils/netloc/infiniband/netloc_ib_extract_dats.c
@@ -1,5 +1,5 @@
 /*
- * Copyright © 2016 Inria.  All rights reserved.
+ * Copyright © 2016-2018 Inria.  All rights reserved.
  *
  * $COPYRIGHT$
  *
@@ -13,7 +13,9 @@
 #include <stdio.h>
 #include <assert.h>
 #include <stdlib.h>
+#ifdef HAVE_UNISTD_H
 #include <unistd.h>
+#endif
 #include <private/netloc.h>
 #include <netloc/uthash.h>
 #include <netloc/utarray.h>
